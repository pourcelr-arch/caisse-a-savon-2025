<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application gestion course de caisses √† savon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .text-red-500 {
            color: #ef4444;
        }
        #benevoles-table, #concurrents-table, #concurrents-admin-table, #access-table, #race-table {
            table-layout: auto;
            width: max-content;
            min-width: 100%;
        }
        th, td {
            white-space: nowrap;
            padding: 8px 12px;
        }
        input, select {
            background-color: transparent;
            border: none;
            outline: none;
        }
        input:disabled, select:disabled {
            color: #6b7280;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
        }
        /* Styles pour la modale et l'√©cran de connexion */
        .modal, #login-screen, #starting-grid-screen, #display-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; /* Chang√© pour flex par d√©faut */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content, .login-content, .starting-grid-content, .display-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
        }
        @media (min-width: 768px) {
            .modal-content, .login-content, .starting-grid-content, .display-content {
                padding: 2rem;
            }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .modal-header h2 {
            font-size: 1.25rem;
        }
         @media (min-width: 768px) {
            .modal-header h2 {
                font-size: 1.5rem;
            }
        }
        .modal-close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        #save-message, #save-concurrents-message, #save-access-message {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #save-message.show, #save-concurrents-message.show, #save-access-message.show {
            opacity: 1;
        }
        /* Styles pour les onglets */
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .admin-sub-tab-button.active {
            border-bottom-color: #dc2626; /* red-600 */
            color: #dc2626;
            font-weight: 600;
        }
        #chrono-display {
            font-family: 'monospace';
            letter-spacing: 2px;
        }
        /* Style pour les boutons d√©sactiv√©s */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Style for control select */
        select.controle-conforme { background-color: #dcfce7; color: #166534; }
        select.controle-nonconforme { background-color: #fee2e2; color: #991b1b; }
        select.controle-√†v√©rifier { background-color: #fef9c3; color: #854d0e; font-weight: bold; }
        input.paiement-input { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.25rem 0.5rem; width: 60px; }
        input:disabled.paiement-input { background-color: #f3f4f6; }
        .time-input {
            border: 1px solid transparent;
            border-radius: 0.25rem;
            padding: 0.25rem;
            width: 70px;
        }
        .time-input:enabled:hover, .time-input:enabled:focus {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* Styles pour les colonnes fixes (sticky) du tableau de course */
        #race-table th:nth-child(1), #race-table td:nth-child(1),
        #race-table th:nth-child(2), #race-table td:nth-child(2) {
            position: -webkit-sticky; /* Pour Safari */
            position: sticky;
            z-index: 10;
        }

        #race-table th:nth-child(1), #race-table td:nth-child(1) { left: 0; }
        #race-table th:nth-child(2), #race-table td:nth-child(2) { left: 50px; }

        #race-table thead th:nth-child(1),
        #race-table thead th:nth-child(2) {
            background-color: #e5e7eb; /* Corresponds to bg-gray-200 */
        }

        #race-table tbody td:nth-child(1),
        #race-table tbody td:nth-child(2) {
            background-color: #ffffff; /* Corresponds to bg-white */
        }

        #race-table th:nth-child(2),
        #race-table td:nth-child(2) {
            border-right: 2px solid #d1d5db; /* Corresponds to border-gray-300 */
        }

        #race-table th:nth-child(1), #race-table td:nth-child(1) { width: 50px; }
        #race-table th:nth-child(2), #race-table td:nth-child(2) { width: 200px; }

        /* Styles pour le tableau de bord concurrent */
        .competitor-card {
             background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
         @media (min-width: 768px) {
            .competitor-card {
                padding: 2rem;
            }
        }
        /* Bouton d'urgence */
        #emergency-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        /* Alerte Urgence */
        #emergency-alert {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(220, 38, 38, 0.8); /* red-600 with opacity */
            z-index: 2000;
            display: none; /* Initially hidden */
            animation: flash 1s infinite;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        @keyframes flash {
            0%, 100% { background-color: rgba(220, 38, 38, 0.8); }
            50% { background-color: rgba(185, 28, 28, 0.9); }
        }
        .modal-content.modal-content-emergency {
            border: 4px solid #ef4444; /* red-500 */
            background-color: #fee2e2; /* red-100 */
        }
        .modal-content.modal-content-emergency .modal-header h2 {
            color: #b91c1c; /* red-700 */
            font-size: 1.5rem;
            font-weight: 800;
        }
        .modal-content.modal-content-emergency #confirm-modal-confirm-btn {
            background-color: #dc2626; /* red-600 */
            transform: scale(1.05);
            font-weight: 700;
        }
        .modal-content.modal-content-emergency #confirm-modal-confirm-btn:hover {
            background-color: #b91c1c; /* red-700 */
        }
    </style>
</head>
<body class="p-2 sm:p-6">
    
    <!-- BOUTON D'URGENCE -->
    <button id="emergency-btn" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-4 px-4 rounded-full shadow-lg transition duration-200 animate-pulse">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24">
            <!-- Static Light Rays (White) -->
            <path d="M12 2V5" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M5.6 5.6L7.7 7.7" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M18.4 5.6L16.3 7.7" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M2 12H5" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M22 12H19" stroke="white" stroke-width="2" stroke-linecap="round"/>
        
            <!-- Main Beacon Body (Red) -->
            <path fill="#dc2626" d="M3 17h18v4H3z" />
            <!-- Light Cover (Lighter Red) -->
            <path fill="#ef4444" d="M5 9c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v8H5V9z" />
            <!-- Glint (Almost White) -->
            <path fill="#fca5a5" d="M7 11h10v2H7z" />
        </svg>
    </button>

    <!-- ALERTE URGENCE -->
    <div id="emergency-alert">
        <div class="text-center text-white">
            <h1 class="text-6xl md:text-9xl font-bold mb-4">URGENCE</h1>
            <p id="emergency-message" class="text-xl md:text-3xl mb-8">Un incident a √©t√© signal√©.</p>
            <button id="stop-emergency-btn" class="bg-white text-red-600 font-bold py-3 px-8 rounded-xl text-lg hover:bg-gray-200">Arr√™ter l'Alerte</button>
        </div>
    </div>


    <!-- √âCRAN DE CONNEXION -->
    <div id="login-screen">
        <div id="critical-error-display" class="login-content text-left max-w-lg" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 text-red-600">Erreur de Configuration Critique</h2>
            <div id="critical-error-message" class="space-y-3"></div>
        </div>
        <div id="login-form-container" class="login-content text-center max-w-md">
            <h2 class="text-2xl font-bold mb-4">Acc√®s au tableau de bord</h2>
            <p class="text-gray-600 mb-6">Veuillez vous identifier pour continuer.</p>
            <form id="login-form" class="space-y-4">
                <div><input type="text" id="login-nom" placeholder="Votre Nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><input type="text" id="login-prenom" placeholder="Votre Pr√©nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><input type="tel" id="login-tel" placeholder="Votre Num√©ro de t√©l√©phone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <p id="login-error" class="text-red-500 text-sm hidden text-left bg-red-50 p-3 rounded-lg border border-red-200">
                    <strong>Informations incorrectes.</strong><br>
                    Veuillez v√©rifier les points suivants :<br>
                    <ul class="list-disc list-inside mt-1">
                        <li>Le <strong>Nom</strong> doit √™tre en MAJUSCULES.</li>
                        <li>Le <strong>Pr√©nom</strong> doit commencer par une majuscule.</li>
                        <li>Le <strong>T√©l√©phone</strong> ne doit contenir que des chiffres, sans espaces.</li>
                    </ul>
                </p>
                <div class="flex justify-center pt-4"><button type="submit" id="login-submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200" disabled>Chargement des donn√©es...</button></div>
            </form>
        </div>
    </div>

    <!-- √âCRAN GRILLE DE D√âPART -->
    <div id="starting-grid-screen" style="display: none;">
        <div class="starting-grid-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="grid-title" class="text-2xl font-bold text-gray-800">Grille de D√©part</h2>
                <button id="close-grid-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="overflow-y-auto max-h-[80vh]">
                <table class="min-w-full divide-y divide-gray-200" id="grid-table">
                    <thead class="bg-gray-200 sticky top-0">
                        <!-- Headers de la grille g√©n√©r√©s par JS -->
                    </thead>
                    <tbody id="grid-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- √âCRAN D'AFFICHAGE PUBLIC -->
    <div id="display-screen" style="display: none;">
        <div class="display-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="display-title" class="text-2xl font-bold text-gray-800">Affichage</h2>
                <button id="close-display-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="display-table-container" class="overflow-y-auto max-h-[80vh]">
                <!-- Contenu de l'affichage g√©n√©r√© par JS -->
            </div>
        </div>
    </div>


    <!-- APPLICATION PRINCIPALE -->
    <div id="main-app" class="max-w-7xl mx-auto" style="display: none;">
        <div class="bg-white shadow-xl rounded-2xl p-4 md:p-6 mb-4">
             <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Tableau de bord - Caisse √† Savon</h1>
                    <p class="text-gray-400 text-xs sm:text-sm">Connect√© en tant que: <span id="user-info" class="font-semibold"></span></p>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <input type="file" id="import-file" class="hidden" accept=".json">
                    <button id="import-btn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200">Importer</button>
                    <button id="export-btn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200">Exporter</button>
                    <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200">D√©connexion</button>
                </div>
            </div>
        </div>
        
        <div class="mb-4 border-b border-gray-200">
            <nav class="flex space-x-2 sm:space-x-4 overflow-x-auto pb-1" aria-label="Tabs">
                <button id="tab-race" class="tab-button active py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Chrono
                    </span>
                </button>
                <button id="tab-radar" class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Radar
                    </span>
                </button>
                <button id="tab-podium" class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M11.293 2.293a1 1 0 011.414 0l.043.043c.293.293.385.737.228 1.114A10.06 10.06 0 0110 5c-1.393 0-2.69.403-3.768 1.114a.999.999 0 01.228-1.114l.043-.043a1 1 0 011.414 0L10 4.414l1.293-1.293zM5 10a5 5 0 1110 0 5 5 0 01-10 0zM10 18a8 8 0 100-16 8 8 0 000 16z" clip-rule="evenodd" />
                        </svg>
                        Podium
                    </span>
                </button>
                 <button id="tab-display" class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    <span class="flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        Affichage
                    </span>
                </button>
                <button id="tab-concurrents" class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        Concurrents
                    </span>
                </button>
                <button id="tab-dashboard" class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    <span class="flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                          </svg>
                         B√©n√©voles & Mat√©riel
                    </span>
                </button>
                <button id="tab-admin" class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-red-600 whitespace-nowrap" style="display: none;">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Administration
                    </span>
                </button>
            </nav>
        </div>
        
        <div id="content-race" class="tab-content">
             <!-- Le contenu de l'onglet Course sera inject√© ici par JS -->
        </div>

        <div id="content-radar" class="tab-content" style="display: none;">
            <!-- Le contenu de l'onglet Radar sera inject√© ici par JS -->
       </div>

        <div id="content-podium" class="tab-content" style="display: none;">
            <!-- Le contenu de l'onglet Podium sera inject√© ici par JS -->
        </div>
        
        <div id="content-display" class="tab-content" style="display: none;">
            <!-- Le contenu de l'onglet Affichage sera inject√© ici par JS -->
        </div>

        <div id="content-concurrents" class="tab-content" style="display: none;">
             <!-- Le contenu de l'onglet Concurrents sera inject√© ici par JS -->
        </div>
        
        <div id="content-dashboard" class="tab-content" style="display: none;">
             <!-- Le contenu de l'onglet B√©n√©voles sera inject√© ici par JS -->
        </div>

        <div id="content-admin" class="tab-content" style="display: none;">
             <!-- Le contenu de l'onglet Administration sera inject√© ici par JS -->
        </div>
        
    </div>

    <!-- VUE DU TABLEAU DE BORD CONCURRENT -->
    <div id="competitor-dashboard-view" class="max-w-7xl mx-auto" style="display: none;">
        <div class="bg-white shadow-xl rounded-2xl p-4 md:p-6 mb-4 flex justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Ma Fiche Concurrent</h1>
            <button id="competitor-logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200">D√©connexion</button>
        </div>
        
        <div class="space-y-6">
            <div class="competitor-card text-center">
                <h2 class="text-xl font-semibold text-gray-500">Bienvenue</h2>
                <p id="competitor-dashboard-name" class="text-4xl font-bold text-blue-600"></p>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <div class="competitor-card text-center">
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Meilleur Temps</h3>
                    <p id="competitor-dashboard-best-time" class="text-5xl font-bold font-mono text-gray-800">-</p>
                </div>
                <div class="competitor-card text-center">
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Classement G√©n√©ral</h3>
                    <p id="competitor-dashboard-rank" class="text-5xl font-bold text-gray-800">-</p>
                </div>
                <div class="competitor-card text-center">
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">√âcart avec le 1er</h3>
                    <p id="competitor-dashboard-gap" class="text-5xl font-bold font-mono text-red-500">-</p>
                </div>
            </div>

            <div class="competitor-card">
                 <h3 class="text-xl font-semibold text-gray-800 mb-4">Ma Position en Course</h3>
                 <div class="overflow-x-auto">
                     <table class="w-full">
                         <thead>
                             <tr class="border-b-2 border-gray-200">
                                 <th class="p-3 text-left text-xs font-bold uppercase">Classement</th>
                                 <th class="p-3 text-left text-xs font-bold uppercase">Concurrent</th>
                                 <th class="p-3 text-left text-xs font-bold uppercase">Meilleur Temps</th>
                             </tr>
                         </thead>
                         <tbody id="competitor-dashboard-focused-ranking">
                             <!-- Le classement cibl√© sera inject√© ici -->
                         </tbody>
                     </table>
                 </div>
            </div>

            <div class="competitor-card">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">D√©tail de mes Descentes</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                         <thead>
                             <tr class="border-b-2 border-gray-200" id="competitor-dashboard-times-head">
                                <!-- Les ent√™tes de manches seront inject√©es ici -->
                             </tr>
                         </thead>
                         <tbody id="competitor-dashboard-times-body">
                             <!-- Mes temps par manche seront inject√©s ici -->
                         </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal pour ajouter/modifier un b√©n√©vole -->
    <div id="add-benevole-modal" class="modal" style="display:none">
        <!-- Le contenu de la modale sera inject√© ici par JS -->
    </div>

    <!-- Modal pour ajouter/modifier un concurrent -->
    <div id="add-concurrent-modal" class="modal" style="display:none">
        <!-- Le contenu de la modale sera inject√© ici par JS -->
    </div>
    
    <!-- Modal for Race Time Confirmation -->
    <div id="time-confirmation-modal" class="modal" style="display:none">
        <div class="modal-content max-w-lg text-center bg-gray-900 text-white rounded-2xl shadow-2xl p-6">
            <div id="new-record-banner" class="hidden text-2xl font-bold text-yellow-300 p-2 mb-4 border-2 border-yellow-300 rounded-lg">
                üéâ NOUVEAU RECORD DE LA PISTE ! üéâ
            </div>
            <div class="modal-header justify-center border-b-0 pb-2">
                <h2 id="time-confirm-concurrent" class="text-3xl font-bold text-white"></h2>
            </div>
            <p id="time-confirm-manche" class="text-xl text-gray-400 -mt-2 mb-4"></p>
            <div class="my-4">
                <p id="time-confirm-time" class="text-8xl font-bold text-yellow-400 font-mono"></p>
            </div>
            <div class="space-y-3 text-lg text-gray-300">
                <p id="time-confirm-personal-best" class="text-xl"></p>
                <p id="time-confirm-rank" class="text-2xl"></p>
                <p id="time-confirm-ecart-premier"></p>
                <p id="time-confirm-ecart-precedent"></p>
                <p id="time-confirm-speed" class="text-xl"></p>
            </div>
            <div class="flex justify-center mt-6">
                <button id="close-time-confirm-modal-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl text-lg">OK</button>
            </div>
        </div>
    </div>


    <!-- Modal pour les cr√©dits -->
    <div id="credits-modal" class="modal" style="display:none">
        <div class="modal-content max-w-lg">
            <div class="modal-header">
                <h2>Informations sur le projet</h2>
                <button class="modal-close-button" id="close-credits-modal-btn">&times;</button>
            </div>
            <div class="space-y-3 text-sm text-gray-700">
                <p><strong>Projet :</strong> Tableau de bord course caisse √† savon</p>
                <p><strong>Auteur principal :</strong> Romain Pourcel</p>
                <p><strong>Contribution :</strong> Louane Pourcel (√©l√®ve de 5e B au Coll√®ge Saint-Joseph CAUDAN) a particip√© √† la r√©alisation des tableaux des b√©n√©voles.</p>
                <p class="mt-4 pt-4 border-t border-gray-200 text-xs text-gray-500">
                    <em>Remarque : Ce fichier contient du code partiellement g√©n√©r√© √† l‚Äôaide d‚Äôun outil d‚Äôintelligence artificielle, puis revu et adapt√© manuellement.</em>
                </p>
            </div>
        </div>
    </div>

     <!-- Modal pour le tutoriel -->
    <div id="tutorial-modal" class="modal" style="display:none">
        <div class="modal-content max-w-lg">
            <div class="modal-header">
                <h2>Bienvenue sur le Tableau de Bord !</h2>
            </div>
            <div class="space-y-4">
                <p>C'est votre premi√®re connexion. Souhaitez-vous consulter un guide rapide pour prendre en main les fonctionnalit√©s li√©es √† votre r√¥le ?</p>
                <div class="flex justify-end gap-4 pt-4">
                    <button id="show-tutorial-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl">Voir le tutoriel</button>
                    <button id="close-tutorial-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl">Non, merci</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmation -->
    <div id="confirm-modal" class="modal" style="display:none">
        <div class="modal-content max-w-sm">
            <div class="modal-header">
               <h2 id="confirm-modal-title" class="text-xl font-bold">Confirmation Requise</h2>
            </div>
            <p id="confirm-modal-text" class="text-gray-600 my-6"></p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl">Annuler</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">Confirmer</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp as initializeFirebaseApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, getDocs, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // SECTION 1: AUTHENTIFICATION
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const competitorDashboardView = document.getElementById('competitor-dashboard-view');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const competitorLogoutBtn = document.getElementById('competitor-logout-btn');
        const userInfo = document.getElementById('user-info');
        
        let currentUser = null;
        let utilisateursAutorises = [];
        let isSuperAdmin = false;
        let db;
        let appId;
        let alarmSynth;

        // <!-- ============================================================================== -->
        // <!-- ================== ZONE √Ä MODIFIER / HIGHLIGHTED AREA ================== -->
        // <!-- VEUILLEZ REMPLACER LE BLOC CI-DESSOUS PAR VOTRE CONFIGURATION PERSONNELLE      -->
        // <!-- OBTENUE DEPUIS LA CONSOLE FIREBASE LORS DE L'AJOUT DE VOTRE APPLICATION WEB. -->
        // <!-- ============================================================================== -->
        const firebaseConfig = {
            apiKey: "AIzaSyCu1qYE7eSEheretG2xicIqlRjamgnEavA",
            authDomain: "caisse-a-savon-2025-14a45.firebaseapp.com",
            projectId: "caisse-a-savon-2025-14a45",
            storageBucket: "caisse-a-savon-2025-14a45.appspot.com",
            messagingSenderId: "301217982939",
            appId: "1:301217982939:web:1a1c501328475256661ffe"
        };
        // <!-- ============================================================================== -->
        // <!-- ========================== FIN DE LA ZONE √Ä MODIFIER ========================= -->
        // <!-- ============================================================================== -->

        appId = 'caisse-a-savon-2025'; // Identifiant unique pour vos donn√©es
        const app = initializeFirebaseApp(firebaseConfig);
        db = getFirestore(app);
        const auth = getAuth(app);

        async function authenticateAndStart() {
            try {
                await signInAnonymously(auth);
                await loadAccessData();
                loginSubmitBtn.disabled = false;
                loginSubmitBtn.textContent = 'Se connecter';
                checkSavedLogin();
            } catch (error) {
                console.error("Erreur d'authentification Firebase:", error);
                
                document.getElementById('login-form-container').style.display = 'none';
                const errorDisplay = document.getElementById('critical-error-display');
                const errorMessageContainer = document.getElementById('critical-error-message');
                errorDisplay.style.display = 'block';

                let errorHtml = "";
                
                if (error.code === 'auth/configuration-not-found') {
                    errorHtml = `
                        <p class="font-semibold text-lg">Probl√®me de configuration Firebase d√©tect√©.</p>
                        <p class="mt-2">L'application ne peut pas d√©marrer car la connexion "Anonyme" n'est pas activ√©e. C'est une √©tape de configuration <strong>obligatoire</strong>.</p>
                        <strong class="block mt-4">Comment corriger :</strong>
                        <ol class="list-decimal list-inside space-y-2 mt-2">
                            <li>Ouvrez la <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">console Firebase</a> de votre projet.</li>
                            <li>Cliquez sur <strong>"Authentication"</strong> dans le menu de gauche (section "Build").</li>
                            <li>Allez sur l'onglet <strong>"Sign-in method"</strong>.</li>
                            <li>Dans la liste, trouvez <strong>"Anonyme"</strong> et cliquez dessus.</li>
                            <li>Activez l'interrupteur et enregistrez.</li>
                        </ol>
                        <p class="mt-4">Apr√®s avoir fait cette modification, veuillez <strong>rafra√Æchir cette page</strong> pour utiliser l'application.</p>
                    `;
                } else if (error.code === 'auth/api-key-not-valid') {
                     errorHtml = `
                        <p class="font-semibold">La cl√© API (apiKey) dans votre configuration Firebase est invalide.</p>
                        <p>Cela signifie que la configuration Firebase dans le code est incorrecte ou a mal √©t√© copi√©e.</p>
                        <strong class="block mt-4">POUR CORRIGER :</strong>
                        <ol class="list-decimal list-inside space-y-2 mt-2">
                            <li>Retournez dans les param√®tres de votre projet sur la <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">console Firebase</a>.</li>
                            <li>Copiez √† nouveau et avec attention l'objet de configuration <code>firebaseConfig</code>.</li>
                            <li>Collez-le dans le fichier <code>index.html</code> en vous assurant de remplacer enti√®rement le bloc d'exemple.</li>
                        </ol>
                       `;
                } else {
                    errorHtml = `<p>Une erreur inattendue est survenue. Veuillez v√©rifier la console du navigateur pour plus de d√©tails.</p><p class="mt-2 text-sm text-gray-500">Code d'erreur : ${error.code}</p>`;
                }
                
                errorMessageContainer.innerHTML = errorHtml;
            }
        }
        
        function checkSavedLogin() {
            const savedUserStr = localStorage.getItem('currentUser');
            if (savedUserStr) {
                Tone.start(); // Activation du contexte audio pour les utilisateurs d√©j√† connect√©s
                const savedUser = JSON.parse(savedUserStr);
                 const foundUser = utilisateursAutorises.find(user => user.id === savedUser.id);
                  if (foundUser) {
                      if (foundUser.role === 'Concurrent') {
                          if (foundUser.linkedCompetitorId) {
                            loginScreen.style.display = 'none';
                            competitorDashboardView.style.display = 'block';
                            startCompetitorLogic(foundUser.linkedCompetitorId);
                          } else {
                            // Cas d'erreur : un concurrent sans concurrent li√©. On le d√©connecte.
                            localStorage.removeItem('currentUser');
                          }
                      } else {
                          currentUser = foundUser;
                          isSuperAdmin = (currentUser.nom === "POURCEL" && currentUser.prenom === "Romain" && currentUser.tel === "0613255651") || currentUser.role === 'Super Admin';
                          loginScreen.style.display = 'none';
                          mainApp.style.display = 'block';
                          userInfo.textContent = `${currentUser.prenom} ${currentUser.nom} (${isSuperAdmin ? 'Super Admin' : currentUser.role})`;
                          startAppLogic();
                      }
                   } else {
                       localStorage.removeItem('currentUser');
                   }
            }
        }

        function loadAccessData() {
            return new Promise((resolve, reject) => {
                const usersCollection = collection(db, `artifacts/${appId}/public/data/users`);
                const unsubscribe = onSnapshot(usersCollection,
                    (snapshot) => {
                        utilisateursAutorises = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log("Utilisateurs charg√©s depuis Firestore :", JSON.parse(JSON.stringify(utilisateursAutorises)));
                        resolve();
                    },
                    (error) => {
                        console.error("Erreur de lecture (Firestore):", error);
                        if(error.code === 'permission-denied') {
                            showConfirmationModal("Erreur de permission. Assurez-vous que les r√®gles de s√©curit√© de votre base de donn√©es Firestore sont correctement configur√©es ET que la structure des donn√©es (dossiers et sous-dossiers) a √©t√© cr√©√©e exactement comme indiqu√© dans le guide.", () => {});
                        } else {
                             showConfirmationModal("Une erreur de base de donn√©es est survenue.", () => {});
                        }
                        reject(error);
                    }
                );
            });
        }
        
        function removeAccents(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nomInput = document.getElementById('login-nom').value.trim();
            const prenomInput = document.getElementById('login-prenom').value.trim();
            const tel = document.getElementById('login-tel').value.replace(/\s/g, '');

            const normalizedNomInput = removeAccents(nomInput.toUpperCase());
            const normalizedPrenomInput = removeAccents(capitalizeFirstLetter(prenomInput));
            
            const foundUser = utilisateursAutorises.find(user => {
                const normalizedUserNom = removeAccents(String(user.nom || '').trim().toUpperCase());
                const normalizedUserPrenom = removeAccents(capitalizeFirstLetter(String(user.prenom || '').trim()));
                return normalizedUserNom === normalizedNomInput &&
                       normalizedUserPrenom === normalizedPrenomInput &&
                       String(user.tel || '').replace(/\s/g, '') === tel;
            });

            if (foundUser) {
                Tone.start(); // Activation du contexte audio lors de la connexion
                localStorage.setItem('currentUser', JSON.stringify(foundUser));

                if (foundUser.role === 'Concurrent') {
                    if (foundUser.linkedCompetitorId) {
                        loginScreen.style.display = 'none';
                        competitorDashboardView.style.display = 'block';
                        startCompetitorLogic(foundUser.linkedCompetitorId);
                    } else {
                        loginError.innerHTML = "<strong>Erreur de compte.</strong><br>Votre acc√®s concurrent n'est li√© √† aucune fiche. Veuillez contacter un administrateur.";
                        loginError.classList.remove('hidden');
                        localStorage.removeItem('currentUser');
                    }
                } else {
                    currentUser = foundUser;
                    isSuperAdmin = (currentUser.nom === "POURCEL" && currentUser.prenom === "Romain" && currentUser.tel === "0613255651") || currentUser.role === 'Super Admin';
                    loginScreen.style.display = 'none';
                    mainApp.style.display = 'block';
                    userInfo.textContent = `${currentUser.prenom} ${currentUser.nom} (${isSuperAdmin ? 'Super Admin' : currentUser.role})`;
                    startAppLogic();
                    showTutorialModalIfNeeded();
                }
            } else {
                loginError.innerHTML = `<strong>Informations incorrectes.</strong><br>
                    Veuillez v√©rifier les points suivants :<br>
                    <ul class="list-disc list-inside mt-1">
                        <li>Le <strong>Nom</strong> doit √™tre en MAJUSCULES.</li>
                        <li>Le <strong>Pr√©nom</strong> doit commencer par une majuscule.</li>
                        <li>Le <strong>T√©l√©phone</strong> ne doit contenir que des chiffres, sans espaces.</li>
                    </ul>`;
                loginError.classList.remove('hidden');
            }
        });


        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('tutorialShown');
            location.reload();
        });
        competitorLogoutBtn.addEventListener('click', () => {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('tutorialShown');
            location.reload();
        });


        // SECTION 2: LOGIQUE DE L'APPLICATION
        function startAppLogic() {
            let editingBenevoleId = null;
            let editingConcurrentId = null;
            let editingUserId = null;
            let modalTimeout = null;
            let currentDisplayType = null;
            
            const creditsButtonHTML = `<div class="text-center text-gray-400 text-xs my-2"><button class="credits-btn-trigger hover:underline text-blue-500">Application web cr√©√©e Par</button></div>`;

            // Confirmation Modal Logic
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalText = document.getElementById('confirm-modal-text');
            let confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
            let confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');

            function showConfirmationModal(text, onConfirm, title = "Confirmation Requise", type = 'default') {
                const modalContent = confirmModal.querySelector('.modal-content');

                confirmModalTitle.textContent = title;
                confirmModalText.innerHTML = text;
                
                if (type === 'emergency') {
                    modalContent.classList.add('modal-content-emergency');
                } else {
                    modalContent.classList.remove('modal-content-emergency');
                }
                
                confirmModal.style.display = 'flex';

                let newConfirmBtn = confirmModalConfirmBtn.cloneNode(true);
                confirmModalConfirmBtn.parentNode.replaceChild(newConfirmBtn, confirmModalConfirmBtn);
                confirmModalConfirmBtn = newConfirmBtn;

                let newCancelBtn = confirmModalCancelBtn.cloneNode(true);
                confirmModalCancelBtn.parentNode.replaceChild(newCancelBtn, confirmModalCancelBtn);
                confirmModalCancelBtn = newCancelBtn;

                confirmModalConfirmBtn.onclick = () => {
                    confirmModal.style.display = 'none';
                    modalContent.classList.remove('modal-content-emergency');
                    onConfirm();
                };
                confirmModalCancelBtn.onclick = () => {
                    confirmModal.style.display = 'none';
                    modalContent.classList.remove('modal-content-emergency');
                };
            }

            // -- Inject HTML content for tabs --
            document.getElementById('content-dashboard').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-4 md:p-6"><h2 class="text-xl font-bold text-gray-800 mb-4">Suivi du mat√©riel</h2><div id="material-summary-container" class="mb-8 p-4 bg-yellow-50 rounded-xl shadow-inner border-l-4 border-yellow-400 flex flex-wrap justify-between items-center text-sm md:text-base gap-4"><div class="flex flex-col items-center"><div class="flex items-center space-x-2"><span class="font-medium text-gray-700">Radios:</span><span class="font-bold text-blue-600" id="radios-distribuees">0</span><span class="text-gray-500">D</span><span class="font-bold text-green-600" id="radios-restituees">0</span><span class="text-gray-500">R</span></div><div class="flex items-center space-x-2 mt-1"><span class="font-medium text-red-500">Manquantes:</span><span class="font-bold text-lg text-red-500" id="radios-manquantes">0</span></div></div><div class="flex-grow"></div><div class="flex flex-col items-center"><div class="flex items-center space-x-2"><span class="font-medium text-gray-700">Sifflets:</span><span class="font-bold text-blue-600" id="sifflets-distribues">0</span><span class="text-gray-500">D</span><span class="font-bold text-green-600" id="sifflets-restituees">0</span><span class="text-gray-500">R</span></div><div class="flex items-center space-x-2 mt-1"><span class="font-medium text-red-500">Manquants:</span><span class="font-bold text-lg text-red-500" id="sifflets-manquants">0</span></div></div><div class="flex-grow"></div><div class="flex items-center space-x-2 mt-4 md:mt-0"><span class="font-medium text-gray-700">Appareils manquants:</span><span class="font-bold text-2xl text-red-500" id="appareils-manquants">0</span></div></div><h2 class="text-xl font-bold text-gray-800 mb-4">Liste des b√©n√©voles</h2><div class="mb-4"><label for="filter-input" class="block text-sm font-medium text-gray-700 mb-1">Recherche par Nom ou Pr√©nom</label><input type="text" id="filter-input" placeholder="Rechercher par Nom ou Pr√©nom..." class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full max-w-md"></div><div class="flex flex-col lg:flex-row justify-between items-center mb-4 gap-4"><div class="flex flex-wrap items-end gap-4"><button id="add-benevole-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200">+ Ajouter</button></div><div class="w-full lg:w-auto flex-grow flex flex-col sm:flex-row justify-end items-center gap-2"><select id="filter-fonction" class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full sm:w-auto"></select><select id="filter-lieu" class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full sm:w-auto"></select></div><div class="flex items-center gap-4 flex-wrap"><div class="flex items-center gap-2" id="missing-info-container"><input type="checkbox" id="filter-missing-info" class="form-checkbox h-4 w-4 text-red-600 rounded"><label for="filter-missing-info" class="text-sm font-medium text-gray-700 select-none">Infos manquantes ‚ùå</label></div><div class="flex items-center gap-2"><input type="checkbox" id="toggleTel" class="form-checkbox h-4 w-4 text-blue-600 rounded"><label for="toggleTel" class="text-sm font-medium text-gray-700 select-none">Masquer T√©l.</label></div><div class="flex items-center gap-2"><span id="save-message" class="text-green-600 font-bold"></span><button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200">Sauvegarder</button></div></div></div><div class="bg-gray-100 p-2 md:p-4 rounded-xl overflow-x-auto shadow-inner"><table class="divide-y divide-gray-200" id="benevoles-table"><thead class="bg-gray-200 sticky top-0 z-10"><tr><th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider rounded-tl-xl">Nom & Pr√©nom</th><th data-column="tel" class="px-4 py-3 text-left text-xs font-bold uppercase">T√©l√©phone</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Jours de pr√©sence</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Lieu d'affectation üìç</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Fonction üíº</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Mat√©riel (D/R)</th><th data-column="zello" class="px-4 py-3 text-left text-xs font-bold uppercase">Zello üìª</th><th data-column="acces" class="px-4 py-3 text-left text-xs font-bold uppercase">Acc√®s</th><th data-column="action" class="px-4 py-3 text-left text-xs font-bold uppercase rounded-tr-xl">Action</th></tr></thead><tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>` + creditsButtonHTML;
            document.getElementById('content-concurrents').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-4 md:p-6"><div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><h2 class="text-xl font-bold text-gray-800">Liste des Concurrents</h2><input type="text" id="filter-concurrents-input" placeholder="Rechercher par Nom ou Pr√©nom..." class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full sm:w-auto"><div class="flex items-center gap-4"><button id="add-concurrent-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200 text-sm">+ Ajouter un Concurrent</button><div><span id="save-concurrents-message" class="text-green-600 font-bold mr-4"></span><button id="save-concurrents-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200 text-sm">Sauvegarder</button></div></div></div><div class="bg-gray-100 p-2 md:p-4 rounded-xl overflow-x-auto shadow-inner"><table id="concurrents-admin-table" class="divide-y divide-gray-200"><thead class="bg-gray-200"><tr><th class="px-4 py-3 text-left text-xs font-bold uppercase rounded-tl-xl">Concurrent</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Enfant</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Dossier Inscription</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Assurance</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Paiement Cotisation</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">√âquipements S√©curit√©</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Contr√¥le Tech.</th><th class="px-4 py-3 text-left text-xs font-bold uppercase rounded-tr-xl">Action</th></tr></thead><tbody id="concurrents-admin-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>` + creditsButtonHTML;
            document.getElementById('content-race').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-4 md:p-6"><div id="chrono-container" class="mb-6 p-4 md:p-6 bg-gray-50 rounded-2xl shadow-inner"><div class="text-center mb-4"><h2 id="current-manche-display" class="text-3xl font-bold text-blue-600"></h2></div><div class="max-w-md mx-auto"><div class="mb-4"><label for="chrono-search-input" class="block text-sm font-medium text-gray-700 mb-1">Concurrent au d√©part (par nom)</label><input type="text" id="chrono-search-input" list="concurrents-datalist" placeholder="Rechercher..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><datalist id="concurrents-datalist"></datalist></div><div id="selected-concurrent-display" class="text-center font-bold text-xl text-gray-700 h-8 mb-4"></div><div id="chrono-display" class="text-5xl font-bold text-center text-blue-600 bg-white p-4 rounded-xl mb-4 shadow">00:00:00</div><div class="grid grid-cols-2 gap-3 mt-auto"><button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200" disabled>D√©marrer</button><button id="stop-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200" disabled>Arr√™ter et Enregistrer</button><button id="reset-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200 col-span-2">R√©initialiser</button></div></div></div><div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><h2 class="text-xl font-bold text-gray-800">Classement de la Course</h2><input type="text" id="filter-race-input" placeholder="Rechercher un concurrent..." class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full sm:w-auto"><div class="flex items-center gap-2 flex-wrap justify-center sm:justify-end"><button id="reset-race-btn" class="bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded-xl transition duration-200">R√©initialiser Course</button><button id="new-heat-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200">Manche Suivante</button></div></div><div id="race-table-container" class="bg-gray-100 p-2 md:p-4 rounded-xl shadow-inner overflow-x-auto"><table id="race-table" class="divide-y divide-gray-200"><thead id="race-table-head" class="bg-gray-200 sticky top-0"></thead><tbody id="race-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>` + creditsButtonHTML;
            document.getElementById('content-podium').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-4 md:p-6"><h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">R√©sultats & Podiums</h2><div class="flex flex-col sm:flex-row justify-center items-center gap-4 flex-wrap"><button id="current-heat-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 text-lg">Course en cours</button><button id="previous-heat-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 text-lg">Temps Course Pr√©c√©dente</button><button id="podium-fastest-lap-btn" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-6 rounded-xl transition duration-200 text-lg">Podium Descente Rapide</button><button id="podium-grand-prix-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 text-lg">Podium Grand Prix</button></div></div>` + creditsButtonHTML;
            document.getElementById('content-radar').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-4 md:p-6"><div class="max-w-md mx-auto text-center"><h2 class="text-2xl font-bold text-gray-800 mb-4">Saisie Radar</h2><div id="radar-concurrent-display" class="mb-4 text-xl font-semibold text-blue-600 h-8">Aucun concurrent en piste</div><div class="flex items-center justify-center gap-2 mb-4"><input type="number" id="radar-speed-input" placeholder="Vitesse" class="text-5xl font-bold text-center w-48 p-2 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"><span class="text-3xl font-bold text-gray-500">km/h</span></div><button id="save-speed-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200">Enregistrer Vitesse</button></div></div>` + creditsButtonHTML;
            document.getElementById('content-display').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-4 md:p-6"><h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Panneau de Contr√¥le Affichage</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="competitor-card text-center"><h3 class="text-lg font-bold mb-2">Affichage en Direct</h3><p class="text-sm text-gray-600 mb-4">Ouvre une fen√™tre qui affiche le r√©sum√© des temps d√®s qu'une course est termin√©e.</p><button id="display-live-recap-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl">Lancer l'Affichage Live</button></div><div class="competitor-card text-center"><h3 class="text-lg font-bold mb-2">Podium Vitesse</h3><p class="text-sm text-gray-600 mb-4">Ouvre le podium de la descente la plus rapide dans une nouvelle fen√™tre.</p><button id="display-podium-speed-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl">Afficher le Podium Vitesse</button></div><div class="competitor-card text-center"><h3 class="text-lg font-bold mb-2">Podium Grand Prix</h3><p class="text-sm text-gray-600 mb-4">Ouvre le podium du Grand Prix (temps cumul√©s) dans une nouvelle fen√™tre.</p><button id="display-podium-gp-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl">Afficher le Podium GP</button></div></div></div>` + creditsButtonHTML;
            document.getElementById('content-admin').innerHTML = creditsButtonHTML + `
                <div class="bg-white shadow-xl rounded-2xl p-4 md:p-6">
                    <div class="mb-6 border-b border-gray-200">
                         <nav class="flex space-x-4" aria-label="Admin Tabs">
                            <button id="show-access-btn" class="admin-sub-tab-button active py-2 px-4 border-b-2 font-medium text-sm">Gestion des Acc√®s</button>
                            <button id="show-reset-btn" class="admin-sub-tab-button py-2 px-4 border-b-2 font-medium text-sm">R√©initialisation</button>
                        </nav>
                    </div>

                    <div id="admin-access-section">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><div><h2 class="text-xl font-bold text-gray-800">G√©rer les utilisateurs autoris√©s</h2><p class="text-gray-600 text-sm">Seuls les utilisateurs list√©s ici peuvent se connecter.</p></div><input type="text" id="filter-access-input" placeholder="Rechercher par Nom ou Pr√©nom..." class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full sm:w-auto"></div><form id="add-user-form" class="mb-8 p-4 bg-gray-50 rounded-xl border border-gray-200 flex flex-wrap items-end gap-4"><div class="flex-grow min-w-[150px]"><label for="user-nom" class="block text-sm font-medium text-gray-700">Nom</label><input type="text" id="user-nom" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex-grow min-w-[150px]"><label for="user-prenom" class="block text-sm font-medium text-gray-700">Pr√©nom</label><input type="text" id="user-prenom" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex-grow min-w-[150px]"><label for="user-tel" class="block text-sm font-medium text-gray-700">T√©l√©phone</label><input type="tel" id="user-tel" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex-grow min-w-[150px]"><label for="user-role" class="block text-sm font-medium text-gray-700">R√¥le</label><select id="user-role" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></select></div><div id="user-competitor-link-container" class="flex-grow min-w-[150px]" style="display:none;"><label for="user-competitor-select" class="block text-sm font-medium text-gray-700">Concurrent Li√©</label><select id="user-competitor-select" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></select></div><div class="flex items-center gap-2"><button type="submit" id="add-user-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl">+ Ajouter</button><button type="button" id="cancel-edit-user-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl" style="display:none;">Annuler</button></div></form><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Nom Pr√©nom</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">T√©l√©phone</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">R√¥le</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Action</th></tr></thead><tbody id="access-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                    </div>

                    <div id="admin-reset-section" style="display: none;">
                         <h2 class="text-xl font-bold text-red-700 mb-2">Zone de R√©initialisation</h2><p class="text-gray-600 mb-6">Attention, les actions sur cette page sont irr√©versibles et supprimeront d√©finitivement les donn√©es de la base.</p><div class="space-y-6"><div class="border border-red-200 bg-red-50 p-4 rounded-lg"><h3 class="font-bold text-lg text-red-800">R√©initialiser les B√©n√©voles</h3><p class="text-red-700 my-2">Cette action supprimera <strong>TOUS</strong> les b√©n√©voles de la base de donn√©es.</p><button id="reset-benevoles-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">R√©initialiser les B√©n√©voles</button></div><div class="border border-red-200 bg-red-50 p-4 rounded-lg"><h3 class="font-bold text-lg text-red-800">R√©initialiser la Course</h3><p class="text-red-700 my-2">Cette action supprimera <strong>TOUS</strong> les concurrents et <strong>TOUS</strong> les temps de course enregistr√©s. La course sera remise √† z√©ro (Manche 1).</p><button id="reset-concurrents-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">R√©initialiser les Concurrents et la Course</button></div><div class="border border-red-200 bg-red-50 p-4 rounded-lg"><h3 class="font-bold text-lg text-red-800">R√©initialiser les Acc√®s</h3><p class="text-red-700 my-2">Cette action supprimera <strong>TOUS</strong> les utilisateurs, <strong>SAUF</strong> le Super Administrateur.</p><button id="reset-access-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">R√©initialiser les Acc√®s</button></div></div>
                    </div>
                </div>
            ` + creditsButtonHTML;

            document.getElementById('add-benevole-modal').innerHTML = `<div class="modal-content max-w-md"><div class="modal-header"><h2 id="modal-title">Ajouter un nouveau b√©n√©vole</h2><button class="modal-close-button" id="close-modal-btn">&times;</button></div><form id="add-benevole-form" class="space-y-4"><div><label for="nom" class="block text-sm font-medium text-gray-700">Nom</label><input type="text" id="nom" name="nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div><div><label for="prenom" class="block text-sm font-medium text-gray-700">Pr√©nom</label><input type="text" id="prenom" name="prenom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div><div><label for="tel" class="block text-sm font-medium text-gray-700">T√©l√©phone</label><input type="text" id="tel" name="tel" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex justify-end pt-4"><button type="submit" id="modal-submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl">Ajouter</button></div></form></div>`;
            document.getElementById('add-concurrent-modal').innerHTML = `<div class="modal-content max-w-md"><div class="modal-header"><h2 id="concurrent-modal-title">Ajouter un Concurrent</h2><button class="modal-close-button" id="close-concurrent-modal-btn">&times;</button></div><form id="add-concurrent-form-modal" class="space-y-4"><div><label for="concurrent-nom-modal" class="block text-sm font-medium text-gray-700">Nom Concurrent / √âquipe</label><input type="text" id="concurrent-nom-modal" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="flex items-center"><input type="checkbox" id="concurrent-enfant-modal" class="h-4 w-4 text-blue-600 rounded mr-2"><label for="concurrent-enfant-modal" class="text-sm font-medium text-gray-700">Enfant üßí</label></div><div class="flex justify-end pt-4"><button type="submit" id="concurrent-modal-submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl">Ajouter</button></div></form></div>`;
            
            // Re-select all elements after injection
            const tableBody = document.getElementById('table-body'), toggleTelCheckbox = document.getElementById('toggleTel'), addBenevoleBtn = document.getElementById('add-benevole-btn'), saveBtn = document.getElementById('save-btn'), closeModalBtn = document.getElementById('close-modal-btn'), addBenevoleForm = document.getElementById('add-benevole-form'), filterInput = document.getElementById('filter-input'), filterMissingInfoCheckbox = document.getElementById('filter-missing-info'), filterFonction = document.getElementById('filter-fonction'), filterLieu = document.getElementById('filter-lieu');
            const chronoDisplay=document.getElementById("chrono-display"),startBtn=document.getElementById("start-btn"),stopBtn=document.getElementById("stop-btn"),resetBtn=document.getElementById("reset-btn"),addConcurrentBtn = document.getElementById('add-concurrent-btn'),concurrentsAdminBody = document.getElementById('concurrents-admin-body'),saveConcurrentsBtn = document.getElementById('save-concurrents-btn'),saveConcurrentsMessage = document.getElementById('save-concurrents-message'),addUserForm = document.getElementById('add-user-form'),accessTableBody = document.getElementById('access-table-body'), newHeatBtn = document.getElementById('new-heat-btn'), previousHeatBtn = document.getElementById('previous-heat-btn'), currentMancheDisplay = document.getElementById('current-manche-display'), gridScreen=document.getElementById("starting-grid-screen"),closeGridBtn=document.getElementById("close-grid-btn"), resetRaceBtn = document.getElementById('reset-race-btn'), importBtn = document.getElementById('import-btn'), exportBtn = document.getElementById('export-btn'), importFile = document.getElementById('import-file'), creditsModal = document.getElementById('credits-modal'), closeCreditsModalBtn = document.getElementById('close-credits-modal-btn'), addConcurrentModal = document.getElementById('add-concurrent-modal'), closeConcurrentModalBtn = document.getElementById('close-concurrent-modal-btn'), addConcurrentFormModal = document.getElementById('add-concurrent-form-modal'), cancelEditUserBtn = document.getElementById('cancel-edit-user-btn'), addUserBtn = document.getElementById('add-user-btn'), filterConcurrentsInput = document.getElementById('filter-concurrents-input'), filterRaceInput = document.getElementById('filter-race-input'), filterAccessInput = document.getElementById('filter-access-input'), resetBenevolesBtn = document.getElementById('reset-benevoles-btn'), resetConcurrentsBtn = document.getElementById('reset-concurrents-btn'), chronoSearchInput = document.getElementById('chrono-search-input'), concurrentsDatalist = document.getElementById('concurrents-datalist'), selectedConcurrentDisplay = document.getElementById('selected-concurrent-display'), timeConfirmationModal = document.getElementById('time-confirmation-modal'), closeTimeConfirmModalBtn = document.getElementById('close-time-confirm-modal-btn');
            const podiumFastestLapBtn = document.getElementById('podium-fastest-lap-btn');
            const podiumGrandPrixBtn = document.getElementById('podium-grand-prix-btn');
            const currentHeatBtn = document.getElementById('current-heat-btn');
            const saveSpeedBtn = document.getElementById('save-speed-btn');

            // Emergency Button Logic
            const emergencyBtn = document.getElementById('emergency-btn');
            const stopEmergencyBtn = document.getElementById('stop-emergency-btn');
            const emergencyAlert = document.getElementById('emergency-alert');
            const emergencyDocRef = doc(db, `artifacts/${appId}/public/data/raceState`, 'emergency');

            emergencyBtn.addEventListener('click', () => {
                const modalTitle = "üö® CONFIRMER L'INCIDENT DE COURSE üö®";
                const modalText = "Vous √™tes sur le point de signaler un <strong>INCIDENT DE COURSE</strong>. Une alerte sonore et visuelle sera envoy√©e √† <strong>TOUS</strong> les membres de l'organisation.<br><br>N'utilisez cette fonction qu'en cas de n√©cessit√© av√©r√©e.<br><br><strong class='text-lg'>Confirmez-vous l'envoi de l'alerte ?</strong>";
                
                showConfirmationModal(
                    modalText,
                    async () => {
                        await setDoc(emergencyDocRef, { 
                            active: true, 
                            triggeredBy: `${currentUser.prenom} ${currentUser.nom}`,
                            triggeredByTel: currentUser.tel || null
                        });
                    },
                    modalTitle,
                    'emergency'
                );
            });

            stopEmergencyBtn.addEventListener('click', async () => {
                await setDoc(emergencyDocRef, { active: false, triggeredBy: null });
            });
            
            onSnapshot(emergencyDocRef, (snapshot) => {
                const emergencyData = snapshot.data();
                if (emergencyData && emergencyData.active) {
                    emergencyAlert.querySelector('h1').textContent = '‚ö†Ô∏è INCIDENT COURSE ‚ö†Ô∏è';
                    emergencyAlert.style.display = 'flex';
                    const triggeredByName = emergencyData.triggeredBy || 'un utilisateur';
                    
                    // Trouver le lieu du b√©n√©vole qui a d√©clench√© l'alerte (recherche plus fiable par N¬∞ de t√©l)
                    let triggeringUser = null;
                    if (emergencyData.triggeredByTel) {
                        triggeringUser = data.find(user => String(user.tel || '').replace(/\s/g, '') === String(emergencyData.triggeredByTel).replace(/\s/g, ''));
                    }
                    const locationInfo = triggeringUser ? `<strong>(Lieu : ${triggeringUser.lieu})</strong>` : '';

                    document.getElementById('emergency-message').innerHTML = `Un incident de course a √©t√© signal√© par <strong>${triggeredByName}</strong>. ${locationInfo}<br>Restez vigilants et attendez les instructions.`;

                    if (!alarmSynth) {
                        alarmSynth = new Tone.Synth({
                            oscillator: { type: 'sawtooth' },
                            envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
                        }).toDestination();
                    }
                    Tone.Transport.stop();
                    Tone.Transport.clear();
                    // Son d'alarme plus intense
                    new Tone.Loop(time => {
                        alarmSynth.triggerAttackRelease('A5', '16n', time);
                        alarmSynth.triggerAttackRelease('E5', '16n', time + Tone.Time('16n').toSeconds());
                    }, '8n').start(0);

                    Tone.Transport.start();
                } else {
                    emergencyAlert.style.display = 'none';
                    if (Tone.Transport.state === 'started') {
                        Tone.Transport.stop();
                        Tone.Transport.clear();
                    }
                }
            });

            // Display Logic
            const displayLiveRecapBtn = document.getElementById('display-live-recap-btn');
            const displayPodiumSpeedBtn = document.getElementById('display-podium-speed-btn');
            const displayPodiumGpBtn = document.getElementById('display-podium-gp-btn');
            const displayScreen = document.getElementById('display-screen');
            const closeDisplayBtn = document.getElementById('close-display-btn');
            
            function showDisplayScreen(type) {
                currentDisplayType = type;
                mainApp.style.display = 'none';
                displayScreen.style.display = 'flex';
                renderDisplayContent(type);
            }

            async function renderDisplayContent(type, data = null) {
                const displayTitle = document.getElementById('display-title');
                const displayContainer = document.getElementById('display-table-container');
                displayContainer.innerHTML = ''; // Clear previous content

                let contentHTML = '<table class="min-w-full divide-y divide-gray-200">';
                
                if (type === 'live') {
                    displayTitle.textContent = "Affichage en Direct - Dernier Temps";
                    const chronoSnapshot = await getDoc(chronoDocRef);
                    const chronoData = chronoSnapshot.data();
                    const lastTime = data ? data.lastRecordedTime : chronoData.lastRecordedTime;

                    if (lastTime) {
                         contentHTML += `
                            <tbody class="bg-white text-center text-2xl">
                                <tr><td class="p-4 font-bold text-4xl text-blue-600" colspan="2">${lastTime.nom}</td></tr>
                                <tr><td class="p-4 font-mono text-7xl font-bold" colspan="2">${formatTime(lastTime.time)}</td></tr>
                                ${lastTime.rank ? `<tr><td class="p-2">Classement</td><td class="p-2 font-bold">${lastTime.rank}e</td></tr>` : ''}
                                ${lastTime.ecartPremier ? `<tr><td class="p-2">√âcart 1er</td><td class="p-2 font-bold text-red-500">${formatEcart(lastTime.ecartPremier)}</td></tr>` : ''}
                                ${lastTime.speed ? `<tr><td class="p-2">Vitesse</td><td class="p-2 font-bold">${lastTime.speed} km/h</td></tr>` : ''}
                            </tbody>
                        `;
                    } else {
                        contentHTML += '<tbody><tr><td class="p-8 text-center text-gray-500">En attente du prochain temps...</td></tr></tbody>';
                    }

                } else if (type === 'podium-speed') {
                    displayTitle.textContent = "Podium - Descente la plus Rapide";
                    contentHTML += `<thead class="bg-gray-200"><tr>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Pos.</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Concurrent</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Meilleur Temps</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">√âcart 1er</th>
                    </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    
                    const ranked = [...concurrents].filter(c => c.meilleurTemps !== null).sort((a,b) => a.meilleurTemps - b.meilleurTemps);
                    const tempsPremier = ranked.length > 0 ? ranked[0].meilleurTemps : null;

                    ranked.forEach((c, i) => {
                        const ecartPremier = tempsPremier !== null ? c.meilleurTemps - tempsPremier : null;
                        let classementHTML = i + 1;
                        if (classementHTML === 1) classementHTML = `ü•á ${classementHTML}`;
                        else if (classementHTML === 2) classementHTML = `ü•à ${classementHTML}`;
                        else if (classementHTML === 3) classementHTML = `ü•â ${classementHTML}`;

                        contentHTML += `<tr>
                            <td class="px-4 py-3 text-sm font-bold">${classementHTML}</td>
                            <td class="px-4 py-3 text-sm">${c.nom} ${c.isChild ? 'üßí' : ''}</td>
                            <td class="px-4 py-3 text-sm font-semibold text-blue-600">${formatTime(c.meilleurTemps)}</td>
                            <td class="px-4 py-3 text-sm text-red-500">${formatEcart(ecartPremier)}</td>
                        </tr>`;
                    });
                     contentHTML += `</tbody>`;

                } else if (type === 'podium-gp') {
                     displayTitle.textContent = "Podium - Grand Prix";
                     contentHTML += `<thead class="bg-gray-200"><tr>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Pos.</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Concurrent</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Temps Total</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">√âcart 1er</th>
                    </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    
                    concurrents.forEach(c => {
                        const officialRuns = c.manches.slice(2).filter(m => m && m.time !== null).map(m => m.time);
                        c.completedRuns = officialRuns.length;
                        c.tempsTotal = officialRuns.length > 0 ? officialRuns.reduce((a, b) => a + b, 0) : null;
                    });
                    
                    const maxCourses = currentManche > 2 ? currentManche - 2 : 0;
                    
                    let ranked = [];
                    if (maxCourses > 0) {
                        ranked = concurrents.filter(c => c.completedRuns === maxCourses && c.tempsTotal !== null).sort((a,b) => a.tempsTotal - b.tempsTotal);
                    }

                    const tempsPremier = ranked.length > 0 ? ranked[0].tempsTotal : null;

                    ranked.forEach((c, i) => {
                        const ecartPremier = tempsPremier !== null ? c.tempsTotal - tempsPremier : null;
                        let classementHTML = i + 1;
                        if (classementHTML === 1) classementHTML = `ü•á ${classementHTML}`;
                        else if (classementHTML === 2) classementHTML = `ü•à ${classementHTML}`;
                        else if (classementHTML === 3) classementHTML = `ü•â ${classementHTML}`;

                        contentHTML += `<tr>
                            <td class="px-4 py-3 text-sm font-bold">${classementHTML}</td>
                            <td class="px-4 py-3 text-sm">${c.nom} ${c.isChild ? 'üßí' : ''}</td>
                            <td class="px-4 py-3 text-sm font-semibold text-blue-600">${formatTime(c.tempsTotal)}</td>
                            <td class="px-4 py-3 text-sm text-red-500">${formatEcart(ecartPremier)}</td>
                        </tr>`;
                    });
                    contentHTML += `</tbody>`;
                }
                
                contentHTML += '</table>';
                displayContainer.innerHTML = contentHTML;
            }

            displayLiveRecapBtn.addEventListener('click', () => showDisplayScreen('live'));
            displayPodiumSpeedBtn.addEventListener('click', () => showDisplayScreen('podium-speed'));
            displayPodiumGpBtn.addEventListener('click', () => showDisplayScreen('podium-gp'));
            closeDisplayBtn.addEventListener('click', () => {
                displayScreen.style.display = 'none';
                mainApp.style.display = 'block';
                currentDisplayType = null;
            });


            // Radar Logic
            saveSpeedBtn.addEventListener('click', async () => {
                const speed = document.getElementById('radar-speed-input').value;
                if (speed) {
                    await updateDoc(chronoDocRef, { currentSpeedKmh: parseFloat(speed) });
                    alert(`Vitesse de ${speed} km/h enregistr√©e.`);
                    document.getElementById('radar-speed-input').value = '';
                }
            });
            
            // =========================
            // B√âN√âVOLES LOGIC
            // =========================
            let data = [];
            const rolesOptions = ["Aucun acc√®s", "Super Admin", "Organisation", "Responsable Radio", "MAIRE", "Chrono D√©part", "Chrono Arriv√©e", "Saisie Radar", "Commissaire de Course", "B√©n√©vole", "Concurrent"];
            const joursOptions=["Samedi","Dimanche","Samedi/Dimanche","Non renseign√©"],fonctionOptions=["Organisateur üßë‚Äçüíº","Accueil / Inscriptions üìù","Contr√¥le Technique üõ†Ô∏è","S√©curit√© Piste üöß","Commissaire de Course üö¶","Chronom√©trage ‚è±Ô∏è","Logistique üöö","Relations Comp√©titeurs üëã","Espace Convivialit√© -B√©n√©voles üßë‚Äçü§ù‚Äçüßë","Remont√©e des Caisses üöú","Speaker üì¢","Photographe üì∏","Responsable Radio üìª","P√¥le de D√©part üèÅ","P√¥le d'Arriv√©e ‚úÖ","Podium üèÜ","Secr√©tariat üìã","Responsable Expo voiture üöó","Soutien op√©rationnel","√Ä d√©finir"],lieuOptions=["Mobile sur l'ensemble du parcours","Parc Concurrents","Piste de Course","Grille de D√©part","Contr√¥le Technique","Espace B√©n√©voles","Rue de l'√©tang","Rue des Ajoncs","Rue Mar√©chal Leclerc","Rue G√©n√©ral De Gaulle","Rue G√©n√©ral D√©borde","Rue des √âcoles","Rue Madame Gadot","Rue Saint-Joseph","Rue Fran√ßois Le Bail","Ligne d'arriv√©e","Garage Motrio", "Mur de Carton", "√Ä d√©finir"];
            
            const benevolesCollection = collection(db, `artifacts/${appId}/public/data/benevoles`);
            onSnapshot(benevolesCollection, (snapshot) => {
                data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBenevolesTable();
            });

            function populateFilter(selectElement, optionsArray, defaultLabel) {
                selectElement.innerHTML = `<option value="all">${defaultLabel}</option>`;
                optionsArray.forEach(option => {
                    selectElement.innerHTML += `<option value="${option}">${option}</option>`;
                });
            }
            populateFilter(filterFonction, fonctionOptions, 'Toutes les fonctions');
            populateFilter(filterLieu, lieuOptions, 'Tous les lieux');

            async function saveBenevolesData() {
                const batch = writeBatch(db);
                data.forEach(benevole => {
                    const { id, ...benevoleData } = benevole;
                    const docRef = doc(db, `artifacts/${appId}/public/data/benevoles`, id);
                    batch.update(docRef, benevoleData);
                });
                await batch.commit();
                const saveMessage = document.getElementById("save-message");
                saveMessage.textContent="Donn√©es sauvegard√©es !";
                saveMessage.classList.add("show");
                setTimeout(() => { saveMessage.classList.remove("show") }, 3000);
            }
            
            function updateAccessFromBenevole(benevole, newRole) {
                const cleanBenevoleTel = String(benevole.tel || '').replace(/\s/g, '');
                // Ne rien faire si le num√©ro de t√©l√©phone est vide ou non renseign√©
                if (!cleanBenevoleTel || cleanBenevoleTel.toLowerCase() === "nonrenseign√©") return;

                const existingUser = utilisateursAutorises.find(u => String(u.tel || '').replace(/\s/g, '') === cleanBenevoleTel);

                if (newRole === 'Aucun acc√®s') {
                    if (existingUser) {
                        deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, existingUser.id));
                    }
                } else {
                     if (existingUser) {
                        // Mettre √† jour le r√¥le et s'assurer que le num√©ro de t√©l√©phone est propre
                        updateDoc(doc(db, `artifacts/${appId}/public/data/users`, existingUser.id), { role: newRole, tel: cleanBenevoleTel });
                    } else {
                        // Cr√©er un nouvel utilisateur avec un num√©ro de t√©l√©phone propre
                        addDoc(collection(db, `artifacts/${appId}/public/data/users`), {
                            nom: benevole.nom,
                            prenom: benevole.prenom,
                            tel: cleanBenevoleTel,
                            role: newRole
                        });
                    }
                }
            }

            function createBenevoleSelect(options, currentValue, personIndex, property, disabled = false) {
                const select = document.createElement("select");
                select.className = "py-1 px-2 border-gray-200 rounded-md shadow-sm text-sm w-full";
                select.disabled = disabled;
                
                options.forEach(optionValue => {
                    const option = document.createElement("option");
                    option.value = optionValue;
                    option.textContent = optionValue;
                    if (optionValue === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                select.addEventListener("change", () => {
                    if (property === "role") {
                        const benevole = data[personIndex];
                        if (benevole) {
                            updateAccessFromBenevole(benevole, select.value);
                        }
                    } else {
                        data[personIndex][property] = select.value;
                    }

                    if (property === 'fonction') {
                          const benevole = data[personIndex];
                          const user = utilisateursAutorises.find(u => u.tel === benevole.tel);
                          const currentRole = user ? user.role : 'Aucun acc√®s';
                        if (!['Super Admin', 'Organisation', 'Chrono D√©part', 'Chrono Arriv√©e', 'MAIRE'].includes(currentRole)) {
                            if (select.value === 'Responsable Radio üìª') {
                                updateAccessFromBenevole(benevole, 'Responsable Radio');
                            } else {
                                updateAccessFromBenevole(benevole, 'B√©n√©vole');
                            }
                        }
                    }
                });
                
                return select;
            }

            function openBenevoleModal(benevoleId = null) {
                const modal = document.getElementById('add-benevole-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalSubmitBtn = document.getElementById('modal-submit-btn');
                
                addBenevoleForm.reset();

                if (benevoleId) {
                    editingBenevoleId = benevoleId;
                    const benevole = data.find(b => b.id === benevoleId);
                    modalTitle.textContent = "Modifier le b√©n√©vole";
                    modalSubmitBtn.textContent = "Enregistrer";
                    document.getElementById('nom').value = benevole.nom;
                    document.getElementById('prenom').value = benevole.prenom;
                    document.getElementById('tel').value = benevole.tel;
                } else {
                    editingBenevoleId = null;
                    modalTitle.textContent = "Ajouter un nouveau b√©n√©vole";
                    modalSubmitBtn.textContent = "Ajouter";
                }
                modal.style.display = 'flex';
            }

            function renderBenevolesTable() {
                const filterValue = filterInput.value.toLowerCase();
                const fonctionFilter = filterFonction.value;
                const lieuFilter = filterLieu.value;
                const missingInfoOnly = filterMissingInfoCheckbox.checked;

                let dataToRender = data.filter(p => 
                    (`${p.nom} ${p.prenom}`.toLowerCase().includes(filterValue)) &&
                    (fonctionFilter === 'all' || p.fonction === fonctionFilter) &&
                    (lieuFilter === 'all' || p.lieu === lieuFilter)
                );

                if (missingInfoOnly) {
                    dataToRender = dataToRender.filter(p => p.tel === "Non renseign√©" || p.jours === "Non renseign√©" || p.lieu === "√Ä d√©finir" || p.fonction === "√Ä d√©finir");
                }

                tableBody.innerHTML = "";
                const headerRow = document.querySelector("#benevoles-table thead tr");
                const canManage = isSuperAdmin || currentUser.role === 'Organisation';
                const isRadioManager = currentUser.role === 'Responsable Radio';

                // G√©rer la visibilit√© des colonnes dans l'en-t√™te
                headerRow.querySelector('[data-column="tel"]').style.display = canManage ? '' : 'none';
                headerRow.querySelector('[data-column="zello"]').style.display = canManage || isRadioManager ? '' : 'none';
                headerRow.querySelector('[data-column="acces"]').style.display = isSuperAdmin ? '' : 'none';
                headerRow.querySelector('[data-column="action"]').style.display = canManage ? '' : 'none';

                dataToRender.forEach((person) => {
                    const personIndex = data.findIndex(p => p.id === person.id);
                    const row = document.createElement('tr');
                    const cleanTel = String(person.tel || '').replace(/\s/g, '');
                    const hasValidTel = person.tel && person.tel !== "Non renseign√©" && cleanTel.length > 0;

                    row.innerHTML = `
                        <td class="px-4 py-3"><input type="text" value="${person.nom} ${person.prenom}" class="w-full text-sm"></td>
                        <td data-column="tel" class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <input type="tel" value="${person.tel}" class="flex-grow w-full text-sm ${!hasValidTel ? "text-red-500" : ""}">
                                <a href="tel:${cleanTel}" class="${!hasValidTel ? 'hidden' : ''} text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition-colors" title="Appeler ${person.prenom}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
                                </a>
                                <span class="${hasValidTel ? 'hidden' : ''} text-red-500 p-1" title="Num√©ro manquant">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </span>
                            </div>
                        </td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3"></td>
                        <td data-column="zello" class="px-4 py-3 text-center"><input type="checkbox" ${person.zello ? "checked" : ""}></td>
                        <td data-column="acces" class="px-4 py-3"></td>
                        <td data-column="action" class="px-4 py-3 text-center">
                            <div class="flex items-center gap-2 justify-center">
                                <button data-id="${person.id}" class="edit-benevole-btn text-blue-600 hover:text-blue-700 text-xs font-medium">Modifier</button>
                                <span class="text-gray-300">|</span>
                                <button data-id="${person.id}" class="delete-benevole-btn text-red-500 hover:text-red-700 text-xs font-medium">Supprimer</button>
                            </div>
                        </td>
                    `;
                    
                    row.querySelector('[data-column="tel"]').style.display = canManage ? '' : 'none';
                    row.querySelector('[data-column="zello"]').style.display = canManage || isRadioManager ? '' : 'none';
                    row.querySelector('[data-column="acces"]').style.display = isSuperAdmin ? '' : 'none';
                    row.querySelector('[data-column="action"]').style.display = canManage ? '' : 'none';

                    row.querySelector('input[type="text"]').disabled = !canManage;
                    row.querySelector('input[type="tel"]').disabled = !canManage;
                    row.querySelector('[data-column="zello"] input').disabled = !canManage;

                    row.querySelector('input[type="text"]').onchange = (e) => { const [nom, ...prenomParts] = e.target.value.split(' '); data[personIndex].nom = nom.toUpperCase(); data[personIndex].prenom = prenomParts.join(' '); };
                    row.querySelector('input[type="tel"]').onchange = (e) => { data[personIndex].tel = e.target.value.replace(/\s/g, ''); };
                    row.querySelector('[data-column="zello"] input').onchange = (e) => { data[personIndex].zello = e.target.checked; };
                    
                    row.children[2].appendChild(createBenevoleSelect(joursOptions, person.jours, personIndex, "jours", !canManage));
                    row.children[3].appendChild(createBenevoleSelect(lieuOptions, person.lieu, personIndex, "lieu", !canManage));
                    row.children[4].appendChild(createBenevoleSelect(fonctionOptions, person.fonction, personIndex, "fonction", !canManage));

                    const materielDiv = document.createElement('div');
                    materielDiv.className = 'flex flex-col space-y-1';
                    Object.keys(person.materiel).forEach(key => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center space-x-2';
                        itemDiv.innerHTML = `<span class="w-12 text-sm">${key}:</span>`;
                        const distribueCheckbox = document.createElement('input');
                        distribueCheckbox.type = 'checkbox';
                        distribueCheckbox.checked = person.materiel[key].distribue;
                        distribueCheckbox.disabled = !canManage && !isRadioManager;
                        distribueCheckbox.className = 'h-4 w-4 text-blue-600 rounded';
                        distribueCheckbox.onchange = () => { data[personIndex].materiel[key].distribue = distribueCheckbox.checked; updateMaterialSummary(); };
                        itemDiv.appendChild(distribueCheckbox);
                        const restitueCheckbox = document.createElement('input');
                        restitueCheckbox.type = 'checkbox';
                        restitueCheckbox.checked = person.materiel[key].restitue;
                        restitueCheckbox.disabled = !canManage && !isRadioManager;
                        restitueCheckbox.className = 'h-4 w-4 text-green-600 rounded';
                        restitueCheckbox.onchange = () => { data[personIndex].materiel[key].restitue = restitueCheckbox.checked; updateMaterialSummary(); };
                        itemDiv.appendChild(restitueCheckbox);
                        materielDiv.appendChild(itemDiv);
                    });
                    row.children[5].appendChild(materielDiv);
                    
                    const userInAccessList = utilisateursAutorises.find(u => String(u.tel || '').replace(/\s/g, '') === cleanTel);
                    const currentRole = userInAccessList ? userInAccessList.role : "Aucun acc√®s";
                    const roleSelect = createBenevoleSelect(rolesOptions, currentRole, personIndex, "role", !isSuperAdmin);
                    row.children[7].appendChild(roleSelect);
                    
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.edit-benevole-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        openBenevoleModal(e.target.dataset.id);
                    });
                });

                document.querySelectorAll('.delete-benevole-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const personId = e.target.dataset.id;
                        const person = data.find(p => p.id === personId);
                        const message = `√ätes-vous s√ªr de vouloir supprimer <strong>${person.prenom} ${person.nom}</strong> ?`;
                        showConfirmationModal(message, () => {
                            deleteDoc(doc(db, `artifacts/${appId}/public/data/benevoles`, personId));
                            const accessUser = utilisateursAutorises.find(u => String(u.tel || '').replace(/\s/g, '') === String(person.tel || '').replace(/\s/g, ''));
                            if (accessUser) {
                                deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, accessUser.id));
                            }
                        });
                    });
                });
                
                updateMaterialSummary();
                toggleTelColumn();
                setupBenevolePermissions();
            }

            function updateMaterialSummary() {
                let radiosDistribues = 0, radiosRestitues = 0, siffletsDistribues = 0, siffletsRestitues = 0;
                data.forEach(benevole => {
                    if (benevole.materiel.Radio?.distribue) radiosDistribues++;
                    if (benevole.materiel.Radio?.restitue) radiosRestitues++;
                    if (benevole.materiel.Sifflet?.distribue) siffletsDistribues++;
                    if (benevole.materiel.Sifflet?.restitue) siffletsRestitues++;
                });
                const radiosManquantes = radiosDistribues - radiosRestitues;
                const siffletsManquants = siffletsDistribues - siffletsRestitues;

                const radiosDistribueesEl = document.getElementById("radios-distribuees");
                if (!radiosDistribueesEl) return; // Prevent error if tab not rendered

                radiosDistribueesEl.textContent = radiosDistribues;
                document.getElementById("radios-restituees").textContent = radiosRestitues;
                document.getElementById("radios-manquantes").textContent = radiosManquantes;
                document.getElementById("sifflets-distribues").textContent = siffletsDistribues;
                document.getElementById("sifflets-restituees").textContent = siffletsRestitues;
                document.getElementById("sifflets-manquants").textContent = siffletsManquants;
                document.getElementById("appareils-manquants").textContent = radiosManquantes + siffletsManquants;
            }

            function toggleTelColumn(){
                const isHidden = toggleTelCheckbox.checked;
                const header = document.querySelector('th[data-column="tel"]');
                const cells = document.querySelectorAll('td[data-column="tel"]');
                if (!(isSuperAdmin || currentUser.role === 'Organisation')) return;
                if(header) header.style.display = isHidden ? "none" : "" ;
                cells.forEach(cell => { cell.style.display = isHidden ? "none": "" });
            }

            saveBtn.addEventListener('click', saveBenevolesData);
            addBenevoleBtn.addEventListener('click', () => openBenevoleModal());
            
            closeModalBtn.addEventListener('click', () => {
                document.getElementById('add-benevole-modal').style.display = 'none';
                editingBenevoleId = null;
            });
            
            addBenevoleForm.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = {
                    nom: document.getElementById("nom").value.toUpperCase(),
                    prenom: document.getElementById("prenom").value,
                    tel: document.getElementById("tel").value.replace(/\s/g, "") || "Non renseign√©",
                };

                if (editingBenevoleId) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/benevoles`, editingBenevoleId);
                    await updateDoc(docRef, {
                        nom: formData.nom,
                        prenom: formData.prenom,
                        tel: formData.tel,
                    });
                } else {
                    const newBenevole = {
                        ...formData,
                        jours: "Non renseign√©",
                        fonction: "√Ä d√©finir",
                        lieu: "√Ä d√©finir",
                        materiel: { Radio: { distribue: false, restitue: false }, Sifflet: { distribue: false, restitue: false }},
                        zello: false
                    };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/benevoles`), newBenevole);
                }
                
                document.getElementById('add-benevole-modal').style.display = "none";
                addBenevoleForm.reset();
                editingBenevoleId = null;
            });

            filterInput.addEventListener('input', renderBenevolesTable);
            filterFonction.addEventListener('change', renderBenevolesTable);
            filterLieu.addEventListener('change', renderBenevolesTable);
            filterMissingInfoCheckbox.addEventListener('change', renderBenevolesTable);
            toggleTelCheckbox.addEventListener('change', toggleTelColumn);

            // =========================
            // CONCURRENTS & RACE LOGIC
            // =========================
            let concurrents = [], startTime, updatedTime, difference, tInterval, running = false, currentManche = 1;
            let chronoInterval;

            const chronoDocRef = doc(db, `artifacts/${appId}/public/data/raceState`, 'chrono');
            
            const concurrentsCollection = collection(db, `artifacts/${appId}/public/data/concurrents`);
            onSnapshot(concurrentsCollection, (snapshot) => {
                concurrents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllConcurrentsView();
                populateConcurrentsDatalist();
                populateCompetitorsForAccessForm();
            });

            async function saveConcurrentsData() {
                const batch = writeBatch(db);
                concurrents.forEach(concurrent => {
                    const { id, ...concurData } = concurrent;
                    const docRef = doc(db, `artifacts/${appId}/public/data/concurrents`, id);
                    batch.update(docRef, concurData);
                });
                await batch.commit();
                saveConcurrentsMessage.textContent = "Modifications sauvegard√©es !";
                saveConcurrentsMessage.classList.add('show');
                setTimeout(() => { saveConcurrentsMessage.classList.remove('show'); }, 3000);
            }

            function renderAllConcurrentsView() {
                renderConcurrentsAdminTable();
                renderRaceTable();
            }

            function openConcurrentModal(concurrentId = null) {
                const modal = document.getElementById('add-concurrent-modal');
                const modalTitle = document.getElementById('concurrent-modal-title');
                const modalSubmitBtn = document.getElementById('concurrent-modal-submit-btn');
                
                addConcurrentFormModal.reset();

                if (concurrentId) {
                    editingConcurrentId = concurrentId;
                    const concurrent = concurrents.find(c => c.id === concurrentId);
                    modalTitle.textContent = "Modifier le Concurrent";
                    modalSubmitBtn.textContent = "Enregistrer";
                    document.getElementById('concurrent-nom-modal').value = concurrent.nom;
                    document.getElementById('concurrent-enfant-modal').checked = concurrent.isChild;
                } else {
                    editingConcurrentId = null;
                    modalTitle.textContent = "Ajouter un Concurrent";
                    modalSubmitBtn.textContent = "Ajouter";
                }
                modal.style.display = 'flex';
            }

            function renderConcurrentsAdminTable() {
                const filterValue = filterConcurrentsInput.value.toLowerCase();
                const filteredData = concurrents.filter(c => c.nom.toLowerCase().includes(filterValue));

                concurrentsAdminBody.innerHTML = "";
                filteredData.sort((a, b) => a.numero - b.numero).forEach(concurrent => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm">${concurrent.nom}</td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-id="${concurrent.id}" data-prop="isChild" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.isChild ? "checked" : ""}></td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-id="${concurrent.id}" data-prop="documents.dossier" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.documents.dossier ? "checked" : ""}></td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-id="${concurrent.id}" data-prop="documents.assurance" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.documents.assurance ? "checked" : ""}></td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <input type="checkbox" data-id="${concurrent.id}" data-prop="documents.paiement.ok" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.documents.paiement.ok ? "checked" : ""}>
                                <input type="text" placeholder="‚Ç¨" value="${concurrent.documents.paiement.montant}" data-id="${concurrent.id}" class="paiement-input text-sm">
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-id="${concurrent.id}" data-prop="equipements" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.equipements ? "checked" : ""}></td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex items-center gap-2 justify-center">
                                <button data-id="${concurrent.id}" class="edit-concurrent-btn text-blue-600 hover:text-blue-700 text-xs font-medium">Modifier</button>
                                <span class="text-gray-300">|</span>
                                <button data-id="${concurrent.id}" class="delete-concurrent-btn text-red-500 hover:text-red-700 text-xs font-medium">Suppr.</button>
                            </div>
                        </td>
                    `;
                
                    const select = document.createElement("select");
                    ["√Ä v√©rifier", "Conforme", "Non Conforme"].forEach(status => {
                        const option = document.createElement("option");
                        option.value = status;
                        option.textContent = status;
                        if (concurrent.controle === status) option.selected = true;
                        select.appendChild(option);
                    });
                
                    const getSelectClass = (status) => `controle-select rounded-md text-xs p-1 font-semibold controle-${status.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '')}`;
                    select.className = getSelectClass(concurrent.controle);
                
                    select.addEventListener("change", (event) => {
                        const targetConcurrent = concurrents.find(c => c.id === concurrent.id);
                        if (targetConcurrent) {
                            targetConcurrent.controle = event.target.value;
                            event.target.className = getSelectClass(event.target.value);
                        }
                    });
                
                    row.children[6].appendChild(select);
                    concurrentsAdminBody.appendChild(row);
                });
                
                document.querySelectorAll(".edit-concurrent-btn").forEach(btn => btn.addEventListener("click", event => {
                    openConcurrentModal(event.target.dataset.id);
                }));

                document.querySelectorAll(".delete-concurrent-btn").forEach(btn => btn.addEventListener("click", event => {
                    const docId = event.target.dataset.id;
                    const concurrent = concurrents.find(c => c.id === docId);
                    const message = `√ätes-vous s√ªr de vouloir supprimer le concurrent <strong>${concurrent.nom}</strong> ?`;
                    showConfirmationModal(message, () => {
                        deleteDoc(doc(db, `artifacts/${appId}/public/data/concurrents`, docId));
                    });
                }));
                
                document.querySelectorAll(".doc-check").forEach(checkbox => checkbox.addEventListener("change", event => {
                    const id = event.target.dataset.id;
                    const propPath = event.target.dataset.prop;
                    const targetConcurrent = concurrents.find(c => c.id === id);
                    if (targetConcurrent) {
                        const props = propPath.split('.');
                        let current = targetConcurrent;
                        for (let i = 0; i < props.length - 1; i++) {
                            current = current[props[i]];
                        }
                        current[props[props.length - 1]] = event.target.checked;
                    }
                }));
                
                document.querySelectorAll(".paiement-input").forEach(input => input.addEventListener("input", event => {
                    const id = event.target.dataset.id;
                    const targetConcurrent = concurrents.find(c => c.id === id);
                    if (targetConcurrent) {
                        targetConcurrent.documents.paiement.montant = event.target.value;
                    }
                }));
            }

            function formatTime(timeInMillis) {
                if (timeInMillis === null || timeInMillis === Infinity || typeof timeInMillis === 'undefined') return "-";
                const date = new Date(timeInMillis);
                const minutes = String(date.getUTCMinutes()).padStart(2, "0");
                const seconds = String(date.getUTCSeconds()).padStart(2, "0");
                const centiseconds = String(date.getUTCMilliseconds()).padStart(3, "0").slice(0, 2);
                return `${minutes}:${seconds}:${centiseconds}`;
            }

            function formatEcart(timeInMillis) {
                if (timeInMillis === null || timeInMillis === Infinity || typeof timeInMillis === 'undefined' || timeInMillis <= 0) {
                    return "-";
                }
                const date = new Date(timeInMillis);
                const minutes = String(date.getUTCMinutes()).padStart(2, "0");
                const seconds = String(date.getUTCSeconds()).padStart(2, "0");
                const centiseconds = String(date.getUTCMilliseconds()).padStart(3, "0").slice(0, 2);
                return `+${minutes}:${seconds}:${centiseconds}`;
            }

            function parseTimeToMillis(timeStr) {
                if (!timeStr || typeof timeStr !== 'string' || timeStr === '-') return null;
                const parts = timeStr.split(':');
                if (parts.length !== 3) return null;

                const minutes = parseInt(parts[0], 10);
                const seconds = parseInt(parts[1], 10);
                const centiseconds = parseInt(parts[2], 10);

                if (isNaN(minutes) || isNaN(seconds) || isNaN(centiseconds)) return null;

                return (minutes * 60 * 1000) + (seconds * 1000) + (centiseconds * 10);
            }
            
            function updateChronoDisplay(startTime) {
                chronoDisplay.textContent = formatTime(new Date().getTime() - startTime);
            }

            function updateChronoButtons(chronoData) {
                const chronoIsRunning = chronoData.running;
                const concurrentSelected = !!chronoData.selectedConcurrent;
                
                const canStart = isSuperAdmin || currentUser.role === 'Organisation' || currentUser.role === 'Chrono D√©part';
                const canStop = isSuperAdmin || currentUser.role === 'Organisation' || currentUser.role === 'Chrono Arriv√©e';
                const canReset = isSuperAdmin || currentUser.role === 'Organisation' || currentUser.role === 'Chrono D√©part';

                startBtn.disabled = !canStart || chronoIsRunning || !concurrentSelected;
                stopBtn.disabled = !canStop || !chronoIsRunning;
                resetBtn.disabled = !canReset || chronoIsRunning;
            }

            async function startChrono() {
                const chronoSnapshot = await getDoc(chronoDocRef);
                const chronoData = chronoSnapshot.data();
                const selectedConcurrentId = chronoData ? chronoData.selectedConcurrent : null;
                
                if (!selectedConcurrentId) {
                    showConfirmationModal("Veuillez s√©lectionner un concurrent avant de d√©marrer.", () => {}, "Aucun Concurrent S√©lectionn√©");
                    return;
                }

                await updateDoc(chronoDocRef, {
                    running: true,
                    startTime: new Date().getTime(),
                    currentConcurrent: selectedConcurrentId,
                    selectedConcurrent: null,
                    currentSpeedKmh: null // Reset speed for the new run
                });
            }

            async function stopChrono() {
                const chronoSnapshot = await getDoc(chronoDocRef);
                const chronoData = chronoSnapshot.data();
                if (!chronoData || !chronoData.running) return;

                const endTime = new Date().getTime();
                const startTime = chronoData.startTime;
                const difference = endTime - startTime;
                const concurrentId = chronoData.currentConcurrent;
                const concurrent = concurrents.find(c => c.id == concurrentId);
                const speed = chronoData.currentSpeedKmh || null;

                if (concurrent) {
                    // Calculer l'ancien meilleur temps perso (uniquement pour les manches de course)
                    const oldOfficialRuns = concurrent.manches.slice(2).filter(m => m && m.time !== null).map(m => m.time);
                    const oldBestTime = oldOfficialRuns.length > 0 ? Math.min(...oldOfficialRuns) : null;

                    const manches = concurrent.manches;
                    manches[currentManche - 1] = { time: difference, speed: speed };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/concurrents`, concurrent.id), { manches: manches });
                    
                    const allConcurrentsWithNewTime = JSON.parse(JSON.stringify(concurrents)); 
                    const concurrentToUpdate = allConcurrentsWithNewTime.find(c => c.id === concurrent.id);
                    if (concurrentToUpdate) {
                        concurrentToUpdate.manches = manches;
                    }

                    allConcurrentsWithNewTime.forEach(c => {
                        const officialRuns = c.manches.slice(2).filter(m => m && m.time !== null).map(m => m.time);
                        c.meilleurTemps = officialRuns.length > 0 ? Math.min(...officialRuns) : null;
                    });

                    const newBestTime = concurrentToUpdate ? concurrentToUpdate.meilleurTemps : null;

                    const ranked = allConcurrentsWithNewTime.filter(c => c.meilleurTemps !== null).sort((a, b) => a.meilleurTemps - b.meilleurTemps);
                    const rankIndex = ranked.findIndex(c => c.id === concurrent.id);
                    const rank = rankIndex !== -1 ? rankIndex + 1 : null;

                    let ecartPremier = null;
                    let ecartPrecedent = null;
                    let nomPrecedent = null;
                    
                    if (rank > 1 && ranked.length > 1) {
                        const tempsPremier = ranked[0].meilleurTemps;
                        ecartPremier = concurrentToUpdate.meilleurTemps - tempsPremier;

                        const concurrentPrecedent = ranked[rankIndex - 1];
                        ecartPrecedent = concurrentToUpdate.meilleurTemps - concurrentPrecedent.meilleurTemps;
                        nomPrecedent = concurrentPrecedent.nom;
                    }

                    let isNewBestRunEver = false;
                    const allRuns = allConcurrentsWithNewTime.flatMap(c => c.manches.filter(m => m && m.time !== null).map(m => m.time));

                    if (allRuns.length > 0) {
                        const bestRunEver = Math.min(...allRuns);
                        if (difference === bestRunEver && currentManche > 2) { // Only for official runs
                            isNewBestRunEver = true;
                        }
                    }

                    // Mettre √† jour la base de donn√©es
                    await updateDoc(chronoDocRef, {
                        running: false,
                        startTime: null,
                        currentConcurrent: null,
                        selectedConcurrent: null,
                        lastRecordedTime: {
                            nom: concurrent.nom,
                            time: difference,
                            speed: speed,
                            rank: rank,
                            ecartPremier: ecartPremier,
                            ecartPrecedent: ecartPrecedent,
                            nomPrecedent: nomPrecedent,
                            isNewBestRunEver: isNewBestRunEver
                        }
                    });

                    // Afficher la modale de confirmation
                    document.getElementById('time-confirm-concurrent').textContent = concurrent.nom;
                    
                    const mancheText = currentManche <= 2 ? `Descente test ${currentManche}` : `Course ${currentManche - 2}`;
                    document.getElementById('time-confirm-manche').textContent = mancheText;

                    document.getElementById('time-confirm-time').textContent = formatTime(difference);

                    const personalBestEl = document.getElementById('time-confirm-personal-best');
                    if (currentManche > 2) { // Afficher l'info "record perso" uniquement pour les manches de course
                        personalBestEl.style.display = 'block';
                        if (newBestTime === difference) {
                            personalBestEl.innerHTML = `üèÜ <span class="text-green-400">Nouveau record personnel !</span>`;
                        } else if (oldBestTime) {
                            const diffWithBest = difference - oldBestTime;
                             personalBestEl.innerHTML = `Record perso : ${formatTime(oldBestTime)} (${formatEcart(diffWithBest)})`;
                        } else {
                            personalBestEl.innerHTML = `Premier temps de course officiel.`;
                        }
                    } else {
                        personalBestEl.style.display = 'none';
                    }

                    // Phrase pour la vitesse
                    const speedEl = document.getElementById('time-confirm-speed');
                    if (speed) {
                        speedEl.innerHTML = `Vous avez √©t√© flash√© √† : <strong class="text-white font-bold">${speed} km/h</strong>`;
                        speedEl.style.display = 'block';
                    } else {
                        speedEl.style.display = 'none';
                    }

                    // Phrase pour la position
                    const rankEl = document.getElementById('time-confirm-rank');
                    if (rank) {
                        rankEl.textContent = `Position dans la course : ${rank}e`;
                        rankEl.style.display = 'block';
                    } else {
                        rankEl.style.display = 'none';
                    }
                    
                    // Phrase pour l'√©cart avec le premier
                    const ecartPremierEl = document.getElementById('time-confirm-ecart-premier');
                    if (ecartPremier) {
                        ecartPremierEl.textContent = `√âcart avec le premier : ${formatEcart(ecartPremier)}`;
                         ecartPremierEl.style.display = 'block';
                    } else {
                         ecartPremierEl.style.display = 'none';
                    }
                    
                    // Phrase pour l'√©cart avec le pr√©c√©dent
                    const ecartPrecedentEl = document.getElementById('time-confirm-ecart-precedent');
                    if (ecartPrecedent && nomPrecedent) {
                        ecartPrecedentEl.innerHTML = `Pr√©c√©d√© par <strong>${nomPrecedent}</strong> (√©cart : ${formatEcart(ecartPrecedent)})`;
                         ecartPrecedentEl.style.display = 'block';
                    } else {
                         ecartPrecedentEl.style.display = 'none';
                    }

                    document.getElementById('new-record-banner').style.display = isNewBestRunEver ? 'block' : 'none';
                    
                    timeConfirmationModal.style.display = 'flex';

                } else {
                    await updateDoc(chronoDocRef, { running: false, startTime: null, currentConcurrent: null, selectedConcurrent: null });
                }
            }

            async function resetChrono() {
                await updateDoc(chronoDocRef, { running: false, startTime: null, currentConcurrent: null, selectedConcurrent: null, currentSpeedKmh: null });
            }

            async function startNewHeat() {
                const nextManche = currentManche + 1;
                if (nextManche <= 8) {
                     const message = `√ätes-vous s√ªr de vouloir passer √† la manche <strong>${nextManche <= 2 ? 'Descente test ' + nextManche : 'Course ' + (nextManche - 2)}</strong> ?`;
                    showConfirmationModal(message, async () => {
                        await updateDoc(chronoDocRef, { currentManche: nextManche });
                    }, "Passer √† la manche suivante ?");
                } else {
                    showConfirmationModal("Nombre maximum de manches atteint.", () => {}, "Information");
                }
            }

            async function resetRace() {
                if(isSuperAdmin) {
                    showConfirmationModal("ACTION IRR√âVERSIBLE<br><br>√ätes-vous s√ªr de vouloir r√©initialiser <strong>TOUTE</strong> la course ? Tous les temps seront effac√©s.", async () => {
                        const batch = writeBatch(db);
                        concurrents.forEach(c => {
                            const docRef = doc(db, `artifacts/${appId}/public/data/concurrents`, c.id);
                            batch.update(docRef, { 
                                manches: new Array(8).fill(null), 
                                meilleurTemps: null, 
                                tempsTotal: null 
                            });
                        });
                        await batch.commit();
                        await updateDoc(chronoDocRef, { currentManche: 1 });
                    });
                }
            }

            function renderRaceTable() {
                const tableHead = document.getElementById('race-table-head');
                const tableBody = document.getElementById('race-table-body');
                if (!tableHead || !tableBody) return;
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';

                const filterValue = filterRaceInput.value.toLowerCase();
                let dataToRender = concurrents.filter(c => c.nom.toLowerCase().includes(filterValue));

                dataToRender.forEach(c => {
                    const officialRuns = c.manches.slice(2).filter(m => m && m.time !== null).map(m => m.time);
                    c.meilleurTemps = officialRuns.length > 0 ? Math.min(...officialRuns) : null;
                });

                dataToRender.sort((a, b) => {
                    if (a.meilleurTemps === null) return 1;
                    if (b.meilleurTemps === null) return -1;
                    return a.meilleurTemps - b.meilleurTemps;
                });
                
                const tempsPremier = dataToRender.length > 0 && dataToRender[0].meilleurTemps !== null ? dataToRender[0].meilleurTemps : null;

                const headers = ['Cl.', 'Concurrent'];
                const mancheHeaders = Array.from({ length: currentManche }, (_, i) => i < 2 ? `Test ${i + 1}` : `Course ${i - 1}`);
                headers.push(...mancheHeaders, 'Meilleur Temps', '√âcart 1er');
                
                let headerHTML = '<tr>';
                headers.forEach((h, i) => {
                    const isCurrentMancheCol = (i === (2 + currentManche - 1));
                    headerHTML += `<th id="${isCurrentMancheCol ? 'current-heat-header' : ''}" class="px-4 py-3 text-left text-xs font-bold uppercase">${h}</th>`;
                });
                headerHTML += '</tr>';
                tableHead.innerHTML = headerHTML;

                const canEditTimes = isSuperAdmin || ['Organisation', 'Chrono D√©part', 'Chrono Arriv√©e'].includes(currentUser.role);

                dataToRender.forEach((concurrent, index) => {
                    const row = tableBody.insertRow();
                    const classement = concurrent.meilleurTemps !== null ? index + 1 : "-";
                    let classementHTML = classement;
                    if (classement === 1) classementHTML = `ü•á ${classement}`;
                    else if (classement === 2) classementHTML = `ü•à ${classement}`;
                    else if (classement === 3) classementHTML = `ü•â ${classement}`;

                    const ecartPremier = tempsPremier !== null && concurrent.meilleurTemps !== null ? concurrent.meilleurTemps - tempsPremier : null;

                    let rowHTML = `
                        <td class="px-4 py-3 text-sm font-bold text-center">${classementHTML}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="font-semibold">${concurrent.nom}</span>
                            ${concurrent.isChild ? '<span title="Concurrent Enfant">üßí</span>' : ''}
                        </td>
                    `;
                    
                    for (let i = 0; i < currentManche; i++) {
                        const mancheData = concurrent.manches[i];
                        const timeValue = mancheData ? formatTime(mancheData.time) : "-";
                        const speedValue = mancheData && mancheData.speed ? `<span class="block text-xs text-gray-500 font-normal">${mancheData.speed} km/h</span>` : '';
                        rowHTML += `<td class="px-4 py-3 text-sm text-center">
                                        <input type="text" class="time-input text-center" value="${timeValue}" data-concurrent-id="${concurrent.id}" data-manche-index="${i}" ${canEditTimes ? '' : 'disabled'}>
                                        ${speedValue}
                                    </td>`;
                    }
                    
                    rowHTML += `
                        <td class="px-4 py-3 text-sm font-semibold text-blue-600">${formatTime(concurrent.meilleurTemps)}</td>
                        <td class="px-4 py-3 text-sm text-red-500">${formatEcart(ecartPremier)}</td>
                    `;
                    
                    row.innerHTML = rowHTML;

                    row.querySelectorAll('.time-input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const newTimeMillis = parseTimeToMillis(e.target.value);
                            const concurrentId = e.target.dataset.concurrentId;
                            const mancheIndex = parseInt(e.target.dataset.mancheIndex, 10);
                            
                            const targetConcurrent = concurrents.find(c => c.id === concurrentId);
                            if (targetConcurrent) {
                                // Find the original speed value for that run, if it exists
                                const originalSpeed = targetConcurrent.manches[mancheIndex] ? targetConcurrent.manches[mancheIndex].speed : null;
                                targetConcurrent.manches[mancheIndex] = { time: newTimeMillis, speed: originalSpeed };
                                saveConcurrentsData().then(renderRaceTable);
                            }
                        });
                    });
                });

                const currentHeatHeader = document.getElementById('current-heat-header');
                if (currentHeatHeader) {
                    currentHeatHeader.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            }

            function startCompetitorLogic(myId) {
                const chronoDocRef = doc(db, `artifacts/${appId}/public/data/raceState`, 'chrono');
                const concurrentsCollection = collection(db, `artifacts/${appId}/public/data/concurrents`);

                onSnapshot(concurrentsCollection, (snapshot) => {
                    const concurrents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Listen to chrono changes as well
                    onSnapshot(chronoDocRef, (chronoDoc) => {
                        const chronoData = chronoDoc.data();
                        renderCompetitorDashboard(myId, concurrents, chronoData);
                    });
                });
            }

            function renderCompetitorDashboard(myId, allConcurrents, chronoData) {
                const me = allConcurrents.find(c => c.id === myId);
                if (!me) return;
                
                // Re-select elements inside the function to ensure they exist
                const nameEl = document.getElementById('competitor-dashboard-name');
                const bestTimeEl = document.getElementById('competitor-dashboard-best-time');
                const rankEl = document.getElementById('competitor-dashboard-rank');
                const gapEl = document.getElementById('competitor-dashboard-gap');
                const rankingBody = document.getElementById('competitor-dashboard-focused-ranking');
                const timesTableHead = document.getElementById('competitor-dashboard-times-head');
                const timesTableBody = document.getElementById('competitor-dashboard-times-body');
                
                // Defensive check
                if (!nameEl || !bestTimeEl || !rankEl || !gapEl || !rankingBody || !timesTableHead || !timesTableBody) {
                    console.error("One or more competitor dashboard elements are missing from the DOM.");
                    return;
                }

                allConcurrents.forEach(c => {
                    const officialRuns = c.manches.slice(2).filter(m => m && m.time !== null).map(m => m.time);
                    c.meilleurTemps = officialRuns.length > 0 ? Math.min(...officialRuns) : null;
                });

                const ranked = allConcurrents.filter(c => c.meilleurTemps !== null).sort((a, b) => a.meilleurTemps - b.meilleurTemps);
                const myRankIndex = ranked.findIndex(c => c.id === myId);
                const myRank = myRankIndex !== -1 ? myRankIndex + 1 : "-";
                const tempsPremier = ranked.length > 0 ? ranked[0].meilleurTemps : null;
                const myGap = (tempsPremier !== null && me.meilleurTemps !== null && myRank !== 1) ? me.meilleurTemps - tempsPremier : null;

                nameEl.textContent = me.nom;
                bestTimeEl.textContent = formatTime(me.meilleurTemps);
                rankEl.textContent = myRank;
                gapEl.textContent = formatEcart(myGap);
                
                rankingBody.innerHTML = '';
                const start = Math.max(0, myRankIndex - 1);
                const end = Math.min(ranked.length, myRankIndex + 2);
                for (let i = start; i < end; i++) {
                    const c = ranked[i];
                    const row = document.createElement('tr');
                    row.className = c.id === myId ? 'bg-blue-100 font-bold' : '';
                    row.innerHTML = `
                        <td class="p-3">${i + 1}</td>
                        <td class="p-3">${c.nom}</td>
                        <td class="p-3 font-mono">${formatTime(c.meilleurTemps)}</td>
                    `;
                    rankingBody.appendChild(row);
                }

                const mancheHeaders = Array.from({ length: chronoData.currentManche }, (_, i) => i < 2 ? `Test ${i + 1}` : `Course ${i - 1}`);
                timesTableHead.innerHTML = mancheHeaders.map(h => `<th class="p-3 text-left text-xs font-bold uppercase">${h}</th>`).join('');
                
                const timesRow = document.createElement('tr');
                timesRow.innerHTML = me.manches.slice(0, chronoData.currentManche).map(manche => {
                    const timeDisplay = manche ? formatTime(manche.time) : '-';
                    const speedDisplay = manche && manche.speed ? `<span class="block text-xs text-gray-500 font-normal">${manche.speed} km/h</span>` : '';
                    return `<td class="p-3 font-mono">${timeDisplay}${speedDisplay}</td>`;
                }).join('');
                timesTableBody.innerHTML = '';
                timesTableBody.appendChild(timesRow);
            }

            function showTutorialModalIfNeeded() {
                const tutorialShown = localStorage.getItem('tutorialShown');
                if (!tutorialShown) {
                    const modal = document.getElementById('tutorial-modal');
                    modal.style.display = 'flex';

                    document.getElementById('show-tutorial-btn').onclick = () => {
                        modal.style.display = 'none';
                        displayTutorialForRole(currentUser.role);
                        localStorage.setItem('tutorialShown', 'true');
                    };
                    document.getElementById('close-tutorial-btn').onclick = () => {
                        modal.style.display = 'none';
                        localStorage.setItem('tutorialShown', 'true');
                    };
                }
            }

            function displayTutorialForRole(role) {
                let title = "Tutoriel";
                let content = `<div class="text-left space-y-3">`;
                
                switch(role) {
                    case 'Super Admin':
                    case 'Organisation':
                        title = "Guide pour l'Organisation";
                        content += `
                            <p>En tant qu'<strong>Organisateur</strong>, vous avez acc√®s √† toutes les fonctionnalit√©s :</p>
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Chrono :</strong> G√©rez le d√©part et l'arriv√©e, enregistrez les temps et passez aux manches suivantes.</li>
                                <li><strong>Radar :</strong> Saisissez la vitesse d'un concurrent en piste.</li>
                                <li><strong>Concurrents :</strong> Affichez la liste des concurrents, modifiez leurs informations et validez les documents.</li>
                                <li><strong>B√©n√©voles :</strong> G√©rez la liste des b√©n√©voles, leurs affectations et le mat√©riel distribu√©.</li>
                                <li><strong>Administration :</strong> (Super Admin uniquement) G√©rez les acc√®s √† l'application et effectuez des r√©initialisations de donn√©es.</li>
                            </ul>
                            <p class="font-semibold mt-4">N'oubliez pas de sauvegarder apr√®s chaque modification dans les tableaux !</p>
                        `;
                        break;
                    case 'Chrono D√©part':
                         title = "Guide pour le Chrono D√©part";
                         content += `
                            <p>Votre r√¥le est crucial pour le bon d√©roulement de la course :</p>
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Onglet Chrono :</strong> C'est votre principal outil.</li>
                                <li><strong>S√©lection du concurrent :</strong> Avant le d√©part, tapez le nom du concurrent dans la barre de recherche et s√©lectionnez-le. Son nom doit s'afficher en dessous.</li>
                                <li><strong>Bouton D√©marrer :</strong> Une fois le concurrent pr√™t et s√©lectionn√©, cliquez sur <strong>D√©marrer</strong>. Le bouton deviendra inaccessible et le chronom√®tre se lancera pour tout le monde.</li>
                                <li>Le p√¥le <strong>Chrono Arriv√©e</strong> prendra le relais pour arr√™ter le temps.</li>
                            </ul>
                        `;
                        break;
                    case 'Chrono Arriv√©e':
                        title = "Guide pour le Chrono Arriv√©e";
                        content += `
                            <p>Votre r√¥le est de finaliser chaque course :</p>
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Onglet Chrono :</strong> Surveillez cet onglet.</li>
                                <li><strong>Chronom√®tre en cours :</strong> Quand un concurrent est en piste, le chronom√®tre tourne. Le bouton <strong>Arr√™ter</strong> est alors accessible pour vous.</li>
                                <li><strong>Ligne d'arriv√©e :</strong> D√®s que la caisse √† savon franchit la ligne, cliquez sur <strong>Arr√™ter et Enregistrer</strong>.</li>
                                <li>Une fen√™tre de confirmation s'affichera avec le temps, le classement et les √©carts. Le temps est automatiquement sauvegard√© pour tout le monde.</li>
                            </ul>
                        `;
                        break;
                    case 'Saisie Radar':
                        title = "Guide pour la Saisie Radar";
                        content += `
                            <p>Votre mission est de mesurer la vitesse de pointe :</p>
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Onglet Radar :</strong> Allez sur cet onglet.</li>
                                <li><strong>Concurrent en piste :</strong> Le nom du concurrent en course s'affiche en haut.</li>
                                <li><strong>Saisie :</strong> D√®s que vous avez la vitesse sur votre appareil, tapez-la dans le champ num√©rique.</li>
                                <li><strong>Enregistrer :</strong> Cliquez sur <strong>Enregistrer Vitesse</strong>. La vitesse sera automatiquement associ√©e √† la descente en cours du concurrent.</li>
                            </ul>
                        `;
                        break;
                    default:
                        content += "<p>Votre r√¥le vous donne un acc√®s en lecture seule √† la plupart des informations de la course. Vous pouvez suivre les temps en direct et consulter les classements.</p>";
                }
                
                content += "</div>";
                showConfirmationModal(content, () => {}, title);
            }

            // --- D√©marrage de l'application ---
            onSnapshot(chronoDocRef, (doc) => {
                const chronoData = doc.data();
                if (chronoData) {
                    currentManche = chronoData.currentManche || 1;
                    const mancheText = currentManche <= 2 ? `Descente test ${currentManche}` : `Course ${currentManche - 2}`;
                    currentMancheDisplay.textContent = `Manche Actuelle : ${mancheText}`;

                    if (chronoData.running) {
                        if (!chronoInterval) {
                            chronoInterval = setInterval(() => updateChronoDisplay(chronoData.startTime), 50);
                        }
                    } else {
                        clearInterval(chronoInterval);
                        chronoInterval = null;
                        chronoDisplay.textContent = "00:00:00";
                    }

                    if (chronoData.selectedConcurrent) {
                        const selected = concurrents.find(c => c.id === chronoData.selectedConcurrent);
                        selectedConcurrentDisplay.textContent = selected ? selected.nom : 'Concurrent non trouv√©';
                    } else if (chronoData.currentConcurrent) {
                         const current = concurrents.find(c => c.id === chronoData.currentConcurrent);
                        selectedConcurrentDisplay.textContent = current ? `EN PISTE : ${current.nom}` : '';
                    } else {
                        selectedConcurrentDisplay.textContent = '';
                    }

                    document.getElementById('radar-concurrent-display').textContent = chronoData.currentConcurrent ? concurrents.find(c => c.id === chronoData.currentConcurrent)?.nom : 'Aucun concurrent en piste';


                    updateChronoButtons(chronoData);
                    renderRaceTable(); // Re-render table on manche change
                    
                    // Live display update
                    if (currentDisplayType === 'live' && chronoData.lastRecordedTime) {
                        renderDisplayContent('live', { lastRecordedTime: chronoData.lastRecordedTime });
                    }
                }
            });

            chronoSearchInput.addEventListener('change', async () => {
                const selectedName = chronoSearchInput.value;
                const selectedConcurrent = concurrents.find(c => c.nom === selectedName);
                if (selectedConcurrent) {
                    await updateDoc(chronoDocRef, { selectedConcurrent: selectedConcurrent.id });
                } else {
                    await updateDoc(chronoDocRef, { selectedConcurrent: null });
                }
                chronoSearchInput.value = '';
            });

            startBtn.addEventListener('click', startChrono);
            stopBtn.addEventListener('click', stopChrono);
            resetBtn.addEventListener('click', resetChrono);
            newHeatBtn.addEventListener('click', startNewHeat);
            resetRaceBtn.addEventListener('click', resetRace);
            saveConcurrentsBtn.addEventListener('click', saveConcurrentsData);
            closeConcurrentModalBtn.addEventListener('click', () => {
                addConcurrentModal.style.display = 'none';
                editingConcurrentId = null;
            });
            addConcurrentBtn.addEventListener('click', () => openConcurrentModal());
            filterConcurrentsInput.addEventListener('input', renderConcurrentsAdminTable);
            filterRaceInput.addEventListener('input', renderRaceTable);

            addConcurrentFormModal.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nom = document.getElementById('concurrent-nom-modal').value;
                const isChild = document.getElementById('concurrent-enfant-modal').checked;
                
                if (editingConcurrentId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/concurrents`, editingConcurrentId), { nom, isChild });
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/concurrents`), {
                        nom: nom,
                        isChild: isChild,
                        numero: concurrents.length + 1,
                        documents: { dossier: false, assurance: false, paiement: { ok: false, montant: "25" } },
                        equipements: false,
                        controle: "√Ä v√©rifier",
                        manches: new Array(8).fill(null),
                        meilleurTemps: null,
                        tempsTotal: null,
                    });
                }
                
                addConcurrentModal.style.display = 'none';
                addConcurrentFormModal.reset();
                editingConcurrentId = null;
            });

            // =========================
            // ADMIN LOGIC
            // =========================
            function setupBenevolePermissions() {
                const canManage = isSuperAdmin || currentUser.role === 'Organisation';
                const isRadioManager = currentUser.role === 'Responsable Radio';

                document.getElementById('add-benevole-btn').style.display = canManage ? '' : 'none';
                document.getElementById('save-btn').style.display = canManage || isRadioManager ? '' : 'none';
                document.getElementById('missing-info-container').style.display = canManage ? 'flex' : 'none';

                if (isSuperAdmin) document.getElementById('tab-admin').style.display = 'flex';
                if(canManage) document.getElementById('toggleTel').parentElement.style.display = 'flex'; else document.getElementById('toggleTel').parentElement.style.display = 'none';

                const canManageConcurrents = isSuperAdmin || currentUser.role === 'Organisation';
                addConcurrentBtn.style.display = canManageConcurrents ? '' : 'none';
                saveConcurrentsBtn.style.display = canManageConcurrents ? '' : 'none';

                const canManageRace = isSuperAdmin || currentUser.role === 'Organisation';
                resetRaceBtn.style.display = canManageRace ? '' : 'none';
                newHeatBtn.style.display = canManageRace ? '' : 'none';

                const canImportExport = isSuperAdmin || currentUser.role === 'Organisation';
                importBtn.style.display = canImportExport ? '' : 'none';
                exportBtn.style.display = canImportExport ? '' : 'none';
            }

            function populateConcurrentsDatalist() {
                concurrentsDatalist.innerHTML = '';
                concurrents.sort((a,b) => a.nom.localeCompare(b.nom)).forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.nom;
                    concurrentsDatalist.appendChild(option);
                });
            }

            function populateCompetitorsForAccessForm() {
                const select = document.getElementById('user-competitor-select');
                select.innerHTML = '<option value="">-- S√©lectionner un concurrent --</option>';
                concurrents.sort((a, b) => a.nom.localeCompare(b.nom)).forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.nom}</option>`;
                });
            }

            // =========================
            // PODIUMS / GRILLE DE D√âPART
            // =========================
            function renderGrid(manche) {
                const gridTitle = document.getElementById('grid-title');
                const gridTable = document.querySelector('#grid-table');
                gridTable.innerHTML = '';
                let concurrentsForGrid = [...concurrents];

                if (manche === 1) {
                    gridTitle.textContent = 'Grille de D√©part - Manche 1 (Al√©atoire)';
                    concurrentsForGrid.sort(() => Math.random() - 0.5);
                } else {
                    gridTitle.textContent = `Grille de D√©part - Manche ${manche <= 2 ? 'Test ' + manche : 'Course ' + (manche - 2)}`;
                    concurrentsForGrid.sort((a, b) => {
                        const aTime = a.manches[manche - 2]?.time;
                        const bTime = b.manches[manche - 2]?.time;
                        if (aTime === null || typeof aTime === 'undefined') return 1;
                        if (bTime === null || typeof bTime === 'undefined') return -1;
                        return aTime - bTime;
                    });
                }
                
                gridTable.innerHTML = `
                    <thead class="bg-gray-200 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold uppercase">Ordre D√©part</th>
                            <th class="px-4 py-3 text-left text-xs font-bold uppercase">Concurrent</th>
                        </tr>
                    </thead>
                    <tbody id="grid-table-body" class="bg-white divide-y divide-gray-200">
                    ${concurrentsForGrid.map((c, i) => `
                        <tr>
                            <td class="px-4 py-3 text-sm font-bold">${i + 1}</td>
                            <td class="px-4 py-3 text-sm">${c.nom} ${c.isChild ? 'üßí' : ''}</td>
                        </tr>
                    `).join('')}
                    </tbody>
                `;
                gridScreen.style.display = 'flex';
            }

            currentHeatBtn.addEventListener('click', () => renderGrid(currentManche));
            previousHeatBtn.addEventListener('click', () => { if(currentManche > 1) renderGrid(currentManche - 1); });
            closeGridBtn.addEventListener('click', () => { gridScreen.style.display = 'none'; });
            
            podiumFastestLapBtn.addEventListener('click', () => showDisplayScreen('podium-speed'));
            podiumGrandPrixBtn.addEventListener('click', () => showDisplayScreen('podium-gp'));

            // =========================
            // NAVIGATION & UI
            // =========================
            const tabs = {
                'tab-race': 'content-race', 'tab-radar': 'content-radar', 'tab-podium': 'content-podium', 'tab-display': 'content-display', 'tab-concurrents': 'content-concurrents', 'tab-dashboard': 'content-dashboard', 'tab-admin': 'content-admin'
            };
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                    document.getElementById(tabs[button.id]).style.display = 'block';
                });
            });

            document.querySelectorAll('.credits-btn-trigger').forEach(btn => {
                btn.addEventListener('click', () => { creditsModal.style.display = 'flex' });
            });
            closeCreditsModalBtn.addEventListener('click', () => { creditsModal.style.display = 'none' });

            closeTimeConfirmModalBtn.addEventListener('click', () => timeConfirmationModal.style.display = 'none');

            document.getElementById('show-access-btn').addEventListener('click', (e) => {
                document.querySelectorAll('.admin-sub-tab-button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('admin-access-section').style.display = 'block';
                document.getElementById('admin-reset-section').style.display = 'none';
            });
            document.getElementById('show-reset-btn').addEventListener('click', (e) => {
                document.querySelectorAll('.admin-sub-tab-button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('admin-access-section').style.display = 'none';
                document.getElementById('admin-reset-section').style.display = 'block';
            });
        }

        // =========================
        // D√©marrage de la logique sp√©cifique au concurrent
        // =========================
        function startCompetitorLogic(myId) {
            const chronoDocRef = doc(db, `artifacts/${appId}/public/data/raceState`, 'chrono');
            const concurrentsCollection = collection(db, `artifacts/${appId}/public/data/concurrents`);

            onSnapshot(concurrentsCollection, (snapshot) => {
                const concurrents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Listen to chrono changes as well
                onSnapshot(chronoDocRef, (chronoDoc) => {
                    const chronoData = chronoDoc.data();
                    renderCompetitorDashboard(myId, concurrents, chronoData);
                });
            });
        }

        function renderCompetitorDashboard(myId, allConcurrents, chronoData) {
            const me = allConcurrents.find(c => c.id === myId);
            if (!me) return;
            
            // Re-select elements inside the function to ensure they exist
            const nameEl = document.getElementById('competitor-dashboard-name');
            const bestTimeEl = document.getElementById('competitor-dashboard-best-time');
            const rankEl = document.getElementById('competitor-dashboard-rank');
            const gapEl = document.getElementById('competitor-dashboard-gap');
            const rankingBody = document.getElementById('competitor-dashboard-focused-ranking');
            const timesTableHead = document.getElementById('competitor-dashboard-times-head');
            const timesTableBody = document.getElementById('competitor-dashboard-times-body');
            
            // Defensive check
            if (!nameEl || !bestTimeEl || !rankEl || !gapEl || !rankingBody || !timesTableHead || !timesTableBody) {
                console.error("One or more competitor dashboard elements are missing from the DOM.");
                return;
            }

            allConcurrents.forEach(c => {
                const officialRuns = c.manches.slice(2).filter(m => m && m.time !== null).map(m => m.time);
                c.meilleurTemps = officialRuns.length > 0 ? Math.min(...officialRuns) : null;
            });

            const ranked = allConcurrents.filter(c => c.meilleurTemps !== null).sort((a, b) => a.meilleurTemps - b.meilleurTemps);
            const myRankIndex = ranked.findIndex(c => c.id === myId);
            const myRank = myRankIndex !== -1 ? myRankIndex + 1 : "-";
            const tempsPremier = ranked.length > 0 ? ranked[0].meilleurTemps : null;
            const myGap = (tempsPremier !== null && me.meilleurTemps !== null && myRank !== 1) ? me.meilleurTemps - tempsPremier : null;

            nameEl.textContent = me.nom;
            bestTimeEl.textContent = formatTime(me.meilleurTemps);
            rankEl.textContent = myRank;
            gapEl.textContent = formatEcart(myGap);
            
            rankingBody.innerHTML = '';
            const start = Math.max(0, myRankIndex - 1);
            const end = Math.min(ranked.length, myRankIndex + 2);
            for (let i = start; i < end; i++) {
                const c = ranked[i];
                const row = document.createElement('tr');
                row.className = c.id === myId ? 'bg-blue-100 font-bold' : '';
                row.innerHTML = `
                    <td class="p-3">${i + 1}</td>
                    <td class="p-3">${c.nom}</td>
                    <td class="p-3 font-mono">${formatTime(c.meilleurTemps)}</td>
                `;
                rankingBody.appendChild(row);
            }

            const mancheHeaders = Array.from({ length: chronoData.currentManche }, (_, i) => i < 2 ? `Test ${i + 1}` : `Course ${i - 1}`);
            timesTableHead.innerHTML = mancheHeaders.map(h => `<th class="p-3 text-left text-xs font-bold uppercase">${h}</th>`).join('');
            
            const timesRow = document.createElement('tr');
            timesRow.innerHTML = me.manches.slice(0, chronoData.currentManche).map(manche => {
                const timeDisplay = manche ? formatTime(manche.time) : '-';
                const speedDisplay = manche && manche.speed ? `<span class="block text-xs text-gray-500 font-normal">${manche.speed} km/h</span>` : '';
                return `<td class="p-3 font-mono">${timeDisplay}${speedDisplay}</td>`;
            }).join('');
            timesTableBody.innerHTML = '';
            timesTableBody.appendChild(timesRow);
        }

        function showTutorialModalIfNeeded() {
            const tutorialShown = localStorage.getItem('tutorialShown');
            if (!tutorialShown) {
                const modal = document.getElementById('tutorial-modal');
                modal.style.display = 'flex';

                document.getElementById('show-tutorial-btn').onclick = () => {
                    modal.style.display = 'none';
                    displayTutorialForRole(currentUser.role);
                    localStorage.setItem('tutorialShown', 'true');
                };
                document.getElementById('close-tutorial-btn').onclick = () => {
                    modal.style.display = 'none';
                    localStorage.setItem('tutorialShown', 'true');
                };
            }
        }

        function displayTutorialForRole(role) {
            let title = "Tutoriel";
            let content = `<div class="text-left space-y-3">`;
            
            switch(role) {
                case 'Super Admin':
                case 'Organisation':
                    title = "Guide pour l'Organisation";
                    content += `
                        <p>En tant qu'<strong>Organisateur</strong>, vous avez acc√®s √† toutes les fonctionnalit√©s :</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Chrono :</strong> G√©rez le d√©part et l'arriv√©e, enregistrez les temps et passez aux manches suivantes.</li>
                            <li><strong>Radar :</strong> Saisissez la vitesse d'un concurrent en piste.</li>
                            <li><strong>Concurrents :</strong> Affichez la liste des concurrents, modifiez leurs informations et validez les documents.</li>
                            <li><strong>B√©n√©voles :</strong> G√©rez la liste des b√©n√©voles, leurs affectations et le mat√©riel distribu√©.</li>
                            <li><strong>Administration :</strong> (Super Admin uniquement) G√©rez les acc√®s √† l'application et effectuez des r√©initialisations de donn√©es.</li>
                        </ul>
                        <p class="font-semibold mt-4">N'oubliez pas de sauvegarder apr√®s chaque modification dans les tableaux !</p>
                    `;
                    break;
                case 'Chrono D√©part':
                     title = "Guide pour le Chrono D√©part";
                     content += `
                        <p>Votre r√¥le est crucial pour le bon d√©roulement de la course :</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Onglet Chrono :</strong> C'est votre principal outil.</li>
                            <li><strong>S√©lection du concurrent :</strong> Avant le d√©part, tapez le nom du concurrent dans la barre de recherche et s√©lectionnez-le. Son nom doit s'afficher en dessous.</li>
                            <li><strong>Bouton D√©marrer :</strong> Une fois le concurrent pr√™t et s√©lectionn√©, cliquez sur <strong>D√©marrer</strong>. Le bouton deviendra inaccessible et le chronom√®tre se lancera pour tout le monde.</li>
                            <li>Le p√¥le <strong>Chrono Arriv√©e</strong> prendra le relais pour arr√™ter le temps.</li>
                        </ul>
                    `;
                    break;
                case 'Chrono Arriv√©e':
                    title = "Guide pour le Chrono Arriv√©e";
                    content += `
                        <p>Votre r√¥le est de finaliser chaque course :</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Onglet Chrono :</strong> Surveillez cet onglet.</li>
                            <li><strong>Chronom√®tre en cours :</strong> Quand un concurrent est en piste, le chronom√®tre tourne. Le bouton <strong>Arr√™ter</strong> est alors accessible pour vous.</li>
                            <li><strong>Ligne d'arriv√©e :</strong> D√®s que la caisse √† savon franchit la ligne, cliquez sur <strong>Arr√™ter et Enregistrer</strong>.</li>
                            <li>Une fen√™tre de confirmation s'affichera avec le temps, le classement et les √©carts. Le temps est automatiquement sauvegard√© pour tout le monde.</li>
                        </ul>
                    `;
                    break;
                case 'Saisie Radar':
                    title = "Guide pour la Saisie Radar";
                    content += `
                        <p>Votre mission est de mesurer la vitesse de pointe :</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Onglet Radar :</strong> Allez sur cet onglet.</li>
                            <li><strong>Concurrent en piste :</strong> Le nom du concurrent en course s'affiche en haut.</li>
                            <li><strong>Saisie :</strong> D√®s que vous avez la vitesse sur votre appareil, tapez-la dans le champ num√©rique.</li>
                            <li><strong>Enregistrer :</strong> Cliquez sur <strong>Enregistrer Vitesse</strong>. La vitesse sera automatiquement associ√©e √† la descente en cours du concurrent.</li>
                        </ul>
                    `;
                    break;
                default:
                    content += "<p>Votre r√¥le vous donne un acc√®s en lecture seule √† la plupart des informations de la course. Vous pouvez suivre les temps en direct et consulter les classements.</p>";
            }
            
            content += "</div>";
            showConfirmationModal(content, () => {}, title);
        }

        // --- D√©marrage de l'application ---
        authenticateAndStart();

    </script>
</body>
</html>







