<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord caisse √† savon gestion des b√©n√©voles et du mat√©riel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .text-red-500 {
            color: #ef4444;
        }
        #benevoles-table, #concurrents-table, #concurrents-admin-table {
            table-layout: auto;
            width: max-content;
            min-width: 100%;
        }
        th, td {
            white-space: nowrap;
            padding: 8px 12px;
        }
        input, select {
            background-color: transparent;
            border: none;
            outline: none;
        }
        input:disabled, select:disabled {
            color: #6b7280;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
        }
        /* Styles pour la modale et l'√©cran de connexion */
        .modal, #login-screen, #starting-grid-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; /* Chang√© pour flex par d√©faut */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content, .login-content, .starting-grid-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .modal-close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        #save-message, #save-concurrents-message {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #save-message.show, #save-concurrents-message.show {
            opacity: 1;
        }
        /* Styles pour les onglets */
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        #chrono-display {
            font-family: 'monospace';
            letter-spacing: 2px;
        }
        /* Style pour les boutons d√©sactiv√©s */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Style for control select */
        select.controle-conforme { background-color: #dcfce7; color: #166534; }
        select.controle-nonconforme { background-color: #fee2e2; color: #991b1b; }
        select.controle-√†v√©rifier { background-color: #fef9c3; color: #854d0e; font-weight: bold; }
        input.paiement-input { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.25rem 0.5rem; width: 60px; }
        input:disabled.paiement-input { background-color: #f3f4f6; }
        .time-input {
            border: 1px solid transparent;
            border-radius: 0.25rem;
            padding: 0.25rem;
            width: 70px;
        }
        .time-input:enabled:hover, .time-input:enabled:focus {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="p-6">

    <!-- √âCRAN DE CONNEXION -->
    <div id="login-screen">
        <div id="critical-error-display" class="login-content text-left max-w-lg" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 text-red-600">Erreur de Configuration Critique</h2>
            <div id="critical-error-message" class="space-y-3"></div>
        </div>
        <div id="login-form-container" class="login-content text-center max-w-md">
            <h2 class="text-2xl font-bold mb-4">Acc√®s au tableau de bord</h2>
            <p class="text-gray-600 mb-6">Veuillez vous identifier pour continuer.</p>
            <form id="login-form" class="space-y-4">
                <div><input type="text" id="login-nom" placeholder="Votre Nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><input type="text" id="login-prenom" placeholder="Votre Pr√©nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><input type="tel" id="login-tel" placeholder="Votre Num√©ro de t√©l√©phone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <p id="login-error" class="text-red-500 text-sm hidden text-left bg-red-50 p-3 rounded-lg border border-red-200">
                    <strong>Informations incorrectes.</strong><br>
                    Veuillez v√©rifier les points suivants :<br>
                    <ul class="list-disc list-inside mt-1">
                        <li>Le <strong>Nom</strong> doit √™tre en MAJUSCULES.</li>
                        <li>Le <strong>Pr√©nom</strong> doit commencer par une majuscule.</li>
                        <li>Le <strong>T√©l√©phone</strong> ne doit contenir que des chiffres, sans espaces.</li>
                    </ul>
                </p>
                <div class="flex justify-center pt-4"><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200">Se connecter</button></div>
            </form>
        </div>
    </div>

    <!-- √âCRAN GRILLE DE D√âPART -->
    <div id="starting-grid-screen" style="display: none;">
        <div class="starting-grid-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="grid-title" class="text-2xl font-bold text-gray-800">Grille de D√©part</h2>
                <button id="close-grid-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="overflow-y-auto max-h-[80vh]">
                <table class="min-w-full divide-y divide-gray-200" id="grid-table">
                    <thead class="bg-gray-200 sticky top-0">
                        <!-- Headers de la grille g√©n√©r√©s par JS -->
                    </thead>
                    <tbody id="grid-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE -->
    <div id="main-app" class="max-w-7xl mx-auto" style="display: none;">
        <div class="bg-white shadow-xl rounded-2xl p-6 mb-4">
             <div class="flex justify-between items-center mb-2">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Tableau de bord - Caisse √† Savon</h1>
                    <p class="text-gray-400 text-xs sm:text-sm">Connect√© en tant que: <span id="user-info" class="font-semibold"></span></p>
                </div>
                <div class="flex items-center gap-2">
                    <input type="file" id="import-file" class="hidden" accept=".json">
                    <button id="import-btn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200">Importer</button>
                    <button id="export-btn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200">Exporter</button>
                    <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200">D√©connexion</button>
                </div>
            </div>
        </div>
        
        <div class="mb-4 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-dashboard" class="tab-button active py-4 px-1 border-b-2 font-medium text-sm">B√©n√©voles & Mat√©riel</button>
                <button id="tab-concurrents" class="tab-button py-4 px-1 border-b-2 font-medium text-sm">Concurrents</button>
                <button id="tab-race" class="tab-button py-4 px-1 border-b-2 font-medium text-sm">Gestion Course</button>
                <button id="tab-access" class="tab-button py-4 px-1 border-b-2 font-medium text-sm" style="display: none;">Gestion Acc√®s</button>
            </nav>
        </div>

        <div id="content-dashboard" class="tab-content">
             <!-- Le contenu de l'onglet B√©n√©voles sera inject√© ici par JS -->
        </div>

        <div id="content-concurrents" class="tab-content" style="display: none;">
             <!-- Le contenu de l'onglet Concurrents sera inject√© ici par JS -->
        </div>
        
        <div id="content-race" class="tab-content" style="display: none;">
             <!-- Le contenu de l'onglet Course sera inject√© ici par JS -->
        </div>

        <div id="content-access" class="tab-content" style="display: none;">
             <!-- Le contenu de l'onglet Gestion Acc√®s sera inject√© ici par JS -->
        </div>
        
    </div>

    <!-- Modal pour ajouter/modifier un b√©n√©vole -->
    <div id="add-benevole-modal" class="modal" style="display:none">
        <!-- Le contenu de la modale sera inject√© ici par JS -->
    </div>

    <!-- Modal pour les cr√©dits -->
    <div id="credits-modal" class="modal" style="display:none">
        <div class="modal-content max-w-lg">
            <div class="modal-header">
                <h2>Informations sur le projet</h2>
                <button class="modal-close-button" id="close-credits-modal-btn">&times;</button>
            </div>
            <div class="space-y-3 text-sm text-gray-700">
                <p><strong>Projet :</strong> Tableau de bord course caisse √† savon</p>
                <p><strong>Auteur principal :</strong> Romain Pourcel</p>
                <p><strong>Contribution :</strong> Louane Pourcel (√©l√®ve de 5e B au Coll√®ge Saint-Joseph CAUDAN) a particip√© √† la r√©alisation des tableaux des b√©n√©voles.</p>
                <p class="mt-4 pt-4 border-t border-gray-200 text-xs text-gray-500">
                    <em>Remarque : Ce fichier contient du code partiellement g√©n√©r√© √† l‚Äôaide d‚Äôun outil d‚Äôintelligence artificielle, puis revu et adapt√© manuellement.</em>
                </p>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp as initializeFirebaseApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, getDocs, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // SECTION 1: AUTHENTIFICATION
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        
        let currentUser = null;
        let utilisateursAutorises = [];
        let isSuperAdmin = false;
        let db;
        let appId;

        // <!-- ============================================================================== -->
        // <!-- ================== ZONE √Ä MODIFIER / HIGHLIGHTED AREA ================== -->
        // <!-- VEUILLEZ REMPLACER LE BLOC CI-DESSOUS PAR VOTRE CONFIGURATION PERSONNELLE     -->
        // <!-- OBTENUE DEPUIS LA CONSOLE FIREBASE LORS DE L'AJOUT DE VOTRE APPLICATION WEB. -->
        // <!-- ============================================================================== -->
        const firebaseConfig = {
            apiKey: "AIzaSyCu1qYE7eSEheretG2xicIqlRjamgnEavA",
            authDomain: "caisse-a-savon-2025-14a45.firebaseapp.com",
            projectId: "caisse-a-savon-2025-14a45",
            storageBucket: "caisse-a-savon-2025-14a45.appspot.com",
            messagingSenderId: "301217982939",
            appId: "1:301217982939:web:1a1c501328475256661ffe"
        };
        // <!-- ============================================================================== -->
        // <!-- ========================== FIN DE LA ZONE √Ä MODIFIER ========================= -->
        // <!-- ============================================================================== -->

        appId = 'caisse-a-savon-2025'; // Identifiant unique pour vos donn√©es
        const app = initializeFirebaseApp(firebaseConfig);
        db = getFirestore(app);
        const auth = getAuth(app);

        async function authenticateAndStart() {
            try {
                await signInAnonymously(auth);
                await loadAccessData();
            } catch (error) {
                console.error("Erreur d'authentification Firebase:", error);
                
                document.getElementById('login-form-container').style.display = 'none';
                const errorDisplay = document.getElementById('critical-error-display');
                const errorMessageContainer = document.getElementById('critical-error-message');
                errorDisplay.style.display = 'block';

                let errorHtml = "";
                
                if (error.code === 'auth/configuration-not-found') {
                    errorHtml = `
                        <p class="font-semibold text-lg">Probl√®me de configuration Firebase d√©tect√©.</p>
                        <p class="mt-2">L'application ne peut pas d√©marrer car la connexion "Anonyme" n'est pas activ√©e. C'est une √©tape de configuration <strong>obligatoire</strong>.</p>
                        <strong class="block mt-4">Comment corriger :</strong>
                        <ol class="list-decimal list-inside space-y-2 mt-2">
                            <li>Ouvrez la <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">console Firebase</a> de votre projet.</li>
                            <li>Cliquez sur <strong>"Authentication"</strong> dans le menu de gauche (section "Build").</li>
                            <li>Allez sur l'onglet <strong>"Sign-in method"</strong>.</li>
                            <li>Dans la liste, trouvez <strong>"Anonyme"</strong> et cliquez dessus.</li>
                            <li>Activez l'interrupteur et enregistrez.</li>
                        </ol>
                        <p class="mt-4">Apr√®s avoir fait cette modification, veuillez <strong>rafra√Æchir cette page</strong> pour utiliser l'application.</p>
                    `;
                } else if (error.code === 'auth/api-key-not-valid') {
                     errorHtml = `
                        <p class="font-semibold">La cl√© API (apiKey) dans votre configuration Firebase est invalide.</p>
                        <p>Cela signifie que la configuration Firebase dans le code est incorrecte ou a mal √©t√© copi√©e.</p>
                        <strong class="block mt-4">POUR CORRIGER :</strong>
                        <ol class="list-decimal list-inside space-y-2 mt-2">
                            <li>Retournez dans les param√®tres de votre projet sur la <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">console Firebase</a>.</li>
                            <li>Copiez √† nouveau et avec attention l'objet de configuration <code>firebaseConfig</code>.</li>
                            <li>Collez-le dans le fichier <code>index.html</code> en vous assurant de remplacer enti√®rement le bloc d'exemple.</li>
                        </ol>
                     `;
                } else {
                    errorHtml = `<p>Une erreur inattendue est survenue. Veuillez v√©rifier la console du navigateur pour plus de d√©tails.</p><p class="mt-2 text-sm text-gray-500">Code d'erreur : ${error.code}</p>`;
                }
                
                errorMessageContainer.innerHTML = errorHtml;
            }
        }

        function loadAccessData() {
            return new Promise((resolve, reject) => {
                const usersCollection = collection(db, `artifacts/${appId}/public/data/users`);
                const unsubscribe = onSnapshot(usersCollection, 
                    (snapshot) => {
                        utilisateursAutorises = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log("Utilisateurs charg√©s depuis Firestore :", JSON.parse(JSON.stringify(utilisateursAutorises)));
                        resolve();
                    }, 
                    (error) => {
                        console.error("Erreur de lecture (Firestore):", error);
                        if(error.code === 'permission-denied') {
                            alert("Erreur de permission. Assurez-vous que les r√®gles de s√©curit√© de votre base de donn√©es Firestore sont correctement configur√©es ET que la structure des donn√©es (dossiers et sous-dossiers) a √©t√© cr√©√©e exactement comme indiqu√© dans le guide.");
                        } else {
                            alert("Une erreur de base de donn√©es est survenue.");
                        }
                        reject(error);
                    }
                );
            });
        }
        
        function removeAccents(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        loginForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            const nomInput = document.getElementById('login-nom').value.trim().toUpperCase();
            const prenomInput = document.getElementById('login-prenom').value.trim();
            const tel = document.getElementById('login-tel').value.replace(/\s/g, '');

            const normalizedNomInput = removeAccents(nomInput);
            const normalizedPrenomInput = removeAccents(prenomInput.toLowerCase());
            
            const foundUser = utilisateursAutorises.find(user => {
                const normalizedUserNom = removeAccents(String(user.nom).trim().toUpperCase());
                const normalizedUserPrenom = removeAccents(String(user.prenom).trim().toLowerCase());
                return normalizedUserNom === normalizedNomInput &&
                       normalizedUserPrenom === normalizedPrenomInput &&
                       String(user.tel).replace(/\s/g, '') === tel;
            });

            if (foundUser) { 
                currentUser = foundUser; 
                isSuperAdmin = (currentUser.role === 'Super Admin') || (currentUser.nom === "POURCEL" && currentUser.prenom === "Romain" && currentUser.tel === "0613255651");
                               
                loginScreen.style.display = 'none'; 
                mainApp.style.display = 'block'; 
                userInfo.textContent = `${currentUser.prenom} ${currentUser.nom} (${isSuperAdmin ? 'Super Admin' : currentUser.role})`; 
                startAppLogic(); 
            } else { 
                loginError.classList.remove('hidden'); 
            } 
        });
        logoutBtn.addEventListener('click', () => { location.reload(); });

        // SECTION 2: LOGIQUE DE L'APPLICATION
        function startAppLogic() {
            let editingBenevoleId = null;
            
            const creditsButtonHTML = `<div class="text-center text-gray-400 text-xs my-2"><button class="credits-btn-trigger hover:underline text-blue-500">Application web cr√©√©e Par</button></div>`;

            // -- Inject HTML content for tabs --
            document.getElementById('content-dashboard').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-6"><h2 class="text-xl font-bold text-gray-800 mb-4">Suivi du mat√©riel</h2><div class="mb-8 p-4 bg-yellow-50 rounded-xl shadow-inner border-l-4 border-yellow-400 flex flex-wrap justify-between items-center text-sm md:text-base"><div class="flex flex-col items-center"><div class="flex items-center space-x-2"><span class="font-medium text-gray-700">Radios:</span><span class="font-bold text-blue-600" id="radios-distribuees">0</span><span class="text-gray-500">D</span><span class="font-bold text-green-600" id="radios-restituees">0</span><span class="text-gray-500">R</span></div><div class="flex items-center space-x-2 mt-1"><span class="font-medium text-red-500">Manquantes:</span><span class="font-bold text-lg text-red-500" id="radios-manquantes">0</span></div></div><div class="flex-grow"></div><div class="flex flex-col items-center"><div class="flex items-center space-x-2"><span class="font-medium text-gray-700">Sifflets:</span><span class="font-bold text-blue-600" id="sifflets-distribues">0</span><span class="text-gray-500">D</span><span class="font-bold text-green-600" id="sifflets-restitues">0</span><span class="text-gray-500">R</span></div><div class="flex items-center space-x-2 mt-1"><span class="font-medium text-red-500">Manquants:</span><span class="font-bold text-lg text-red-500" id="sifflets-manquants">0</span></div></div><div class="flex-grow"></div><div class="flex items-center space-x-2 mt-4 md:mt-0"><span class="font-medium text-gray-700">Appareils manquants:</span><span class="font-bold text-2xl text-red-500" id="appareils-manquants">0</span></div></div><h2 class="text-xl font-bold text-gray-800 mb-4">Liste des b√©n√©voles</h2><div class="flex flex-col lg:flex-row justify-between items-center mb-4 gap-4"><div class="flex flex-wrap items-end gap-4"><button id="add-benevole-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200">+ Ajouter un b√©n√©vole</button></div><div class="w-full lg:w-auto flex-grow flex justify-center"><input type="text" id="filter-input" placeholder="Rechercher un b√©n√©vole..." class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full max-w-xs"></div><div class="flex items-center gap-4"><div class="flex items-center gap-2" id="missing-info-container"><input type="checkbox" id="filter-missing-info" class="form-checkbox h-4 w-4 text-red-600 rounded"><label for="filter-missing-info" class="text-sm font-medium text-gray-700 select-none">Infos manquantes ‚ùå</label></div><div class="flex items-center gap-2"><input type="checkbox" id="toggleTel" class="form-checkbox h-4 w-4 text-blue-600 rounded"><label for="toggleTel" class="text-sm font-medium text-gray-700 select-none">Masquer T√©l.</label></div><div class="flex items-center gap-2"><span id="save-message" class="text-green-600 font-bold"></span><button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200">Sauvegarder</button></div></div></div><div class="bg-gray-100 p-4 rounded-xl overflow-x-auto shadow-inner"><table class="divide-y divide-gray-200" id="benevoles-table"><thead class="bg-gray-200 sticky top-0 z-10"><tr><th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider rounded-tl-xl">Nom & Pr√©nom</th><th data-column="tel" class="px-4 py-3 text-left text-xs font-bold uppercase">T√©l√©phone</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Jours de pr√©sence</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Lieu d'affectation üìç</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Fonction üíº</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Mat√©riel (D/R)</th><th data-column="zello" class="px-4 py-3 text-left text-xs font-bold uppercase">Zello üìª</th><th data-column="acces" class="px-4 py-3 text-left text-xs font-bold uppercase">Acc√®s</th><th data-column="action" class="px-4 py-3 text-left text-xs font-bold uppercase rounded-tr-xl">Action</th></tr></thead><tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>` + creditsButtonHTML;
            document.getElementById('content-concurrents').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-6"><h2 class="text-xl font-bold text-gray-800 mb-2">Ajouter un Concurrent</h2><form id="add-concurrent-form" class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200 flex flex-wrap items-end gap-3"><div class="flex-grow"><label for="concurrent-numero" class="block text-sm font-medium text-gray-700">N¬∞</label><input type="number" id="concurrent-numero" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="flex-grow-[3]"><label for="concurrent-nom" class="block text-sm font-medium text-gray-700">Nom Concurrent / √âquipe</label><input type="text" id="concurrent-nom" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="flex items-center pt-6"><input type="checkbox" id="concurrent-enfant" class="h-4 w-4 text-blue-600 rounded mr-2"><label for="concurrent-enfant" class="text-sm font-medium text-gray-700">Enfant üßí</label></div><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl">+ Ajouter</button></form><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800">Liste des Concurrents</h2><div><span id="save-concurrents-message" class="text-green-600 font-bold mr-4"></span><button id="save-concurrents-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200 text-sm">Sauvegarder</button></div></div><div class="bg-gray-100 p-4 rounded-xl overflow-x-auto shadow-inner"><table id="concurrents-admin-table" class="divide-y divide-gray-200"><thead class="bg-gray-200"><tr><th class="px-4 py-3 text-left text-xs font-bold uppercase rounded-tl-xl">N¬∞</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Concurrent</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Enfant</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Dossier Inscription</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Assurance</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Paiement Cotisation</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">√âquipements S√©curit√©</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Contr√¥le Tech.</th><th class="px-4 py-3 text-left text-xs font-bold uppercase rounded-tr-xl">Action</th></tr></thead><tbody id="concurrents-admin-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>` + creditsButtonHTML;
            document.getElementById('content-race').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-6"><div id="chrono-container" class="mb-6 p-6 bg-gray-50 rounded-2xl shadow-inner"><h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Chronom√®tre (<span id="current-manche-display"></span>)</h2><div class="max-w-md mx-auto"><div class="mb-4"><label for="concurrent-select" class="block text-sm font-medium text-gray-700 mb-1">Concurrent au d√©part</label><select id="concurrent-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select></div><div id="chrono-display" class="text-5xl font-bold text-center text-blue-600 bg-white p-4 rounded-xl mb-4 shadow">00:00:00</div><div class="grid grid-cols-2 gap-3 mt-auto"><button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200" disabled>D√©marrer</button><button id="stop-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200" disabled>Arr√™ter et Enregistrer</button><button id="reset-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200 col-span-2">R√©initialiser</button></div></div></div><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800">Classement de la Course</h2><div class="flex items-center gap-2"><button id="reset-race-btn" class="bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded-xl transition duration-200 mr-2">R√©initialiser Course</button><button id="new-heat-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200 mr-2">Manche Suivante</button><button id="previous-heat-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200 mr-2">Temps Manche Pr√©c√©dente</button><button id="podium-btn" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-xl transition duration-200">Podium</button></div></div><div class="bg-gray-100 p-4 rounded-xl overflow-x-auto shadow-inner"><table class="divide-y divide-gray-200" id="concurrents-table"><thead id="concurrents-table-head" class="bg-gray-200"></thead><tbody id="concurrents-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>` + creditsButtonHTML;
            document.getElementById('content-access').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-6"><h2 class="text-xl font-bold text-gray-800 mb-2">G√©rer les utilisateurs autoris√©s</h2><p class="text-gray-600 mb-6 text-sm">Seuls les utilisateurs list√©s ici peuvent se connecter.</p><form id="add-user-form" class="mb-8 p-4 bg-gray-50 rounded-xl border border-gray-200 flex flex-wrap items-end gap-4"><div class="flex-grow"><label for="user-nom" class="block text-sm font-medium text-gray-700">Nom</label><input type="text" id="user-nom" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex-grow"><label for="user-prenom" class="block text-sm font-medium text-gray-700">Pr√©nom</label><input type="text" id="user-prenom" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex-grow"><label for="user-tel" class="block text-sm font-medium text-gray-700">T√©l√©phone</label><input type="tel" id="user-tel" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex-grow"><label for="user-role" class="block text-sm font-medium text-gray-700">R√¥le</label><select id="user-role" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"><option value="Super Admin">Super Admin</option><option value="Organisation">Organisation</option><option value="Responsable Radio">Responsable Radio</option><option value="MAIRE">MAIRE</option><option value="Chrono D√©part">Chrono D√©part</option><option value="Chrono Arriv√©e">Chrono Arriv√©e</option><option value="B√©n√©vole">B√©n√©vole</option><option value="Concurrent">Concurrent</option></select></div><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl">+ Ajouter</button></form><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Nom Pr√©nom</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">T√©l√©phone</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">R√¥le</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Action</th></tr></thead><tbody id="access-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>` + creditsButtonHTML;
            document.getElementById('add-benevole-modal').innerHTML = `<div class="modal-content max-w-md"><div class="modal-header"><h2 id="modal-title">Ajouter un nouveau b√©n√©vole</h2><button class="modal-close-button" id="close-modal-btn">&times;</button></div><form id="add-benevole-form" class="space-y-4"><div><label for="nom" class="block text-sm font-medium text-gray-700">Nom</label><input type="text" id="nom" name="nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div><div><label for="prenom" class="block text-sm font-medium text-gray-700">Pr√©nom</label><input type="text" id="prenom" name="prenom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div><div><label for="tel" class="block text-sm font-medium text-gray-700">T√©l√©phone</label><input type="text" id="tel" name="tel" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex justify-end pt-4"><button type="submit" id="modal-submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl">Ajouter</button></div></form></div>`;
            
            // Re-select all elements after injection
            const tableBody = document.getElementById('table-body'), toggleTelCheckbox = document.getElementById('toggleTel'), addBenevoleBtn = document.getElementById('add-benevole-btn'), saveBtn = document.getElementById('save-btn'), closeModalBtn = document.getElementById('close-modal-btn'), addBenevoleForm = document.getElementById('add-benevole-form'), filterInput = document.getElementById('filter-input'), filterMissingInfoCheckbox = document.getElementById('filter-missing-info');
            const chronoDisplay=document.getElementById("chrono-display"),startBtn=document.getElementById("start-btn"),stopBtn=document.getElementById("stop-btn"),resetBtn=document.getElementById("reset-btn"),raceConcurrentsTableBody=document.getElementById("concurrents-table-body"),concurrentSelect=document.getElementById("concurrent-select"),addConcurrentFormAdmin = document.getElementById('add-concurrent-form'),concurrentsAdminBody = document.getElementById('concurrents-admin-body'),saveConcurrentsBtn = document.getElementById('save-concurrents-btn'),saveConcurrentsMessage = document.getElementById('save-concurrents-message'),addUserForm = document.getElementById('add-user-form'),accessTableBody = document.getElementById('access-table-body'), newHeatBtn = document.getElementById('new-heat-btn'), podiumBtn = document.getElementById('podium-btn'), previousHeatBtn = document.getElementById('previous-heat-btn'), concurrentsTableHead = document.getElementById('concurrents-table-head'), currentMancheDisplay = document.getElementById('current-manche-display'), gridScreen=document.getElementById("starting-grid-screen"),closeGridBtn=document.getElementById("close-grid-btn"), resetRaceBtn = document.getElementById('reset-race-btn'), importBtn = document.getElementById('import-btn'), exportBtn = document.getElementById('export-btn'), importFile = document.getElementById('import-file'), creditsModal = document.getElementById('credits-modal'), closeCreditsModalBtn = document.getElementById('close-credits-modal-btn');
            
            // =========================
            // B√âN√âVOLES LOGIC
            // =========================
            let data = [];
            const rolesOptions = ["Aucun acc√®s", "Super Admin", "Organisation", "Responsable Radio", "MAIRE", "Chrono D√©part", "Chrono Arriv√©e", "B√©n√©vole", "Concurrent"];
            const joursOptions=["Samedi","Dimanche","Samedi/Dimanche","Non renseign√©"],fonctionOptions=["Organisateur üßë‚Äçüíº","Accueil / Inscriptions üìù","Contr√¥le Technique üõ†Ô∏è","S√©curit√© Piste üöß","Commissaire de Course üö¶","Chronom√©trage ‚è±Ô∏è","Logistique üöö","Relations Comp√©titeurs üëã","Espace Convivialit√© -B√©n√©voles üßë‚Äçü§ù‚Äçüßë","Remont√©e des Caisses üöú","Speaker üì¢","Photographe üì∏","Responsable Radio üìª","P√¥le de D√©part üèÅ","P√¥le d'Arriv√©e ‚úÖ","Podium üèÜ","Secr√©tariat üìã","Responsable Expo voiture üöó","Soutien op√©rationnel","√Ä d√©finir"],lieuOptions=["Mobile sur l'ensemble du parcours","Parc Concurrents","Piste de Course","Grille de D√©part","Contr√¥le Technique","Espace B√©n√©voles","Rue de l'√©tang","Rue des Ajoncs","Rue Mar√©chal Leclerc","Rue G√©n√©ral De Gaulle","Rue G√©n√©ral D√©borde","Rue des √âcoles","Rue Madame Gadot","Rue Saint-Joseph","Rue Fran√ßois Le Bail","Ligne d'arriv√©e","Garage Motrio","√Ä d√©finir"];
            
            const benevolesCollection = collection(db, `artifacts/${appId}/public/data/benevoles`);
            onSnapshot(benevolesCollection, (snapshot) => {
                data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBenevolesTable();
            });

            async function saveBenevolesData() {
                const batch = writeBatch(db);
                data.forEach(benevole => {
                    const { id, ...benevoleData } = benevole;
                    const docRef = doc(db, `artifacts/${appId}/public/data/benevoles`, id);
                    batch.update(docRef, benevoleData);
                });
                await batch.commit();
                const saveMessage = document.getElementById("save-message");
                saveMessage.textContent="Donn√©es sauvegard√©es !";
                saveMessage.classList.add("show");
                setTimeout(() => { saveMessage.classList.remove("show") }, 3000);
            }
            
            function updateAccessFromBenevole(benevole, newRole) {
                const existingUser = utilisateursAutorises.find(u => u.tel === benevole.tel);
                if (newRole === 'Aucun acc√®s') {
                    if (existingUser) {
                        deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, existingUser.id));
                    }
                } else {
                    if (existingUser) {
                        updateDoc(doc(db, `artifacts/${appId}/public/data/users`, existingUser.id), { role: newRole });
                    } else {
                        addDoc(collection(db, `artifacts/${appId}/public/data/users`), { 
                            nom: benevole.nom, 
                            prenom: benevole.prenom, 
                            tel: benevole.tel, 
                            role: newRole 
                        });
                    }
                }
            }

            function createBenevoleSelect(options, currentValue, personIndex, property, disabled = false) {
                const select = document.createElement("select");
                select.className = "py-1 px-2 border-gray-200 rounded-md shadow-sm text-sm w-full";
                select.disabled = disabled;
                
                options.forEach(optionValue => {
                    const option = document.createElement("option");
                    option.value = optionValue;
                    option.textContent = optionValue;
                    if (optionValue === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                select.addEventListener("change", () => {
                    if (property === "role") {
                        const benevole = data[personIndex];
                        if (benevole) {
                            updateAccessFromBenevole(benevole, select.value);
                        }
                    } else {
                        data[personIndex][property] = select.value;
                    }

                    if (property === 'fonction') {
                         const benevole = data[personIndex];
                         const user = utilisateursAutorises.find(u => u.tel === benevole.tel);
                         const currentRole = user ? user.role : 'Aucun acc√®s';
                        if (!['Super Admin', 'Organisation', 'Chrono D√©part', 'Chrono Arriv√©e', 'MAIRE'].includes(currentRole)) {
                            if (select.value === 'Responsable Radio üìª') {
                                updateAccessFromBenevole(benevole, 'Responsable Radio');
                            } else {
                                updateAccessFromBenevole(benevole, 'B√©n√©vole');
                            }
                        }
                    }
                });
                
                return select;
            }

            function openBenevoleModal(benevoleId = null) {
                const modal = document.getElementById('add-benevole-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalSubmitBtn = document.getElementById('modal-submit-btn');
                
                addBenevoleForm.reset();

                if (benevoleId) {
                    editingBenevoleId = benevoleId;
                    const benevole = data.find(b => b.id === benevoleId);
                    modalTitle.textContent = "Modifier le b√©n√©vole";
                    modalSubmitBtn.textContent = "Enregistrer";
                    document.getElementById('nom').value = benevole.nom;
                    document.getElementById('prenom').value = benevole.prenom;
                    document.getElementById('tel').value = benevole.tel;
                } else {
                    editingBenevoleId = null;
                    modalTitle.textContent = "Ajouter un nouveau b√©n√©vole";
                    modalSubmitBtn.textContent = "Ajouter";
                }
                modal.style.display = 'flex';
            }

            function renderBenevolesTable() {
                const filterValue = filterInput.value.toLowerCase();
                const missingInfoOnly = filterMissingInfoCheckbox.checked;

                let dataToRender = data.filter(p => `${p.nom} ${p.prenom}`.toLowerCase().includes(filterValue));

                if (missingInfoOnly) {
                    dataToRender = dataToRender.filter(p => p.tel === "Non renseign√©" || p.jours === "Non renseign√©" || p.lieu === "√Ä d√©finir" || p.fonction === "√Ä d√©finir");
                }

                tableBody.innerHTML = "";
                const headerRow = document.querySelector("#benevoles-table thead tr");
                const canManage = isSuperAdmin || currentUser.role === 'Organisation';
                const isRadioManager = currentUser.role === 'Responsable Radio';

                // G√©rer la visibilit√© des colonnes dans l'en-t√™te
                headerRow.querySelector('[data-column="tel"]').style.display = canManage ? '' : 'none';
                headerRow.querySelector('[data-column="zello"]').style.display = canManage || isRadioManager ? '' : 'none';
                headerRow.querySelector('[data-column="acces"]').style.display = isSuperAdmin ? '' : 'none';
                headerRow.querySelector('[data-column="action"]').style.display = canManage ? '' : 'none';

                dataToRender.forEach((person) => {
                    const personIndex = data.findIndex(p => p.id === person.id);
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td class="px-4 py-3"><input type="text" value="${person.nom} ${person.prenom}" class="w-full text-sm"></td>
                        <td data-column="tel" class="px-4 py-3"><input type="tel" value="${person.tel}" class="w-full text-sm ${!person.tel || person.tel === "Non renseign√©" ? "text-red-500" : ""}"></td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3"></td>
                        <td data-column="zello" class="px-4 py-3 text-center"><input type="checkbox" ${person.zello ? "checked" : ""}></td>
                        <td data-column="acces" class="px-4 py-3"></td>
                        <td data-column="action" class="px-4 py-3 text-center">
                            <div class="flex items-center gap-2 justify-center">
                                <button data-id="${person.id}" class="edit-benevole-btn text-blue-600 hover:text-blue-700 text-xs font-medium">Modifier</button>
                                <span class="text-gray-300">|</span>
                                <button data-id="${person.id}" class="delete-benevole-btn text-red-500 hover:text-red-700 text-xs font-medium">Supprimer</button>
                            </div>
                        </td>
                    `;
                    
                    row.querySelector('[data-column="tel"]').style.display = canManage ? '' : 'none';
                    row.querySelector('[data-column="zello"]').style.display = canManage || isRadioManager ? '' : 'none';
                    row.querySelector('[data-column="acces"]').style.display = isSuperAdmin ? '' : 'none';
                    row.querySelector('[data-column="action"]').style.display = canManage ? '' : 'none';

                    row.querySelector('input[type="text"]').disabled = !canManage;
                    row.querySelector('input[type="tel"]').disabled = !canManage;
                    row.querySelector('[data-column="zello"] input').disabled = !canManage;

                    row.querySelector('input[type="text"]').onchange = (e) => { const [nom, ...prenomParts] = e.target.value.split(' '); data[personIndex].nom = nom.toUpperCase(); data[personIndex].prenom = prenomParts.join(' '); };
                    row.querySelector('input[type="tel"]').onchange = (e) => { data[personIndex].tel = e.target.value.replace(/\s/g, ''); };
                    row.querySelector('[data-column="zello"] input').onchange = (e) => { data[personIndex].zello = e.target.checked; };
                    
                    row.children[2].appendChild(createBenevoleSelect(joursOptions, person.jours, personIndex, "jours", !canManage));
                    row.children[3].appendChild(createBenevoleSelect(lieuOptions, person.lieu, personIndex, "lieu", !canManage));
                    row.children[4].appendChild(createBenevoleSelect(fonctionOptions, person.fonction, personIndex, "fonction", !canManage));

                    const materielDiv = document.createElement('div');
                    materielDiv.className = 'flex flex-col space-y-1';
                    Object.keys(person.materiel).forEach(key => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center space-x-2';
                        itemDiv.innerHTML = `<span class="w-12 text-sm">${key}:</span>`;
                        const distribueCheckbox = document.createElement('input');
                        distribueCheckbox.type = 'checkbox';
                        distribueCheckbox.checked = person.materiel[key].distribue;
                        distribueCheckbox.disabled = !canManage && !isRadioManager;
                        distribueCheckbox.className = 'h-4 w-4 text-blue-600 rounded';
                        distribueCheckbox.onchange = () => { data[personIndex].materiel[key].distribue = distribueCheckbox.checked; updateMaterialSummary(); };
                        itemDiv.appendChild(distribueCheckbox);
                        const restitueCheckbox = document.createElement('input');
                        restitueCheckbox.type = 'checkbox';
                        restitueCheckbox.checked = person.materiel[key].restitue;
                        restitueCheckbox.disabled = !canManage && !isRadioManager;
                        restitueCheckbox.className = 'h-4 w-4 text-green-600 rounded';
                        restitueCheckbox.onchange = () => { data[personIndex].materiel[key].restitue = restitueCheckbox.checked; updateMaterialSummary(); };
                        itemDiv.appendChild(restitueCheckbox);
                        materielDiv.appendChild(itemDiv);
                    });
                    row.children[5].appendChild(materielDiv);
                    
                    const userInAccessList = utilisateursAutorises.find(u => u.tel === person.tel);
                    const currentRole = userInAccessList ? userInAccessList.role : "Aucun acc√®s";
                    const roleSelect = createBenevoleSelect(rolesOptions, currentRole, personIndex, "role", !isSuperAdmin);
                    row.children[7].appendChild(roleSelect);
                    
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.edit-benevole-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        openBenevoleModal(e.target.dataset.id);
                    });
                });

                document.querySelectorAll('.delete-benevole-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const personId = e.target.dataset.id;
                        const person = data.find(p => p.id === personId);
                        if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${person.prenom} ${person.nom} ?`)) {
                            deleteDoc(doc(db, `artifacts/${appId}/public/data/benevoles`, personId));
                            const accessUser = utilisateursAutorises.find(u => u.tel === person.tel);
                            if (accessUser) {
                                deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, accessUser.id));
                            }
                        }
                    });
                });
                
                updateMaterialSummary();
                toggleTelColumn();
                setupBenevolePermissions();
            }

            function updateMaterialSummary() {
                let radiosDistribues = 0, radiosRestitues = 0, siffletsDistribues = 0, siffletsRestitues = 0;
                data.forEach(benevole => {
                    if (benevole.materiel.Radio?.distribue) radiosDistribues++;
                    if (benevole.materiel.Radio?.restitue) radiosRestitues++;
                    if (benevole.materiel.Sifflet?.distribue) siffletsDistribues++;
                    if (benevole.materiel.Sifflet?.restitue) siffletsRestitues++;
                });
                const radiosManquantes = radiosDistribues - radiosRestitues;
                const siffletsManquants = siffletsDistribues - siffletsRestitues;

                document.getElementById("radios-distribuees").textContent = radiosDistribues;
                document.getElementById("radios-restituees").textContent = radiosRestitues;
                document.getElementById("radios-manquantes").textContent = radiosManquantes;
                document.getElementById("sifflets-distribues").textContent = siffletsDistribues;
                document.getElementById("sifflets-restitues").textContent = siffletsRestitues;
                document.getElementById("sifflets-manquants").textContent = siffletsManquants;
                document.getElementById("appareils-manquants").textContent = radiosManquantes + siffletsManquants;
            }

            function toggleTelColumn(){
                const isHidden = toggleTelCheckbox.checked;
                const header = document.querySelector('th[data-column="tel"]');
                const cells = document.querySelectorAll('td[data-column="tel"]');
                if (!(isSuperAdmin || currentUser.role === 'Organisation')) return;
                if(header) header.style.display = isHidden ? "none" : "" ; 
                cells.forEach(cell => { cell.style.display = isHidden ? "none": "" });
            }

            saveBtn.addEventListener('click', saveBenevolesData);
            addBenevoleBtn.addEventListener('click', () => openBenevoleModal());
            
            closeModalBtn.addEventListener('click', () => {
                document.getElementById('add-benevole-modal').style.display = 'none';
                editingBenevoleId = null;
            });
            
            addBenevoleForm.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = {
                    nom: document.getElementById("nom").value.toUpperCase(),
                    prenom: document.getElementById("prenom").value,
                    tel: document.getElementById("tel").value.replace(/\s/g, "") || "Non renseign√©",
                };

                if (editingBenevoleId) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/benevoles`, editingBenevoleId);
                    await updateDoc(docRef, {
                        nom: formData.nom,
                        prenom: formData.prenom,
                        tel: formData.tel,
                    });
                } else {
                    const newBenevole = {
                        ...formData,
                        jours: "Non renseign√©",
                        fonction: "√Ä d√©finir",
                        lieu: "√Ä d√©finir",
                        materiel: { Radio: { distribue: false, restitue: false }, Sifflet: { distribue: false, restitue: false }},
                        zello: false
                    };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/benevoles`), newBenevole);
                }
                
                document.getElementById('add-benevole-modal').style.display = "none";
                addBenevoleForm.reset();
                editingBenevoleId = null;
            });

            filterInput.addEventListener('input', renderBenevolesTable);
            filterMissingInfoCheckbox.addEventListener('change', renderBenevolesTable);
            toggleTelCheckbox.addEventListener('change', toggleTelColumn);

            // =========================
            // CONCURRENTS & RACE LOGIC
            // =========================
            let concurrents = [], startTime, updatedTime, difference, tInterval, running = false, currentManche = 1;
            let chronoInterval;

            const chronoDocRef = doc(db, `artifacts/${appId}/public/data/raceState`, 'chrono');
            
            const concurrentsCollection = collection(db, `artifacts/${appId}/public/data/concurrents`);
            onSnapshot(concurrentsCollection, (snapshot) => {
                concurrents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllConcurrentsView();
            });

            async function saveConcurrentsData() {
                const batch = writeBatch(db);
                concurrents.forEach(concurrent => {
                    const { id, ...concurData } = concurrent;
                    const docRef = doc(db, `artifacts/${appId}/public/data/concurrents`, id);
                    batch.update(docRef, concurData);
                });
                await batch.commit();
                saveConcurrentsMessage.textContent = "Modifications sauvegard√©es !";
                saveConcurrentsMessage.classList.add('show');
                setTimeout(() => { saveConcurrentsMessage.classList.remove('show'); }, 3000);
            }

            function renderAllConcurrentsView() {
                renderConcurrentsAdminTable();
                renderRaceTable();
            }

            function renderConcurrentsAdminTable() {
                concurrentsAdminBody.innerHTML = "";
                concurrents.sort((a, b) => a.numero - b.numero).forEach(concurrent => {
                    const concurrentIndex = concurrents.findIndex(c => c.numero === concurrent.numero);
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm">${concurrent.numero}</td>
                        <td class="px-4 py-3 text-sm">${concurrent.nom}</td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-numero="${concurrent.numero}" data-prop="isChild" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.isChild ? "checked" : ""}></td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-numero="${concurrent.numero}" data-prop="documents.dossier" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.documents.dossier ? "checked" : ""}></td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-numero="${concurrent.numero}" data-prop="documents.assurance" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.documents.assurance ? "checked" : ""}></td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <input type="checkbox" data-numero="${concurrent.numero}" data-prop="documents.paiement.ok" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.documents.paiement.ok ? "checked" : ""}>
                                <input type="text" placeholder="‚Ç¨" value="${concurrent.documents.paiement.montant}" data-numero="${concurrent.numero}" class="paiement-input text-sm">
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-numero="${concurrent.numero}" data-prop="equipements" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.equipements ? "checked" : ""}></td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3 text-sm"><button data-id="${concurrent.id}" class="delete-concurrent-btn text-red-500 hover:text-red-700 text-xs">Suppr.</button></td>
                    `;
            
                    const select = document.createElement("select");
                    ["√Ä v√©rifier", "Conforme", "Non Conforme"].forEach(status => {
                        const option = document.createElement("option");
                        option.value = status;
                        option.textContent = status;
                        if (concurrent.controle === status) option.selected = true;
                        select.appendChild(option);
                    });
            
                    const getSelectClass = (status) => `controle-select rounded-md text-xs p-1 font-semibold controle-${status.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '')}`;
                    select.className = getSelectClass(concurrent.controle);
            
                    select.addEventListener("change", (event) => {
                        const targetConcurrent = concurrents[concurrentIndex];
                        if (targetConcurrent) {
                            targetConcurrent.controle = event.target.value;
                            event.target.className = getSelectClass(event.target.value);
                        }
                    });
            
                    row.children[7].appendChild(select);
                    concurrentsAdminBody.appendChild(row);
                });
            
                document.querySelectorAll(".delete-concurrent-btn").forEach(btn => btn.addEventListener("click", event => {
                    const docId = event.target.dataset.id;
                    if (confirm(`Supprimer ce concurrent ?`)) {
                         deleteDoc(doc(db, `artifacts/${appId}/public/data/concurrents`, docId));
                    }
                }));
            
                document.querySelectorAll(".doc-check").forEach(checkbox => checkbox.addEventListener("change", event => {
                    const numero = event.target.dataset.numero;
                    const propPath = event.target.dataset.prop;
                    const targetConcurrent = concurrents.find(c => c.numero == numero);
                    if (targetConcurrent) {
                        const props = propPath.split('.');
                        let current = targetConcurrent;
                        for (let i = 0; i < props.length - 1; i++) {
                            current = current[props[i]];
                        }
                        current[props[props.length - 1]] = event.target.checked;
                    }
                }));
            
                document.querySelectorAll(".paiement-input").forEach(input => input.addEventListener("input", event => {
                    const numero = event.target.dataset.numero;
                    const targetConcurrent = concurrents.find(c => c.numero == numero);
                    if (targetConcurrent) {
                        targetConcurrent.documents.paiement.montant = event.target.value;
                    }
                }));
            }

            function formatTime(timeInMillis) {
                if (timeInMillis === null || timeInMillis === Infinity || typeof timeInMillis === 'undefined') return "-";
                const date = new Date(timeInMillis);
                const minutes = String(date.getUTCMinutes()).padStart(2, "0");
                const seconds = String(date.getUTCSeconds()).padStart(2, "0");
                const centiseconds = String(date.getUTCMilliseconds()).padStart(3, "0").slice(0, 2);
                return `${minutes}:${seconds}:${centiseconds}`;
            }

            function parseTimeToMillis(timeStr) {
                if (!timeStr || typeof timeStr !== 'string' || timeStr === '-') return null;
                const parts = timeStr.split(':');
                if (parts.length !== 3) return null;

                const minutes = parseInt(parts[0], 10);
                const seconds = parseInt(parts[1], 10);
                const centiseconds = parseInt(parts[2], 10);

                if (isNaN(minutes) || isNaN(seconds) || isNaN(centiseconds)) return null;

                return (minutes * 60 * 1000) + (seconds * 1000) + (centiseconds * 10);
            }
            
            function updateChronoDisplay(startTime) {
                chronoDisplay.textContent = formatTime(new Date().getTime() - startTime);
            }

            function updateChronoButtons(chronoIsRunning) {
                const concurrentSelected = !!concurrentSelect.value;
                const canStart = isSuperAdmin || currentUser.role === 'Organisation' || currentUser.role === 'Chrono D√©part';
                const canStop = isSuperAdmin || currentUser.role === 'Organisation' || currentUser.role === 'Chrono Arriv√©e';
                const canReset = isSuperAdmin || currentUser.role === 'Organisation' || currentUser.role === 'Chrono D√©part';

                startBtn.disabled = !canStart || chronoIsRunning || !concurrentSelected;
                stopBtn.disabled = !canStop || !chronoIsRunning;
                resetBtn.disabled = !canReset || chronoIsRunning;
            }

            async function startChrono() {
                const selectedConcurrent = concurrentSelect.value;
                if (!selectedConcurrent) {
                    alert("Veuillez s√©lectionner un concurrent avant de d√©marrer.");
                    return;
                }
                await setDoc(chronoDocRef, {
                    running: true,
                    startTime: new Date().getTime(),
                    currentConcurrent: selectedConcurrent
                });
            }

            async function stopChrono() {
                const chronoSnapshot = await getDoc(chronoDocRef);
                const chronoData = chronoSnapshot.data();
                if (!chronoData || !chronoData.running) return;

                const endTime = new Date().getTime();
                const startTime = chronoData.startTime;
                const difference = endTime - startTime;
                
                const concurrentNumero = chronoData.currentConcurrent;
                const concurrent = concurrents.find(c => c.numero == concurrentNumero);

                if (concurrent) {
                    const manches = concurrent.manches;
                    manches[currentManche - 1] = difference;
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/concurrents`, concurrent.id), { manches: manches });
                }

                await setDoc(chronoDocRef, { running: false, startTime: null, currentConcurrent: null });
            }

            async function resetChrono() {
                 await setDoc(chronoDocRef, { running: false, startTime: null, currentConcurrent: null });
            }

            async function startNewHeat() { 
                if (currentManche < 8) {
                    if (confirm("√ätes-vous s√ªr de vouloir passer √† la manche suivante ?")) {
                        currentManche++; 
                        renderRaceTable(); 
                    }
                } else {
                     alert("Nombre maximum de manches atteint."); 
                }
            }

            async function resetRace() {
                if(isSuperAdmin && confirm("ACTION IRR√âVERSIBLE\n\n√ätes-vous s√ªr de vouloir r√©initialiser TOUTE la course ? Tous les temps de tous les concurrents seront effac√©s.")) {
                    const batch = writeBatch(db);
                    concurrents.forEach(c => {
                        const docRef = doc(db, `artifacts/${appId}/public/data/concurrents`, c.id);
                        batch.update(docRef, { 
                            manches: new Array(8).fill(null), 
                            meilleurTemps: null, 
                            tempsTotal: null 
                        });
                    });
                    await batch.commit();
                    currentManche = 1;
                }
            }

            function renderRaceTable(){
                const headers = ['Cl.', 'N¬∞', 'Concurrent', ...Array.from({length: 8}, (_, i) => i < 2 ? `Test ${i+1}` : `Course ${i-1}`), 'Temps Total', 'Meilleur Temps'];
                concurrentsTableHead.innerHTML = `<tr>${headers.map((h, i) => `<th class="px-4 py-3 text-left text-xs font-bold uppercase ${i===0?'rounded-tl-xl':''} ${i===headers.length-1?'rounded-tr-xl':''}">${h}</th>`).join('')}</tr>`;

                concurrents.forEach(c => {
                    const officialRuns = c.manches.slice(2).filter(t => t !== null && t !== undefined);
                    c.meilleurTemps = officialRuns.length > 0 ? Math.min(...officialRuns) : null;
                    c.tempsTotal = officialRuns.length > 0 ? officialRuns.reduce((a, b) => a + b, 0) : null;
                });
                
                concurrents.sort((a,b) => {
                    if (a.meilleurTemps === null) return 1;
                    if (b.meilleurTemps === null) return -1;
                    return a.meilleurTemps - b.meilleurTemps;
                });
                
                raceConcurrentsTableBody.innerHTML="";
                const canEditTimes = isSuperAdmin || ['Organisation', 'Chrono D√©part', 'Chrono Arriv√©e'].includes(currentUser.role);

                concurrents.forEach((concurrent, index)=>{
                    const row = document.createElement("tr");
                    const classement = concurrent.meilleurTemps !== null ? index + 1 : "-";
                    let rowHtml = `<td class="px-4 py-3 text-sm font-bold">${classement}</td><td class="px-4 py-3 text-sm">${concurrent.numero}</td><td class="px-4 py-3 text-sm">${concurrent.nom} ${concurrent.isChild ? 'üßí' : ''}</td>`;
                    for(let i=0; i<8; i++){ 
                        rowHtml += `<td class="px-4 py-3 text-sm"><input type="text" class="time-input" value="${formatTime(concurrent.manches[i])}" data-concurrent-id="${concurrent.id}" data-manche-index="${i}" ${canEditTimes ? '' : 'disabled'}></td>`; 
                    }
                    rowHtml += `<td class="px-4 py-3 text-sm font-bold">${formatTime(concurrent.tempsTotal)}</td><td class="px-4 py-3 text-sm font-semibold text-blue-600">${formatTime(concurrent.meilleurTemps)}</td>`;
                    row.innerHTML = rowHtml;
                    raceConcurrentsTableBody.appendChild(row);
                });
                
                currentMancheDisplay.textContent = currentManche <= 2 ? `Test ${currentManche}` : `Course ${currentManche - 2}`;
                populateConcurrentSelect();
            }
             raceConcurrentsTableBody.addEventListener('change', async (e) => {
                if (e.target.classList.contains('time-input')) {
                    const input = e.target;
                    const concurrentId = input.dataset.concurrentId;
                    const mancheIndex = parseInt(input.dataset.mancheIndex, 10);
                    const newTime = parseTimeToMillis(input.value);

                    const concurrentToUpdate = concurrents.find(c => c.id === concurrentId);
                    if (concurrentToUpdate) {
                        concurrentToUpdate.manches[mancheIndex] = newTime;
                        const docRef = doc(db, `artifacts/${appId}/public/data/concurrents`, concurrentId);
                        await updateDoc(docRef, { manches: concurrentToUpdate.manches });
                    }
                }
            });

            function populateConcurrentSelect() {
                const selectedValue = concurrentSelect.value;
                concurrentSelect.innerHTML = '<option value="">-- Choisir un concurrent --</option>';
                concurrents.sort((a, b) => a.numero - b.numero).forEach(concurrent => {
                    const option = document.createElement("option");
                    option.value = concurrent.numero;
                    option.textContent = `N¬∞${concurrent.numero} - ${concurrent.nom}`;
                    concurrentSelect.appendChild(option);
                });
                concurrentSelect.value = selectedValue;
            }

            function showGrid(type) {
                const title = document.getElementById("grid-title");
                const gridHead = document.querySelector("#grid-table thead");
                const gridBody = document.getElementById("grid-table-body");
                gridBody.innerHTML = "";

                if (type === 'podium') {
                    title.textContent = "Podium Final";
                    gridHead.innerHTML = `<tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase rounded-tl-xl">Position</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">N¬∞</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Concurrent</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase rounded-tr-xl">Meilleur Temps</th></tr>`;
                    const ranked = [...concurrents].sort((a,b) => (a.meilleurTemps || Infinity) - (b.meilleurTemps || Infinity));
                    ranked.forEach((c, i) => {
                        gridBody.innerHTML += `<tr><td class="px-4 py-3 text-sm font-bold">${i+1}</td><td class="px-4 py-3 text-sm">${c.numero}</td><td class="px-4 py-3 text-sm">${c.nom} ${c.isChild ? 'üßí' : ''}</td><td class="px-4 py-3 text-sm font-semibold text-blue-600">${formatTime(c.meilleurTemps)}</td></tr>`;
                    });
                } else { // Previous heat
                    if (currentManche === 1) { alert("Aucune manche pr√©c√©dente √† afficher."); return; }
                    const prevMancheIndex = currentManche - 2;
                    const prevMancheName = prevMancheIndex < 2 ? `Test ${prevMancheIndex + 1}` : `Course ${prevMancheIndex - 1}`;
                    title.textContent = `Classement - ${prevMancheName}`;
                    gridHead.innerHTML = `<tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase rounded-tl-xl">Position</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">N¬∞</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Concurrent</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase rounded-tr-xl">Temps ${prevMancheName}</th></tr>`;
                    const ranked = [...concurrents].filter(c => c.manches[prevMancheIndex] !== null).sort((a,b) => a.manches[prevMancheIndex] - b.manches[prevMancheIndex]);
                     ranked.forEach((c, i) => {
                        gridBody.innerHTML += `<tr><td class="px-4 py-3 text-sm font-bold">${i+1}</td><td class="px-4 py-3 text-sm">${c.numero}</td><td class="px-4 py-3 text-sm">${c.nom} ${c.isChild ? 'üßí' : ''}</td><td class="px-4 py-3 text-sm font-semibold text-blue-600">${formatTime(c.manches[prevMancheIndex])}</td></tr>`;
                    });
                }
                mainApp.style.display="none",gridScreen.style.display="flex"
            }
            startBtn.addEventListener('click', startChrono);
            stopBtn.addEventListener('click', stopChrono);
            resetBtn.addEventListener('click', resetChrono);
            newHeatBtn.addEventListener('click', startNewHeat);
            resetRaceBtn.addEventListener('click', resetRace);
            saveConcurrentsBtn.addEventListener('click', saveConcurrentsData);
            addConcurrentFormAdmin.addEventListener('submit', async e=>{e.preventDefault();const numero = document.getElementById("concurrent-numero").value, nom = document.getElementById("concurrent-nom").value, isChild = document.getElementById("concurrent-enfant").checked;if(concurrents.some(c=>c.numero==numero)){alert("Ce num√©ro de concurrent existe d√©j√†.");return}await addDoc(collection(db, `artifacts/${appId}/public/data/concurrents`),{numero:parseInt(numero),nom:nom, isChild: isChild, manches:new Array(8).fill(null),meilleurTemps:null,tempsTotal:null,documents:{dossier:!1,paiement:{ok:!1,montant:""},assurance:!1},equipements:!1,controle:"√Ä v√©rifier"}),addConcurrentFormAdmin.reset()});
            concurrentSelect.addEventListener("change", () => updateChronoButtons(false)); // Assume chrono is not running on change
            previousHeatBtn.addEventListener('click', () => showGrid('previous'));
            podiumBtn.addEventListener('click', () => showGrid('podium'));
            closeGridBtn.addEventListener('click',()=>{mainApp.style.display="block",gridScreen.style.display="none"});

            // =========================
            // ACCESS LOGIC & INIT
            // =========================
            function renderAccessTable() {
                accessTableBody.innerHTML = "";
                utilisateursAutorises.forEach(user => {
                    const row = document.createElement("tr");
                    const displayRole = user.role;
                    const roleClass = ["Organisation", "Super Admin", "Chrono D√©part", "Chrono Arriv√©e", "MAIRE"].includes(displayRole) ? "bg-blue-100 text-blue-800" : "bg-gray-100 text-gray-800";
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-800">${user.prenom} ${user.nom}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${user.tel}</td>
                        <td class="px-4 py-3 text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${roleClass}">${displayRole}</span></td>
                        <td class="px-4 py-3 text-sm text-gray-500"><button data-id="${user.id}" class="delete-user-btn text-red-500 hover:text-red-700">Supprimer</button></td>
                    `;
                    accessTableBody.appendChild(row);
                });
            
                document.querySelectorAll(".delete-user-btn").forEach(btn => {
                    btn.addEventListener("click", event => {
                        const userId = event.target.dataset.id;
                        const user = utilisateursAutorises.find(u => u.id === userId);
                        if (user.role === 'Super Admin') {
                            alert("Action impossible : vous ne pouvez pas supprimer le Super Admin.");
                            return;
                        }
                        if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${user.prenom} ${user.nom} ?`)) {
                             deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, userId));
                        }
                    });
                });
            }

            addUserForm.addEventListener('submit', async e=>{
                e.preventDefault();
                const newUser = {
                    nom: document.getElementById("user-nom").value.trim().toUpperCase(),
                    prenom: document.getElementById("user-prenom").value.trim(),
                    tel: document.getElementById("user-tel").value.replace(/\s/g, ""),
                    role: document.getElementById("user-role").value
                };
                if (utilisateursAutorises.some(u => u.tel === newUser.tel)) {
                    alert("Un utilisateur avec ce num√©ro de t√©l√©phone existe d√©j√†.");
                    return;
                }
                await addDoc(collection(db, `artifacts/${appId}/public/data/users`), newUser);
                addUserForm.reset();
            });
            

            // =========================
            // PERMISSIONS & FINAL SETUP
            // =========================
            function setupBenevolePermissions() {
                const canEdit = isSuperAdmin || currentUser.role === 'Organisation';
                document.querySelectorAll('#table-body input, #table-body select').forEach(el => {
                    const cell = el.closest('td');
                    if (cell && cell.dataset.column === 'acces') {
                         el.disabled = !isSuperAdmin;
                    } else {
                         el.disabled = !canEdit;
                    }
                });
                 document.querySelectorAll('.delete-benevole-btn, .edit-benevole-btn').forEach(btn => btn.style.display = canEdit ? '' : 'none');
            }

            function setupPermissions() {
                const role = currentUser.role;
                const tabsContainer = document.querySelector('nav[aria-label="Tabs"]');
                let firstVisibleTabId = null;

                const allTabs = ['tab-dashboard', 'tab-concurrents', 'tab-race', 'tab-access'];
                const visibleTabs = {
                    'Organisation': ['tab-dashboard', 'tab-concurrents', 'tab-race'],
                    'Responsable Radio': ['tab-dashboard'],
                    'MAIRE': ['tab-dashboard', 'tab-race'],
                    'Chrono D√©part': ['tab-dashboard', 'tab-race'],
                    'Chrono Arriv√©e': ['tab-dashboard', 'tab-race'],
                    'B√©n√©vole': ['tab-dashboard', 'tab-race'],
                    'Concurrent': ['tab-race']
                };

                allTabs.forEach(tabId => {
                    const tabElement = document.getElementById(tabId);
                    if (tabElement) tabElement.style.display = 'none';
                });

                if (isSuperAdmin) {
                    allTabs.forEach(tabId => {
                        const tabElement = document.getElementById(tabId);
                        if (tabElement) tabElement.style.display = 'block';
                    });
                    firstVisibleTabId = 'tab-dashboard';
                } else if (visibleTabs[role]) {
                    visibleTabs[role].forEach(tabId => {
                        const tabElement = document.getElementById(tabId);
                        if (tabElement) tabElement.style.display = 'block';
                    });
                    firstVisibleTabId = visibleTabs[role][0];
                }
                
                if (firstVisibleTabId) {
                    document.getElementById(firstVisibleTabId).click();
                }
                
                const canEditBenevoles = isSuperAdmin || role === 'Organisation';
                const canEditConcurrents = isSuperAdmin || role === 'Organisation';
                const canSeeChronoAndPodium = isSuperAdmin || role === 'Organisation' || role === 'Chrono D√©part' || role === 'Chrono Arriv√©e' || role === 'MAIRE';
                const canImportExport = isSuperAdmin || role === 'Organisation';
                const isRadioManager = role === 'Responsable Radio';
                const isMaire = role === 'MAIRE';

                if (!canEditBenevoles && !isRadioManager) {
                    document.getElementById('add-benevole-btn').style.display = 'none';
                    document.getElementById('save-btn').style.display = 'none';
                    document.getElementById('missing-info-container').style.display = 'none';
                }
                 if(isRadioManager || isMaire){
                    document.getElementById('add-benevole-btn').style.display = 'none';
                    document.getElementById('missing-info-container').style.display = 'none';
                    document.getElementById('toggleTel').parentElement.style.display = 'none';
                 }
                 if(isMaire) {
                    document.getElementById('save-btn').style.display = 'none';
                 }


                if (!canEditConcurrents) {
                    document.getElementById('add-concurrent-form').style.display = 'none';
                    document.getElementById('save-concurrents-btn').style.display = 'none';
                }
                
                if (!isSuperAdmin) {
                    resetRaceBtn.style.display = 'none';
                }

                if (!canImportExport) {
                    importBtn.style.display = 'none';
                    exportBtn.style.display = 'none';
                }

                const canStartHeat = isSuperAdmin || role === 'Organisation' || role === 'Chrono D√©part';
                if (!canStartHeat) {
                    document.getElementById('new-heat-btn').style.display = 'none';
                }

                if (!canSeeChronoAndPodium) {
                    document.getElementById('chrono-container').style.display = 'none';
                    podiumBtn.style.display = 'none';
                    previousHeatBtn.style.display = 'none';
                    newHeatBtn.style.display = 'none';
                    resetRaceBtn.style.display = 'none';
                }
                
                if (!(isSuperAdmin || currentUser.role === 'Organisation')) {
                    toggleTelCheckbox.parentElement.style.display = 'none';
                }

                updateChronoButtons(false); // Initial state
            }
            
            // Tabs switching logic
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(item => item.classList.remove('active'));
                    tab.classList.add('active');
                    const targetId = tab.id.replace('tab-', 'content-');
                    contents.forEach(content => {
                        content.style.display = content.id === targetId ? 'block' : 'none';
                    });
                });
            });

            // Credits Modal Logic
            document.querySelectorAll('.credits-btn-trigger').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('credits-modal').style.display = 'flex';
                });
            });
            document.getElementById('close-credits-modal-btn').addEventListener('click', () => {
                document.getElementById('credits-modal').style.display = 'none';
            });


            // Import / Export Logic
            exportBtn.addEventListener('click', async () => {
                const benevolesSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/benevoles`));
                const concurrentsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/concurrents`));
                const usersSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/users`));

                const dataToExport = {
                    benevoles: benevolesSnapshot.docs.map(doc => doc.data()),
                    concurrents: concurrentsSnapshot.docs.map(doc => doc.data()),
                    utilisateurs: usersSnapshot.docs.map(doc => doc.data())
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const date = new Date();
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                link.download = `sauvegarde-caisse-a-savon-${dateStr}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });

            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (imported.benevoles && imported.concurrents && imported.utilisateurs) {
                            if (confirm("Voulez-vous vraiment remplacer toutes les donn√©es actuelles par celles du fichier import√© ? Cette action est irr√©versible et supprimera les donn√©es en ligne.")) {
                                
                                // Protection du Super Admin
                                let superAdminInImport = imported.utilisateurs.find(u => u.nom === "POURCEL" && u.prenom === "Romain" && u.tel === "0613255651");
                                if (superAdminInImport) {
                                    superAdminInImport.role = 'Super Admin';
                                } else {
                                    imported.utilisateurs.push({ nom: "POURCEL", prenom: "Romain", tel: "0613255651", role: "Super Admin" });
                                }
                                
                                // Clear existing data
                                const collectionsToDelete = ['benevoles', 'concurrents', 'users'];
                                for (const coll of collectionsToDelete) {
                                    const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/${coll}`));
                                    const deleteBatch = writeBatch(db);
                                    snapshot.docs.forEach(doc => deleteBatch.delete(doc.ref));
                                    await deleteBatch.commit();
                                }

                                // Import new data
                                const importBatch = writeBatch(db);
                                imported.benevoles.forEach(item => {
                                    const docRef = doc(collection(db, `artifacts/${appId}/public/data/benevoles`));
                                    importBatch.set(docRef, item);
                                });
                                imported.concurrents.forEach(item => {
                                    const docRef = doc(collection(db, `artifacts/${appId}/public/data/concurrents`));
                                    importBatch.set(docRef, item);
                                });
                                imported.utilisateurs.forEach(item => {
                                    const docRef = doc(collection(db, `artifacts/${appId}/public/data/users`));
                                    importBatch.set(docRef, item);
                                });
                                await importBatch.commit();
                                
                                alert("Donn√©es import√©es avec succ√®s ! La page va se recharger.");
                                location.reload();
                            }
                        } else {
                            alert("Fichier invalide ou mal format√©. Le fichier doit contenir les cl√©s 'benevoles', 'concurrents' et 'utilisateurs'.");
                        }
                    } catch (error) {
                        alert("Erreur lors de la lecture du fichier. Assurez-vous que c'est un fichier de sauvegarde valide.");
                        console.error("Erreur d'importation:", error);
                    }
                    importFile.value = '';
                };
                reader.readAsText(file);
            });

            // Initial Load Listeners
            onSnapshot(collection(db, `artifacts/${appId}/public/data/benevoles`), (snapshot) => {
                data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBenevolesTable();
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/concurrents`), (snapshot) => {
                concurrents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllConcurrentsView();
            });
            onSnapshot(chronoDocRef, (snapshot) => {
                const chronoData = snapshot.data();
                clearInterval(chronoInterval);

                if (chronoData && chronoData.running) {
                    const startTime = chronoData.startTime;
                    chronoInterval = setInterval(() => updateChronoDisplay(startTime), 10);
                    concurrentSelect.value = chronoData.currentConcurrent;
                    updateChronoButtons(true);
                } else {
                    chronoDisplay.textContent = "00:00:00";
                    updateChronoButtons(false);
                }
            });


            if (isSuperAdmin) { 
                onSnapshot(collection(db, `artifacts/${appId}/public/data/users`), (snapshot) => {
                    utilisateursAutorises = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAccessTable();
                });
            }
            setupPermissions();
        }
        document.addEventListener('DOMContentLoaded', authenticateAndStart);
    </script>
</body>
</html>

