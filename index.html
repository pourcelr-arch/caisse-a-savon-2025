<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application gestion course de caisses à savon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .text-red-500 {
            color: #ef4444;
        }
        #benevoles-table, #concurrents-table, #concurrents-admin-table, #access-table, #race-table {
            table-layout: auto;
            width: max-content;
            min-width: 100%;
        }
        th, td {
            white-space: nowrap;
            padding: 8px 12px;
        }
        input, select {
            background-color: transparent;
            border: none;
            outline: none;
        }
        input:disabled, select:disabled {
            color: #6b7280;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
        }
        /* Styles pour la modale et l'écran de connexion */
        .modal, #login-screen, #starting-grid-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; /* Changé pour flex par défaut */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content, .login-content, .starting-grid-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
        }
        @media (min-width: 768px) {
            .modal-content, .login-content, .starting-grid-content {
                padding: 2rem;
            }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .modal-header h2 {
            font-size: 1.25rem;
        }
         @media (min-width: 768px) {
            .modal-header h2 {
                font-size: 1.5rem;
            }
        }
        .modal-close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        #save-message, #save-concurrents-message, #save-access-message {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #save-message.show, #save-concurrents-message.show, #save-access-message.show {
            opacity: 1;
        }
        /* Styles pour les onglets */
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .admin-sub-tab-button.active {
            border-bottom-color: #dc2626; /* red-600 */
            color: #dc2626;
            font-weight: 600;
        }
        #chrono-display {
            font-family: 'monospace';
            letter-spacing: 2px;
        }
        /* Style pour les boutons désactivés */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Style for control select */
        select.controle-conforme { background-color: #dcfce7; color: #166534; }
        select.controle-nonconforme { background-color: #fee2e2; color: #991b1b; }
        select.controle-àvérifier { background-color: #fef9c3; color: #854d0e; font-weight: bold; }
        input.paiement-input { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.25rem 0.5rem; width: 60px; }
        input:disabled.paiement-input { background-color: #f3f4f6; }
        .time-input {
            border: 1px solid transparent;
            border-radius: 0.25rem;
            padding: 0.25rem;
            width: 70px;
        }
        .time-input:enabled:hover, .time-input:enabled:focus {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* Styles pour les colonnes fixes (sticky) du tableau de course */
        #race-table th:nth-child(1), #race-table td:nth-child(1),
        #race-table th:nth-child(2), #race-table td:nth-child(2) {
            position: -webkit-sticky; /* Pour Safari */
            position: sticky;
            z-index: 10;
        }

        #race-table th:nth-child(1), #race-table td:nth-child(1) { left: 0; }
        #race-table th:nth-child(2), #race-table td:nth-child(2) { left: 50px; }

        #race-table thead th:nth-child(1),
        #race-table thead th:nth-child(2) {
            background-color: #e5e7eb; /* Corresponds to bg-gray-200 */
        }

        #race-table tbody td:nth-child(1),
        #race-table tbody td:nth-child(2) {
            background-color: #ffffff; /* Corresponds to bg-white */
        }

        #race-table th:nth-child(2),
        #race-table td:nth-child(2) {
            border-right: 2px solid #d1d5db; /* Corresponds to border-gray-300 */
        }

        #race-table th:nth-child(1), #race-table td:nth-child(1) { width: 50px; }
        #race-table th:nth-child(2), #race-table td:nth-child(2) { width: 200px; }

        /* Styles pour le tableau de bord concurrent */
        .competitor-card {
             background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
         @media (min-width: 768px) {
            .competitor-card {
                padding: 2rem;
            }
        }
    </style>
</head>
<body class="p-2 sm:p-6">

    <!-- ÉCRAN DE CONNEXION -->
    <div id="login-screen">
        <div id="critical-error-display" class="login-content text-left max-w-lg" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 text-red-600">Erreur de Configuration Critique</h2>
            <div id="critical-error-message" class="space-y-3"></div>
        </div>
        <div id="login-form-container" class="login-content text-center max-w-md">
            <h2 class="text-2xl font-bold mb-4">Accès au tableau de bord</h2>
            <p class="text-gray-600 mb-6">Veuillez vous identifier pour continuer.</p>
            <form id="login-form" class="space-y-4">
                <div><input type="text" id="login-nom" placeholder="Votre Nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><input type="text" id="login-prenom" placeholder="Votre Prénom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><input type="tel" id="login-tel" placeholder="Votre Numéro de téléphone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <p id="login-error" class="text-red-500 text-sm hidden text-left bg-red-50 p-3 rounded-lg border border-red-200">
                    <strong>Informations incorrectes.</strong><br>
                    Veuillez vérifier les points suivants :<br>
                    <ul class="list-disc list-inside mt-1">
                        <li>Le <strong>Nom</strong> doit être en MAJUSCULES.</li>
                        <li>Le <strong>Prénom</strong> doit commencer par une majuscule.</li>
                        <li>Le <strong>Téléphone</strong> ne doit contenir que des chiffres, sans espaces.</li>
                    </ul>
                </p>
                <div class="flex justify-center pt-4"><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200">Se connecter</button></div>
            </form>
        </div>
    </div>

    <!-- ÉCRAN GRILLE DE DÉPART -->
    <div id="starting-grid-screen" style="display: none;">
        <div class="starting-grid-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="grid-title" class="text-2xl font-bold text-gray-800">Grille de Départ</h2>
                <button id="close-grid-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="overflow-y-auto max-h-[80vh]">
                <table class="min-w-full divide-y divide-gray-200" id="grid-table">
                    <thead class="bg-gray-200 sticky top-0">
                        <!-- Headers de la grille générés par JS -->
                    </thead>
                    <tbody id="grid-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE -->
    <div id="main-app" class="max-w-7xl mx-auto" style="display: none;">
        <div class="bg-white shadow-xl rounded-2xl p-4 md:p-6 mb-4">
             <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Tableau de bord - Caisse à Savon</h1>
                    <p class="text-gray-400 text-xs sm:text-sm">Connecté en tant que: <span id="user-info" class="font-semibold"></span></p>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <input type="file" id="import-file" class="hidden" accept=".json">
                    <button id="import-btn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200">Importer</button>
                    <button id="export-btn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200">Exporter</button>
                    <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200">Déconnexion</button>
                </div>
            </div>
        </div>
        
        <div class="mb-4 border-b border-gray-200">
            <nav class="flex space-x-2 sm:space-x-4 overflow-x-auto pb-1" aria-label="Tabs">
                <button id="tab-race" class="tab-button active py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Chrono
                    </span>
                </button>
                <button id="tab-podium" class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M11.293 2.293a1 1 0 011.414 0l.043.043c.293.293.385.737.228 1.114A10.06 10.06 0 0110 5c-1.393 0-2.69.403-3.768 1.114a.999.999 0 01.228-1.114l.043-.043a1 1 0 011.414 0L10 4.414l1.293-1.293zM5 10a5 5 0 1110 0 5 5 0 01-10 0zM10 18a8 8 0 100-16 8 8 0 000 16z" clip-rule="evenodd" />
                        </svg>
                        Podium
                    </span>
                </button>
                <button id="tab-concurrents" class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        Concurrents
                    </span>
                </button>
                <button id="tab-dashboard" class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    <span class="flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                          </svg>
                         Bénévoles & Matériel
                    </span>
                </button>
                <button id="tab-admin" class="tab-button py-4 px-1 border-b-2 font-medium text-sm text-red-600 whitespace-nowrap" style="display: none;">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Administration
                    </span>
                </button>
            </nav>
        </div>
        
        <div id="content-race" class="tab-content">
             <!-- Le contenu de l'onglet Course sera injecté ici par JS -->
        </div>

        <div id="content-podium" class="tab-content" style="display: none;">
            <!-- Le contenu de l'onglet Podium sera injecté ici par JS -->
        </div>

        <div id="content-concurrents" class="tab-content" style="display: none;">
             <!-- Le contenu de l'onglet Concurrents sera injecté ici par JS -->
        </div>
        
        <div id="content-dashboard" class="tab-content" style="display: none;">
             <!-- Le contenu de l'onglet Bénévoles sera injecté ici par JS -->
        </div>

        <div id="content-admin" class="tab-content" style="display: none;">
             <!-- Le contenu de l'onglet Administration sera injecté ici par JS -->
        </div>
        
    </div>

    <!-- VUE DU TABLEAU DE BORD CONCURRENT -->
    <div id="competitor-dashboard-view" class="max-w-7xl mx-auto" style="display: none;">
        <div class="bg-white shadow-xl rounded-2xl p-4 md:p-6 mb-4 flex justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Ma Fiche Concurrent</h1>
            <button id="competitor-logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200">Déconnexion</button>
        </div>
        
        <div class="space-y-6">
            <div class="competitor-card text-center">
                <h2 class="text-xl font-semibold text-gray-500">Bienvenue</h2>
                <p id="competitor-dashboard-name" class="text-4xl font-bold text-blue-600"></p>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <div class="competitor-card text-center">
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Meilleur Temps</h3>
                    <p id="competitor-dashboard-best-time" class="text-5xl font-bold font-mono text-gray-800">-</p>
                </div>
                <div class="competitor-card text-center">
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Classement Général</h3>
                    <p id="competitor-dashboard-rank" class="text-5xl font-bold text-gray-800">-</p>
                </div>
                <div class="competitor-card text-center">
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Écart avec le 1er</h3>
                    <p id="competitor-dashboard-gap" class="text-5xl font-bold font-mono text-red-500">-</p>
                </div>
            </div>

            <div class="competitor-card">
                 <h3 class="text-xl font-semibold text-gray-800 mb-4">Ma Position en Course</h3>
                 <div class="overflow-x-auto">
                     <table class="w-full">
                         <thead>
                             <tr class="border-b-2 border-gray-200">
                                 <th class="p-3 text-left text-xs font-bold uppercase">Classement</th>
                                 <th class="p-3 text-left text-xs font-bold uppercase">Concurrent</th>
                                 <th class="p-3 text-left text-xs font-bold uppercase">Meilleur Temps</th>
                             </tr>
                         </thead>
                         <tbody id="competitor-dashboard-focused-ranking">
                             <!-- Le classement ciblé sera injecté ici -->
                         </tbody>
                     </table>
                 </div>
            </div>

            <div class="competitor-card">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Détail de mes Descentes</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                         <thead>
                             <tr class="border-b-2 border-gray-200" id="competitor-dashboard-times-head">
                                <!-- Les entêtes de manches seront injectées ici -->
                             </tr>
                         </thead>
                         <tbody id="competitor-dashboard-times-body">
                             <!-- Mes temps par manche seront injectés ici -->
                         </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal pour ajouter/modifier un bénévole -->
    <div id="add-benevole-modal" class="modal" style="display:none">
        <!-- Le contenu de la modale sera injecté ici par JS -->
    </div>

    <!-- Modal pour ajouter/modifier un concurrent -->
    <div id="add-concurrent-modal" class="modal" style="display:none">
        <!-- Le contenu de la modale sera injecté ici par JS -->
    </div>
    
    <!-- Modal for Race Time Confirmation -->
    <div id="time-confirmation-modal" class="modal" style="display:none">
        <div class="modal-content max-w-lg text-center bg-gray-900 text-white rounded-2xl shadow-2xl p-6">
            <div id="new-record-banner" class="hidden text-2xl font-bold text-yellow-300 p-2 mb-4 border-2 border-yellow-300 rounded-lg">
                🎉 NOUVEAU RECORD DE LA PISTE ! 🎉
            </div>
            <div class="modal-header justify-center border-b-0 pb-2">
                <h2 id="time-confirm-concurrent" class="text-3xl font-bold text-white"></h2>
            </div>
            <div class="my-4">
                <p id="time-confirm-time" class="text-8xl font-bold text-yellow-400 font-mono"></p>
            </div>
            <div class="space-y-3 text-lg text-gray-300">
                <p id="time-confirm-rank" class="text-2xl"></p>
                <p id="time-confirm-ecart-premier"></p>
                <p id="time-confirm-ecart-precedent"></p>
            </div>
            <div class="flex justify-center mt-6">
                <button id="close-time-confirm-modal-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl text-lg">OK</button>
            </div>
        </div>
    </div>


    <!-- Modal pour les crédits -->
    <div id="credits-modal" class="modal" style="display:none">
        <div class="modal-content max-w-lg">
            <div class="modal-header">
                <h2>Informations sur le projet</h2>
                <button class="modal-close-button" id="close-credits-modal-btn">&times;</button>
            </div>
            <div class="space-y-3 text-sm text-gray-700">
                <p><strong>Projet :</strong> Tableau de bord course caisse à savon</p>
                <p><strong>Auteur principal :</strong> Romain Pourcel</p>
                <p><strong>Contribution :</strong> Louane Pourcel (élève de 5e B au Collège Saint-Joseph CAUDAN) a participé à la réalisation des tableaux des bénévoles.</p>
                <p class="mt-4 pt-4 border-t border-gray-200 text-xs text-gray-500">
                    <em>Remarque : Ce fichier contient du code partiellement généré à l’aide d’un outil d’intelligence artificielle, puis revu et adapté manuellement.</em>
                </p>
            </div>
        </div>
    </div>

     <!-- Modal pour le tutoriel -->
    <div id="tutorial-modal" class="modal" style="display:none">
        <div class="modal-content max-w-lg">
            <div class="modal-header">
                <h2>Bienvenue sur le Tableau de Bord !</h2>
            </div>
            <div class="space-y-4">
                <p>C'est votre première connexion. Souhaitez-vous consulter un guide rapide pour prendre en main les fonctionnalités liées à votre rôle ?</p>
                <div class="flex justify-end gap-4 pt-4">
                    <button id="show-tutorial-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl">Voir le tutoriel</button>
                    <button id="close-tutorial-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl">Non, merci</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmation -->
    <div id="confirm-modal" class="modal" style="display:none">
        <div class="modal-content max-w-sm">
            <div class="modal-header">
               <h2 id="confirm-modal-title" class="text-xl font-bold">Confirmation Requise</h2>
            </div>
            <p id="confirm-modal-text" class="text-gray-600 my-6"></p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl">Annuler</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">Confirmer</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp as initializeFirebaseApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, getDocs, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // SECTION 1: AUTHENTIFICATION
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const competitorDashboardView = document.getElementById('competitor-dashboard-view');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const competitorLogoutBtn = document.getElementById('competitor-logout-btn');
        const userInfo = document.getElementById('user-info');
        
        let currentUser = null;
        let utilisateursAutorises = [];
        let isSuperAdmin = false;
        let db;
        let appId;

        // <!-- ============================================================================== -->
        // <!-- ================== ZONE À MODIFIER / HIGHLIGHTED AREA ================== -->
        // <!-- VEUILLEZ REMPLACER LE BLOC CI-DESSOUS PAR VOTRE CONFIGURATION PERSONNELLE      -->
        // <!-- OBTENUE DEPUIS LA CONSOLE FIREBASE LORS DE L'AJOUT DE VOTRE APPLICATION WEB. -->
        // <!-- ============================================================================== -->
        const firebaseConfig = {
            apiKey: "AIzaSyCu1qYE7eSEheretG2xicIqlRjamgnEavA",
            authDomain: "caisse-a-savon-2025-14a45.firebaseapp.com",
            projectId: "caisse-a-savon-2025-14a45",
            storageBucket: "caisse-a-savon-2025-14a45.appspot.com",
            messagingSenderId: "301217982939",
            appId: "1:301217982939:web:1a1c501328475256661ffe"
        };
        // <!-- ============================================================================== -->
        // <!-- ========================== FIN DE LA ZONE À MODIFIER ========================= -->
        // <!-- ============================================================================== -->

        appId = 'caisse-a-savon-2025'; // Identifiant unique pour vos données
        const app = initializeFirebaseApp(firebaseConfig);
        db = getFirestore(app);
        const auth = getAuth(app);

        // ===================================
        // FONCTIONS UTILITAIRES GLOBALES
        // ===================================
        function formatTime(timeInMillis) {
            if (timeInMillis === null || timeInMillis === Infinity || typeof timeInMillis === 'undefined') return "-";
            const date = new Date(timeInMillis);
            const minutes = String(date.getUTCMinutes()).padStart(2, "0");
            const seconds = String(date.getUTCSeconds()).padStart(2, "0");
            const centiseconds = String(date.getUTCMilliseconds()).padStart(3, "0").slice(0, 2);
            return `${minutes}:${seconds}:${centiseconds}`;
        }

        function formatEcart(timeInMillis) {
            if (timeInMillis === null || timeInMillis === Infinity || typeof timeInMillis === 'undefined' || timeInMillis <= 0) {
                return "-";
            }
            const date = new Date(timeInMillis);
            const minutes = String(date.getUTCMinutes()).padStart(2, "0");
            const seconds = String(date.getUTCSeconds()).padStart(2, "0");
            const centiseconds = String(date.getUTCMilliseconds()).padStart(3, "0").slice(0, 2);
            return `+${minutes}:${seconds}:${centiseconds}`;
        }


        async function authenticateAndStart() {
            try {
                await signInAnonymously(auth);
                await loadAccessData();
                checkSavedLogin();
            } catch (error) {
                console.error("Erreur d'authentification Firebase:", error);
                
                document.getElementById('login-form-container').style.display = 'none';
                const errorDisplay = document.getElementById('critical-error-display');
                const errorMessageContainer = document.getElementById('critical-error-message');
                errorDisplay.style.display = 'block';

                let errorHtml = "";
                
                if (error.code === 'auth/configuration-not-found') {
                    errorHtml = `
                        <p class="font-semibold text-lg">Problème de configuration Firebase détecté.</p>
                        <p class="mt-2">L'application ne peut pas démarrer car la connexion "Anonyme" n'est pas activée. C'est une étape de configuration <strong>obligatoire</strong>.</p>
                        <strong class="block mt-4">Comment corriger :</strong>
                        <ol class="list-decimal list-inside space-y-2 mt-2">
                            <li>Ouvrez la <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">console Firebase</a> de votre projet.</li>
                            <li>Cliquez sur <strong>"Authentication"</strong> dans le menu de gauche (section "Build").</li>
                            <li>Allez sur l'onglet <strong>"Sign-in method"</strong>.</li>
                            <li>Dans la liste, trouvez <strong>"Anonyme"</strong> et cliquez dessus.</li>
                            <li>Activez l'interrupteur et enregistrez.</li>
                        </ol>
                        <p class="mt-4">Après avoir fait cette modification, veuillez <strong>rafraîchir cette page</strong> pour utiliser l'application.</p>
                    `;
                } else if (error.code === 'auth/api-key-not-valid') {
                     errorHtml = `
                        <p class="font-semibold">La clé API (apiKey) dans votre configuration Firebase est invalide.</p>
                        <p>Cela signifie que la configuration Firebase dans le code est incorrecte ou a mal été copiée.</p>
                        <strong class="block mt-4">POUR CORRIGER :</strong>
                        <ol class="list-decimal list-inside space-y-2 mt-2">
                            <li>Retournez dans les paramètres de votre projet sur la <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">console Firebase</a>.</li>
                            <li>Copiez à nouveau et avec attention l'objet de configuration <code>firebaseConfig</code>.</li>
                            <li>Collez-le dans le fichier <code>index.html</code> en vous assurant de remplacer entièrement le bloc d'exemple.</li>
                        </ol>
                       `;
                } else {
                    errorHtml = `<p>Une erreur inattendue est survenue. Veuillez vérifier la console du navigateur pour plus de détails.</p><p class="mt-2 text-sm text-gray-500">Code d'erreur : ${error.code}</p>`;
                }
                
                errorMessageContainer.innerHTML = errorHtml;
            }
        }
        
        function checkSavedLogin() {
            const savedUserStr = localStorage.getItem('currentUser');
            if (savedUserStr) {
                const savedUser = JSON.parse(savedUserStr);
                 const foundUser = utilisateursAutorises.find(user => user.id === savedUser.id);
                  if (foundUser) {
                      if (foundUser.role === 'Concurrent') {
                          if (foundUser.linkedCompetitorId) {
                            loginScreen.style.display = 'none';
                            competitorDashboardView.style.display = 'block';
                            startCompetitorLogic(foundUser.linkedCompetitorId);
                          } else {
                            // Cas d'erreur : un concurrent sans concurrent lié. On le déconnecte.
                            localStorage.removeItem('currentUser');
                          }
                      } else {
                          currentUser = foundUser;
                          isSuperAdmin = (currentUser.nom === "POURCEL" && currentUser.prenom === "Romain" && currentUser.tel === "0613255651") || currentUser.role === 'Super Admin';
                          loginScreen.style.display = 'none';
                          mainApp.style.display = 'block';
                          userInfo.textContent = `${currentUser.prenom} ${currentUser.nom} (${isSuperAdmin ? 'Super Admin' : currentUser.role})`;
                          startAppLogic();
                      }
                   } else {
                       localStorage.removeItem('currentUser');
                   }
            }
        }

        function loadAccessData() {
            return new Promise((resolve, reject) => {
                const usersCollection = collection(db, `artifacts/${appId}/public/data/users`);
                const unsubscribe = onSnapshot(usersCollection,
                    (snapshot) => {
                        utilisateursAutorises = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log("Utilisateurs chargés depuis Firestore :", JSON.parse(JSON.stringify(utilisateursAutorises)));
                        resolve();
                    },
                    (error) => {
                        console.error("Erreur de lecture (Firestore):", error);
                        if(error.code === 'permission-denied') {
                            showConfirmationModal("Erreur de permission. Assurez-vous que les règles de sécurité de votre base de données Firestore sont correctement configurées ET que la structure des données (dossiers et sous-dossiers) a été créée exactement comme indiqué dans le guide.", () => {});
                        } else {
                             showConfirmationModal("Une erreur de base de données est survenue.", () => {});
                        }
                        reject(error);
                    }
                );
            });
        }
        
        function removeAccents(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nomInput = document.getElementById('login-nom').value.trim();
            const prenomInput = document.getElementById('login-prenom').value.trim();
            const tel = document.getElementById('login-tel').value.replace(/\s/g, '');

            const normalizedNomInput = removeAccents(nomInput.toUpperCase());
            const normalizedPrenomInput = removeAccents(prenomInput.toLowerCase());
            
            const foundUser = utilisateursAutorises.find(user => {
                const normalizedUserNom = removeAccents(String(user.nom).trim().toUpperCase());
                const normalizedUserPrenom = removeAccents(String(user.prenom).trim().toLowerCase());
                return normalizedUserNom === normalizedNomInput &&
                       normalizedUserPrenom === normalizedPrenomInput &&
                       String(user.tel).replace(/\s/g, '') === tel;
            });

            if (foundUser) {
                localStorage.setItem('currentUser', JSON.stringify(foundUser));

                if (foundUser.role === 'Concurrent') {
                    if (foundUser.linkedCompetitorId) {
                        loginScreen.style.display = 'none';
                        competitorDashboardView.style.display = 'block';
                        startCompetitorLogic(foundUser.linkedCompetitorId);
                    } else {
                        loginError.innerHTML = "<strong>Erreur de compte.</strong><br>Votre accès concurrent n'est lié à aucune fiche. Veuillez contacter un administrateur.";
                        loginError.classList.remove('hidden');
                        localStorage.removeItem('currentUser');
                    }
                } else {
                    currentUser = foundUser;
                    isSuperAdmin = (currentUser.nom === "POURCEL" && currentUser.prenom === "Romain" && currentUser.tel === "0613255651") || currentUser.role === 'Super Admin';
                    loginScreen.style.display = 'none';
                    mainApp.style.display = 'block';
                    userInfo.textContent = `${currentUser.prenom} ${currentUser.nom} (${isSuperAdmin ? 'Super Admin' : currentUser.role})`;
                    startAppLogic();
                    showTutorialModalIfNeeded();
                }
            } else {
                loginError.innerHTML = `<strong>Informations incorrectes.</strong><br>
                    Veuillez vérifier les points suivants :<br>
                    <ul class="list-disc list-inside mt-1">
                        <li>Le <strong>Nom</strong> doit être en MAJUSCULES.</li>
                        <li>Le <strong>Prénom</strong> doit commencer par une majuscule.</li>
                        <li>Le <strong>Téléphone</strong> ne doit contenir que des chiffres, sans espaces.</li>
                    </ul>`;
                loginError.classList.remove('hidden');
            }
        });


        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('tutorialShown');
            location.reload();
        });
        competitorLogoutBtn.addEventListener('click', () => {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('tutorialShown');
            location.reload();
        });


        // SECTION 2: LOGIQUE DE L'APPLICATION
        function startAppLogic() {
            let editingBenevoleId = null;
            let editingConcurrentId = null;
            let editingUserId = null;
            let modalTimeout = null;
            
            const creditsButtonHTML = `<div class="text-center text-gray-400 text-xs my-2"><button class="credits-btn-trigger hover:underline text-blue-500">Application web créée Par</button></div>`;

            // Confirmation Modal Logic
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalText = document.getElementById('confirm-modal-text');
            let confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
            let confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');

            function showConfirmationModal(text, onConfirm, title = "Confirmation Requise") {
                confirmModalTitle.textContent = title;
                confirmModalText.innerHTML = text;
                confirmModal.style.display = 'flex';

                let newConfirmBtn = confirmModalConfirmBtn.cloneNode(true);
                confirmModalConfirmBtn.parentNode.replaceChild(newConfirmBtn, confirmModalConfirmBtn);
                confirmModalConfirmBtn = newConfirmBtn;

                let newCancelBtn = confirmModalCancelBtn.cloneNode(true);
                confirmModalCancelBtn.parentNode.replaceChild(newCancelBtn, confirmModalCancelBtn);
                confirmModalCancelBtn = newCancelBtn;

                confirmModalConfirmBtn.onclick = () => {
                    confirmModal.style.display = 'none';
                    onConfirm();
                };
                confirmModalCancelBtn.onclick = () => {
                    confirmModal.style.display = 'none';
                };
            }

            // -- Inject HTML content for tabs --
            document.getElementById('content-dashboard').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-4 md:p-6"><h2 class="text-xl font-bold text-gray-800 mb-4">Suivi du matériel</h2><div class="mb-8 p-4 bg-yellow-50 rounded-xl shadow-inner border-l-4 border-yellow-400 flex flex-wrap justify-between items-center text-sm md:text-base gap-4"><div class="flex flex-col items-center"><div class="flex items-center space-x-2"><span class="font-medium text-gray-700">Radios:</span><span class="font-bold text-blue-600" id="radios-distribuees">0</span><span class="text-gray-500">D</span><span class="font-bold text-green-600" id="radios-restituees">0</span><span class="text-gray-500">R</span></div><div class="flex items-center space-x-2 mt-1"><span class="font-medium text-red-500">Manquantes:</span><span class="font-bold text-lg text-red-500" id="radios-manquantes">0</span></div></div><div class="flex-grow"></div><div class="flex flex-col items-center"><div class="flex items-center space-x-2"><span class="font-medium text-gray-700">Sifflets:</span><span class="font-bold text-blue-600" id="sifflets-distribues">0</span><span class="text-gray-500">D</span><span class="font-bold text-green-600" id="sifflets-restituees">0</span><span class="text-gray-500">R</span></div><div class="flex items-center space-x-2 mt-1"><span class="font-medium text-red-500">Manquants:</span><span class="font-bold text-lg text-red-500" id="sifflets-manquants">0</span></div></div><div class="flex-grow"></div><div class="flex items-center space-x-2 mt-4 md:mt-0"><span class="font-medium text-gray-700">Appareils manquants:</span><span class="font-bold text-2xl text-red-500" id="appareils-manquants">0</span></div></div><h2 class="text-xl font-bold text-gray-800 mb-4">Liste des bénévoles</h2><div class="flex flex-col lg:flex-row justify-between items-center mb-4 gap-4"><div class="flex flex-wrap items-end gap-4"><button id="add-benevole-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200">+ Ajouter</button></div><div class="w-full lg:w-auto flex-grow flex flex-col sm:flex-row justify-center items-center gap-2"><input type="text" id="filter-input" placeholder="Rechercher par nom..." class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full max-w-xs"><select id="filter-fonction" class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full sm:w-auto"></select><select id="filter-lieu" class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full sm:w-auto"></select></div><div class="flex items-center gap-4 flex-wrap"><div class="flex items-center gap-2" id="missing-info-container"><input type="checkbox" id="filter-missing-info" class="form-checkbox h-4 w-4 text-red-600 rounded"><label for="filter-missing-info" class="text-sm font-medium text-gray-700 select-none">Infos manquantes ❌</label></div><div class="flex items-center gap-2"><input type="checkbox" id="toggleTel" class="form-checkbox h-4 w-4 text-blue-600 rounded"><label for="toggleTel" class="text-sm font-medium text-gray-700 select-none">Masquer Tél.</label></div><div class="flex items-center gap-2"><span id="save-message" class="text-green-600 font-bold"></span><button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200">Sauvegarder</button></div></div></div><div class="bg-gray-100 p-2 md:p-4 rounded-xl overflow-x-auto shadow-inner"><table class="divide-y divide-gray-200" id="benevoles-table"><thead class="bg-gray-200 sticky top-0 z-10"><tr><th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider rounded-tl-xl">Nom & Prénom</th><th data-column="tel" class="px-4 py-3 text-left text-xs font-bold uppercase">Téléphone</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Jours de présence</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Lieu d'affectation 📍</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Fonction 💼</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Matériel (D/R)</th><th data-column="zello" class="px-4 py-3 text-left text-xs font-bold uppercase">Zello 📻</th><th data-column="acces" class="px-4 py-3 text-left text-xs font-bold uppercase">Accès</th><th data-column="action" class="px-4 py-3 text-left text-xs font-bold uppercase rounded-tr-xl">Action</th></tr></thead><tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>` + creditsButtonHTML;
            document.getElementById('content-concurrents').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-4 md:p-6"><div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><h2 class="text-xl font-bold text-gray-800">Liste des Concurrents</h2><input type="text" id="filter-concurrents-input" placeholder="Rechercher un concurrent..." class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full sm:w-auto"><div class="flex items-center gap-4"><button id="add-concurrent-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200 text-sm">+ Ajouter un Concurrent</button><div><span id="save-concurrents-message" class="text-green-600 font-bold mr-4"></span><button id="save-concurrents-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-xl shadow-lg transition duration-200 text-sm">Sauvegarder</button></div></div></div><div class="bg-gray-100 p-2 md:p-4 rounded-xl overflow-x-auto shadow-inner"><table id="concurrents-admin-table" class="divide-y divide-gray-200"><thead class="bg-gray-200"><tr><th class="px-4 py-3 text-left text-xs font-bold uppercase rounded-tl-xl">Concurrent</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Enfant</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Dossier Inscription</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Assurance</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Paiement Cotisation</th><th class="px-4 py-3 text-center text-xs font-bold uppercase">Équipements Sécurité</th><th class="px-4 py-3 text-left text-xs font-bold uppercase">Contrôle Tech.</th><th class="px-4 py-3 text-left text-xs font-bold uppercase rounded-tr-xl">Action</th></tr></thead><tbody id="concurrents-admin-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>` + creditsButtonHTML;
            document.getElementById('content-race').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-4 md:p-6"><div id="chrono-container" class="mb-6 p-4 md:p-6 bg-gray-50 rounded-2xl shadow-inner"><div class="text-center mb-4"><h2 id="current-manche-display" class="text-3xl font-bold text-blue-600"></h2></div><div class="max-w-md mx-auto"><div class="mb-4"><label for="chrono-search-input" class="block text-sm font-medium text-gray-700 mb-1">Concurrent au départ (par nom)</label><input type="text" id="chrono-search-input" list="concurrents-datalist" placeholder="Rechercher..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><datalist id="concurrents-datalist"></datalist></div><div id="selected-concurrent-display" class="text-center font-bold text-xl text-gray-700 h-8 mb-4"></div><div id="chrono-display" class="text-5xl font-bold text-center text-blue-600 bg-white p-4 rounded-xl mb-4 shadow">00:00:00</div><div class="grid grid-cols-2 gap-3 mt-auto"><button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200" disabled>Démarrer</button><button id="stop-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200" disabled>Arrêter et Enregistrer</button><button id="reset-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200 col-span-2">Réinitialiser</button></div></div></div><div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><h2 class="text-xl font-bold text-gray-800">Classement de la Course</h2><input type="text" id="filter-race-input" placeholder="Rechercher un concurrent..." class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full sm:w-auto"><div class="flex items-center gap-2 flex-wrap justify-center sm:justify-end"><button id="reset-race-btn" class="bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded-xl transition duration-200">Réinitialiser Course</button><button id="new-heat-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200">Manche Suivante</button></div></div><div id="race-table-container" class="bg-gray-100 p-2 md:p-4 rounded-xl shadow-inner overflow-x-auto"><table id="race-table" class="divide-y divide-gray-200"><thead id="race-table-head" class="bg-gray-200 sticky top-0"></thead><tbody id="race-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>` + creditsButtonHTML;
            document.getElementById('content-podium').innerHTML = creditsButtonHTML + `<div class="bg-white shadow-xl rounded-2xl p-4 md:p-6"><h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Résultats & Podiums</h2><div class="flex flex-col sm:flex-row justify-center items-center gap-4 flex-wrap"><button id="current-heat-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 text-lg">Course en cours</button><button id="previous-heat-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 text-lg">Temps Course Précédente</button><button id="podium-fastest-lap-btn" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-6 rounded-xl transition duration-200 text-lg">Podium Descente Rapide</button><button id="podium-grand-prix-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 text-lg">Podium Grand Prix</button></div></div>` + creditsButtonHTML;
            document.getElementById('content-admin').innerHTML = creditsButtonHTML + `
                <div class="bg-white shadow-xl rounded-2xl p-4 md:p-6">
                    <div class="mb-6 border-b border-gray-200">
                         <nav class="flex space-x-4" aria-label="Admin Tabs">
                            <button id="show-access-btn" class="admin-sub-tab-button active py-2 px-4 border-b-2 font-medium text-sm">Gestion des Accès</button>
                            <button id="show-reset-btn" class="admin-sub-tab-button py-2 px-4 border-b-2 font-medium text-sm">Réinitialisation</button>
                        </nav>
                    </div>

                    <div id="admin-access-section">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><div><h2 class="text-xl font-bold text-gray-800">Gérer les utilisateurs autorisés</h2><p class="text-gray-600 text-sm">Seuls les utilisateurs listés ici peuvent se connecter.</p></div><input type="text" id="filter-access-input" placeholder="Rechercher un utilisateur..." class="px-3 py-2 border border-gray-300 rounded-xl shadow-sm w-full sm:w-auto"></div><form id="add-user-form" class="mb-8 p-4 bg-gray-50 rounded-xl border border-gray-200 flex flex-wrap items-end gap-4"><div class="flex-grow min-w-[150px]"><label for="user-nom" class="block text-sm font-medium text-gray-700">Nom</label><input type="text" id="user-nom" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex-grow min-w-[150px]"><label for="user-prenom" class="block text-sm font-medium text-gray-700">Prénom</label><input type="text" id="user-prenom" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex-grow min-w-[150px]"><label for="user-tel" class="block text-sm font-medium text-gray-700">Téléphone</label><input type="tel" id="user-tel" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex-grow min-w-[150px]"><label for="user-role" class="block text-sm font-medium text-gray-700">Rôle</label><select id="user-role" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"><option value="Super Admin">Super Admin</option><option value="Organisation">Organisation</option><option value="Responsable Radio">Responsable Radio</option><option value="MAIRE">MAIRE</option><option value="Chrono Départ">Chrono Départ</option><option value="Chrono Arrivée">Chrono Arrivée</option><option value="Bénévole">Bénévole</option><option value="Concurrent">Concurrent</option></select></div><div id="user-competitor-link-container" class="flex-grow min-w-[150px]" style="display:none;"><label for="user-competitor-select" class="block text-sm font-medium text-gray-700">Concurrent Lié</label><select id="user-competitor-select" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></select></div><div class="flex items-center gap-2"><button type="submit" id="add-user-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl">+ Ajouter</button><button type="button" id="cancel-edit-user-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl" style="display:none;">Annuler</button></div></form><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Nom Prénom</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Téléphone</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Rôle</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Action</th></tr></thead><tbody id="access-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                    </div>

                    <div id="admin-reset-section" style="display: none;">
                         <h2 class="text-xl font-bold text-red-700 mb-2">Zone de Réinitialisation</h2><p class="text-gray-600 mb-6">Attention, les actions sur cette page sont irréversibles et supprimeront définitivement les données de la base.</p><div class="space-y-6"><div class="border border-red-200 bg-red-50 p-4 rounded-lg"><h3 class="font-bold text-lg text-red-800">Réinitialiser les Bénévoles</h3><p class="text-red-700 my-2">Cette action supprimera <strong>TOUS</strong> les bénévoles de la base de données.</p><button id="reset-benevoles-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">Réinitialiser les Bénévoles</button></div><div class="border border-red-200 bg-red-50 p-4 rounded-lg"><h3 class="font-bold text-lg text-red-800">Réinitialiser la Course</h3><p class="text-red-700 my-2">Cette action supprimera <strong>TOUS</strong> les concurrents et <strong>TOUS</strong> les temps de course enregistrés. La course sera remise à zéro (Manche 1).</p><button id="reset-concurrents-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">Réinitialiser les Concurrents et la Course</button></div><div class="border border-red-200 bg-red-50 p-4 rounded-lg"><h3 class="font-bold text-lg text-red-800">Réinitialiser les Accès</h3><p class="text-red-700 my-2">Cette action supprimera <strong>TOUS</strong> les utilisateurs, <strong>SAUF</strong> le Super Administrateur.</p><button id="reset-access-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">Réinitialiser les Accès</button></div></div>
                    </div>
                </div>
            ` + creditsButtonHTML;

            document.getElementById('add-benevole-modal').innerHTML = `<div class="modal-content max-w-md"><div class="modal-header"><h2 id="modal-title">Ajouter un nouveau bénévole</h2><button class="modal-close-button" id="close-modal-btn">&times;</button></div><form id="add-benevole-form" class="space-y-4"><div><label for="nom" class="block text-sm font-medium text-gray-700">Nom</label><input type="text" id="nom" name="nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div><div><label for="prenom" class="block text-sm font-medium text-gray-700">Prénom</label><input type="text" id="prenom" name="prenom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div><div><label for="tel" class="block text-sm font-medium text-gray-700">Téléphone</label><input type="text" id="tel" name="tel" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex justify-end pt-4"><button type="submit" id="modal-submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl">Ajouter</button></div></form></div>`;
            document.getElementById('add-concurrent-modal').innerHTML = `<div class="modal-content max-w-md"><div class="modal-header"><h2 id="concurrent-modal-title">Ajouter un Concurrent</h2><button class="modal-close-button" id="close-concurrent-modal-btn">&times;</button></div><form id="add-concurrent-form-modal" class="space-y-4"><div><label for="concurrent-nom-modal" class="block text-sm font-medium text-gray-700">Nom Concurrent / Équipe</label><input type="text" id="concurrent-nom-modal" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="flex items-center"><input type="checkbox" id="concurrent-enfant-modal" class="h-4 w-4 text-blue-600 rounded mr-2"><label for="concurrent-enfant-modal" class="text-sm font-medium text-gray-700">Enfant 🧒</label></div><div class="flex justify-end pt-4"><button type="submit" id="concurrent-modal-submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl">Ajouter</button></div></form></div>`;
            
            // Re-select all elements after injection
            const tableBody = document.getElementById('table-body'), toggleTelCheckbox = document.getElementById('toggleTel'), addBenevoleBtn = document.getElementById('add-benevole-btn'), saveBtn = document.getElementById('save-btn'), closeModalBtn = document.getElementById('close-modal-btn'), addBenevoleForm = document.getElementById('add-benevole-form'), filterInput = document.getElementById('filter-input'), filterMissingInfoCheckbox = document.getElementById('filter-missing-info'), filterFonction = document.getElementById('filter-fonction'), filterLieu = document.getElementById('filter-lieu');
            const chronoDisplay=document.getElementById("chrono-display"),startBtn=document.getElementById("start-btn"),stopBtn=document.getElementById("stop-btn"),resetBtn=document.getElementById("reset-btn"),addConcurrentBtn = document.getElementById('add-concurrent-btn'),concurrentsAdminBody = document.getElementById('concurrents-admin-body'),saveConcurrentsBtn = document.getElementById('save-concurrents-btn'),saveConcurrentsMessage = document.getElementById('save-concurrents-message'),addUserForm = document.getElementById('add-user-form'),accessTableBody = document.getElementById('access-table-body'), newHeatBtn = document.getElementById('new-heat-btn'), previousHeatBtn = document.getElementById('previous-heat-btn'), currentMancheDisplay = document.getElementById('current-manche-display'), gridScreen=document.getElementById("starting-grid-screen"),closeGridBtn=document.getElementById("close-grid-btn"), resetRaceBtn = document.getElementById('reset-race-btn'), importBtn = document.getElementById('import-btn'), exportBtn = document.getElementById('export-btn'), importFile = document.getElementById('import-file'), creditsModal = document.getElementById('credits-modal'), closeCreditsModalBtn = document.getElementById('close-credits-modal-btn'), addConcurrentModal = document.getElementById('add-concurrent-modal'), closeConcurrentModalBtn = document.getElementById('close-concurrent-modal-btn'), addConcurrentFormModal = document.getElementById('add-concurrent-form-modal'), cancelEditUserBtn = document.getElementById('cancel-edit-user-btn'), addUserBtn = document.getElementById('add-user-btn'), filterConcurrentsInput = document.getElementById('filter-concurrents-input'), filterRaceInput = document.getElementById('filter-race-input'), filterAccessInput = document.getElementById('filter-access-input'), resetBenevolesBtn = document.getElementById('reset-benevoles-btn'), resetConcurrentsBtn = document.getElementById('reset-concurrents-btn'), chronoSearchInput = document.getElementById('chrono-search-input'), concurrentsDatalist = document.getElementById('concurrents-datalist'), selectedConcurrentDisplay = document.getElementById('selected-concurrent-display'), timeConfirmationModal = document.getElementById('time-confirmation-modal'), closeTimeConfirmModalBtn = document.getElementById('close-time-confirm-modal-btn');
            const podiumFastestLapBtn = document.getElementById('podium-fastest-lap-btn');
            const podiumGrandPrixBtn = document.getElementById('podium-grand-prix-btn');
            const currentHeatBtn = document.getElementById('current-heat-btn');
            
            // =========================
            // BÉNÉVOLES LOGIC
            // =========================
            let data = [];
            const rolesOptions = ["Aucun accès", "Super Admin", "Organisation", "Responsable Radio", "MAIRE", "Chrono Départ", "Chrono Arrivée", "Bénévole", "Concurrent"];
            const joursOptions=["Samedi","Dimanche","Samedi/Dimanche","Non renseigné"],fonctionOptions=["Organisateur 🧑‍💼","Accueil / Inscriptions 📝","Contrôle Technique 🛠️","Sécurité Piste 🚧","Commissaire de Course 🚦","Chronométrage ⏱️","Logistique 🚚","Relations Compétiteurs 👋","Espace Convivialité -Bénévoles 🧑‍🤝‍🧑","Remontée des Caisses 🚜","Speaker 📢","Photographe 📸","Responsable Radio 📻","Pôle de Départ 🏁","Pôle d'Arrivée ✅","Podium 🏆","Secrétariat 📋","Responsable Expo voiture 🚗","Soutien opérationnel","À définir"],lieuOptions=["Mobile sur l'ensemble du parcours","Parc Concurrents","Piste de Course","Grille de Départ","Contrôle Technique","Espace Bénévoles","Rue de l'étang","Rue des Ajoncs","Rue Maréchal Leclerc","Rue Général De Gaulle","Rue Général Déborde","Rue des Écoles","Rue Madame Gadot","Rue Saint-Joseph","Rue François Le Bail","Ligne d'arrivée","Garage Motrio", "Mur de Carton", "À définir"];
            
            const benevolesCollection = collection(db, `artifacts/${appId}/public/data/benevoles`);
            onSnapshot(benevolesCollection, (snapshot) => {
                data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBenevolesTable();
            });

            function populateFilter(selectElement, optionsArray, defaultLabel) {
                selectElement.innerHTML = `<option value="all">${defaultLabel}</option>`;
                optionsArray.forEach(option => {
                    selectElement.innerHTML += `<option value="${option}">${option}</option>`;
                });
            }
            populateFilter(filterFonction, fonctionOptions, 'Toutes les fonctions');
            populateFilter(filterLieu, lieuOptions, 'Tous les lieux');

            async function saveBenevolesData() {
                const batch = writeBatch(db);
                data.forEach(benevole => {
                    const { id, ...benevoleData } = benevole;
                    const docRef = doc(db, `artifacts/${appId}/public/data/benevoles`, id);
                    batch.update(docRef, benevoleData);
                });
                await batch.commit();
                const saveMessage = document.getElementById("save-message");
                saveMessage.textContent="Données sauvegardées !";
                saveMessage.classList.add("show");
                setTimeout(() => { saveMessage.classList.remove("show") }, 3000);
            }
            
            function updateAccessFromBenevole(benevole, newRole) {
                const cleanBenevoleTel = String(benevole.tel || '').replace(/\s/g, '');
                // Ne rien faire si le numéro de téléphone est vide ou non renseigné
                if (!cleanBenevoleTel || cleanBenevoleTel.toLowerCase() === "nonrenseigné") return;

                const existingUser = utilisateursAutorises.find(u => String(u.tel || '').replace(/\s/g, '') === cleanBenevoleTel);

                if (newRole === 'Aucun accès') {
                    if (existingUser) {
                        deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, existingUser.id));
                    }
                } else {
                     if (existingUser) {
                        // Mettre à jour le rôle et s'assurer que le numéro de téléphone est propre
                        updateDoc(doc(db, `artifacts/${appId}/public/data/users`, existingUser.id), { role: newRole, tel: cleanBenevoleTel });
                    } else {
                        // Créer un nouvel utilisateur avec un numéro de téléphone propre
                        addDoc(collection(db, `artifacts/${appId}/public/data/users`), {
                            nom: benevole.nom,
                            prenom: benevole.prenom,
                            tel: cleanBenevoleTel,
                            role: newRole
                        });
                    }
                }
            }

            function createBenevoleSelect(options, currentValue, personIndex, property, disabled = false) {
                const select = document.createElement("select");
                select.className = "py-1 px-2 border-gray-200 rounded-md shadow-sm text-sm w-full";
                select.disabled = disabled;
                
                options.forEach(optionValue => {
                    const option = document.createElement("option");
                    option.value = optionValue;
                    option.textContent = optionValue;
                    if (optionValue === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                select.addEventListener("change", () => {
                    if (property === "role") {
                        const benevole = data[personIndex];
                        if (benevole) {
                            updateAccessFromBenevole(benevole, select.value);
                        }
                    } else {
                        data[personIndex][property] = select.value;
                    }

                    if (property === 'fonction') {
                          const benevole = data[personIndex];
                          const user = utilisateursAutorises.find(u => u.tel === benevole.tel);
                          const currentRole = user ? user.role : 'Aucun accès';
                        if (!['Super Admin', 'Organisation', 'Chrono Départ', 'Chrono Arrivée', 'MAIRE'].includes(currentRole)) {
                            if (select.value === 'Responsable Radio 📻') {
                                updateAccessFromBenevole(benevole, 'Responsable Radio');
                            } else {
                                updateAccessFromBenevole(benevole, 'Bénévole');
                            }
                        }
                    }
                });
                
                return select;
            }

            function openBenevoleModal(benevoleId = null) {
                const modal = document.getElementById('add-benevole-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalSubmitBtn = document.getElementById('modal-submit-btn');
                
                addBenevoleForm.reset();

                if (benevoleId) {
                    editingBenevoleId = benevoleId;
                    const benevole = data.find(b => b.id === benevoleId);
                    modalTitle.textContent = "Modifier le bénévole";
                    modalSubmitBtn.textContent = "Enregistrer";
                    document.getElementById('nom').value = benevole.nom;
                    document.getElementById('prenom').value = benevole.prenom;
                    document.getElementById('tel').value = benevole.tel;
                } else {
                    editingBenevoleId = null;
                    modalTitle.textContent = "Ajouter un nouveau bénévole";
                    modalSubmitBtn.textContent = "Ajouter";
                }
                modal.style.display = 'flex';
            }

            function renderBenevolesTable() {
                const filterValue = filterInput.value.toLowerCase();
                const fonctionFilter = filterFonction.value;
                const lieuFilter = filterLieu.value;
                const missingInfoOnly = filterMissingInfoCheckbox.checked;

                let dataToRender = data.filter(p => 
                    (`${p.nom} ${p.prenom}`.toLowerCase().includes(filterValue)) &&
                    (fonctionFilter === 'all' || p.fonction === fonctionFilter) &&
                    (lieuFilter === 'all' || p.lieu === lieuFilter)
                );

                if (missingInfoOnly) {
                    dataToRender = dataToRender.filter(p => p.tel === "Non renseigné" || p.jours === "Non renseigné" || p.lieu === "À définir" || p.fonction === "À définir");
                }

                tableBody.innerHTML = "";
                const headerRow = document.querySelector("#benevoles-table thead tr");
                const canManage = isSuperAdmin || currentUser.role === 'Organisation';
                const isRadioManager = currentUser.role === 'Responsable Radio';

                // Gérer la visibilité des colonnes dans l'en-tête
                headerRow.querySelector('[data-column="tel"]').style.display = canManage ? '' : 'none';
                headerRow.querySelector('[data-column="zello"]').style.display = canManage || isRadioManager ? '' : 'none';
                headerRow.querySelector('[data-column="acces"]').style.display = isSuperAdmin ? '' : 'none';
                headerRow.querySelector('[data-column="action"]').style.display = canManage ? '' : 'none';

                dataToRender.forEach((person) => {
                    const personIndex = data.findIndex(p => p.id === person.id);
                    const row = document.createElement('tr');
                    const cleanTel = String(person.tel || '').replace(/\s/g, '');
                    const hasValidTel = person.tel && person.tel !== "Non renseigné" && cleanTel.length > 0;

                    row.innerHTML = `
                        <td class="px-4 py-3"><input type="text" value="${person.nom} ${person.prenom}" class="w-full text-sm"></td>
                        <td data-column="tel" class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <input type="tel" value="${person.tel}" class="flex-grow w-full text-sm ${!hasValidTel ? "text-red-500" : ""}">
                                <a href="tel:${cleanTel}" class="${!hasValidTel ? 'hidden' : ''} text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition-colors" title="Appeler ${person.prenom}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
                                </a>
                                <span class="${hasValidTel ? 'hidden' : ''} text-red-500 p-1" title="Numéro manquant">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </span>
                            </div>
                        </td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3"></td>
                        <td data-column="zello" class="px-4 py-3 text-center"><input type="checkbox" ${person.zello ? "checked" : ""}></td>
                        <td data-column="acces" class="px-4 py-3"></td>
                        <td data-column="action" class="px-4 py-3 text-center">
                            <div class="flex items-center gap-2 justify-center">
                                <button data-id="${person.id}" class="edit-benevole-btn text-blue-600 hover:text-blue-700 text-xs font-medium">Modifier</button>
                                <span class="text-gray-300">|</span>
                                <button data-id="${person.id}" class="delete-benevole-btn text-red-500 hover:text-red-700 text-xs font-medium">Supprimer</button>
                            </div>
                        </td>
                    `;
                    
                    row.querySelector('[data-column="tel"]').style.display = canManage ? '' : 'none';
                    row.querySelector('[data-column="zello"]').style.display = canManage || isRadioManager ? '' : 'none';
                    row.querySelector('[data-column="acces"]').style.display = isSuperAdmin ? '' : 'none';
                    row.querySelector('[data-column="action"]').style.display = canManage ? '' : 'none';

                    row.querySelector('input[type="text"]').disabled = !canManage;
                    row.querySelector('input[type="tel"]').disabled = !canManage;
                    row.querySelector('[data-column="zello"] input').disabled = !canManage;

                    row.querySelector('input[type="text"]').onchange = (e) => { const [nom, ...prenomParts] = e.target.value.split(' '); data[personIndex].nom = nom.toUpperCase(); data[personIndex].prenom = prenomParts.join(' '); };
                    row.querySelector('input[type="tel"]').onchange = (e) => { data[personIndex].tel = e.target.value.replace(/\s/g, ''); };
                    row.querySelector('[data-column="zello"] input').onchange = (e) => { data[personIndex].zello = e.target.checked; };
                    
                    row.children[2].appendChild(createBenevoleSelect(joursOptions, person.jours, personIndex, "jours", !canManage));
                    row.children[3].appendChild(createBenevoleSelect(lieuOptions, person.lieu, personIndex, "lieu", !canManage));
                    row.children[4].appendChild(createBenevoleSelect(fonctionOptions, person.fonction, personIndex, "fonction", !canManage));

                    const materielDiv = document.createElement('div');
                    materielDiv.className = 'flex flex-col space-y-1';
                    Object.keys(person.materiel).forEach(key => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center space-x-2';
                        itemDiv.innerHTML = `<span class="w-12 text-sm">${key}:</span>`;
                        const distribueCheckbox = document.createElement('input');
                        distribueCheckbox.type = 'checkbox';
                        distribueCheckbox.checked = person.materiel[key].distribue;
                        distribueCheckbox.disabled = !canManage && !isRadioManager;
                        distribueCheckbox.className = 'h-4 w-4 text-blue-600 rounded';
                        distribueCheckbox.onchange = () => { data[personIndex].materiel[key].distribue = distribueCheckbox.checked; updateMaterialSummary(); };
                        itemDiv.appendChild(distribueCheckbox);
                        const restitueCheckbox = document.createElement('input');
                        restitueCheckbox.type = 'checkbox';
                        restitueCheckbox.checked = person.materiel[key].restitue;
                        restitueCheckbox.disabled = !canManage && !isRadioManager;
                        restitueCheckbox.className = 'h-4 w-4 text-green-600 rounded';
                        restitueCheckbox.onchange = () => { data[personIndex].materiel[key].restitue = restitueCheckbox.checked; updateMaterialSummary(); };
                        itemDiv.appendChild(restitueCheckbox);
                        materielDiv.appendChild(itemDiv);
                    });
                    row.children[5].appendChild(materielDiv);
                    
                    const userInAccessList = utilisateursAutorises.find(u => String(u.tel || '').replace(/\s/g, '') === cleanTel);
                    const currentRole = userInAccessList ? userInAccessList.role : "Aucun accès";
                    const roleSelect = createBenevoleSelect(rolesOptions, currentRole, personIndex, "role", !isSuperAdmin);
                    row.children[7].appendChild(roleSelect);
                    
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.edit-benevole-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        openBenevoleModal(e.target.dataset.id);
                    });
                });

                document.querySelectorAll('.delete-benevole-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const personId = e.target.dataset.id;
                        const person = data.find(p => p.id === personId);
                        const message = `Êtes-vous sûr de vouloir supprimer <strong>${person.prenom} ${person.nom}</strong> ?`;
                        showConfirmationModal(message, () => {
                            deleteDoc(doc(db, `artifacts/${appId}/public/data/benevoles`, personId));
                            const accessUser = utilisateursAutorises.find(u => String(u.tel || '').replace(/\s/g, '') === String(person.tel || '').replace(/\s/g, ''));
                            if (accessUser) {
                                deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, accessUser.id));
                            }
                        });
                    });
                });
                
                updateMaterialSummary();
                toggleTelColumn();
                setupBenevolePermissions();
            }

            function updateMaterialSummary() {
                let radiosDistribues = 0, radiosRestitues = 0, siffletsDistribues = 0, siffletsRestitues = 0;
                data.forEach(benevole => {
                    if (benevole.materiel.Radio?.distribue) radiosDistribues++;
                    if (benevole.materiel.Radio?.restitue) radiosRestitues++;
                    if (benevole.materiel.Sifflet?.distribue) siffletsDistribues++;
                    if (benevole.materiel.Sifflet?.restitue) siffletsRestitues++;
                });
                const radiosManquantes = radiosDistribues - radiosRestitues;
                const siffletsManquants = siffletsDistribues - siffletsRestitues;

                const radiosDistribueesEl = document.getElementById("radios-distribuees");
                if (!radiosDistribueesEl) return; // Prevent error if tab not rendered

                radiosDistribueesEl.textContent = radiosDistribues;
                document.getElementById("radios-restituees").textContent = radiosRestitues;
                document.getElementById("radios-manquantes").textContent = radiosManquantes;
                document.getElementById("sifflets-distribues").textContent = siffletsDistribues;
                document.getElementById("sifflets-restituees").textContent = siffletsRestitues;
                document.getElementById("sifflets-manquants").textContent = siffletsManquants;
                document.getElementById("appareils-manquants").textContent = radiosManquantes + siffletsManquants;
            }

            function toggleTelColumn(){
                const isHidden = toggleTelCheckbox.checked;
                const header = document.querySelector('th[data-column="tel"]');
                const cells = document.querySelectorAll('td[data-column="tel"]');
                if (!(isSuperAdmin || currentUser.role === 'Organisation')) return;
                if(header) header.style.display = isHidden ? "none" : "" ;
                cells.forEach(cell => { cell.style.display = isHidden ? "none": "" });
            }

            saveBtn.addEventListener('click', saveBenevolesData);
            addBenevoleBtn.addEventListener('click', () => openBenevoleModal());
            
            closeModalBtn.addEventListener('click', () => {
                document.getElementById('add-benevole-modal').style.display = 'none';
                editingBenevoleId = null;
            });
            
            addBenevoleForm.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = {
                    nom: document.getElementById("nom").value.toUpperCase(),
                    prenom: document.getElementById("prenom").value,
                    tel: document.getElementById("tel").value.replace(/\s/g, "") || "Non renseigné",
                };

                if (editingBenevoleId) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/benevoles`, editingBenevoleId);
                    await updateDoc(docRef, {
                        nom: formData.nom,
                        prenom: formData.prenom,
                        tel: formData.tel,
                    });
                } else {
                    const newBenevole = {
                        ...formData,
                        jours: "Non renseigné",
                        fonction: "À définir",
                        lieu: "À définir",
                        materiel: { Radio: { distribue: false, restitue: false }, Sifflet: { distribue: false, restitue: false }},
                        zello: false
                    };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/benevoles`), newBenevole);
                }
                
                document.getElementById('add-benevole-modal').style.display = "none";
                addBenevoleForm.reset();
                editingBenevoleId = null;
            });

            filterInput.addEventListener('input', renderBenevolesTable);
            filterFonction.addEventListener('change', renderBenevolesTable);
            filterLieu.addEventListener('change', renderBenevolesTable);
            filterMissingInfoCheckbox.addEventListener('change', renderBenevolesTable);
            toggleTelCheckbox.addEventListener('change', toggleTelColumn);

            // =========================
            // CONCURRENTS & RACE LOGIC
            // =========================
            let concurrents = [], startTime, updatedTime, difference, tInterval, running = false, currentManche = 1;
            let chronoInterval;

            const chronoDocRef = doc(db, `artifacts/${appId}/public/data/raceState`, 'chrono');
            
            const concurrentsCollection = collection(db, `artifacts/${appId}/public/data/concurrents`);
            onSnapshot(concurrentsCollection, (snapshot) => {
                concurrents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllConcurrentsView();
                populateConcurrentsDatalist();
                populateCompetitorsForAccessForm(); // Mettre à jour la liste dans le formulaire admin
            });

            async function saveConcurrentsData() {
                const batch = writeBatch(db);
                concurrents.forEach(concurrent => {
                    const { id, ...concurData } = concurrent;
                    const docRef = doc(db, `artifacts/${appId}/public/data/concurrents`, id);
                    batch.update(docRef, concurData);
                });
                await batch.commit();
                saveConcurrentsMessage.textContent = "Modifications sauvegardées !";
                saveConcurrentsMessage.classList.add('show');
                setTimeout(() => { saveConcurrentsMessage.classList.remove('show'); }, 3000);
            }

            function renderAllConcurrentsView() {
                renderConcurrentsAdminTable();
                renderRaceTable();
            }

            function openConcurrentModal(concurrentId = null) {
                const modal = document.getElementById('add-concurrent-modal');
                const modalTitle = document.getElementById('concurrent-modal-title');
                const modalSubmitBtn = document.getElementById('concurrent-modal-submit-btn');
                
                addConcurrentFormModal.reset();

                if (concurrentId) {
                    editingConcurrentId = concurrentId;
                    const concurrent = concurrents.find(c => c.id === concurrentId);
                    modalTitle.textContent = "Modifier le Concurrent";
                    modalSubmitBtn.textContent = "Enregistrer";
                    document.getElementById('concurrent-nom-modal').value = concurrent.nom;
                    document.getElementById('concurrent-enfant-modal').checked = concurrent.isChild;
                } else {
                    editingConcurrentId = null;
                    modalTitle.textContent = "Ajouter un Concurrent";
                    modalSubmitBtn.textContent = "Ajouter";
                }
                modal.style.display = 'flex';
            }

            function renderConcurrentsAdminTable() {
                const filterValue = filterConcurrentsInput.value.toLowerCase();
                const filteredData = concurrents.filter(c => c.nom.toLowerCase().includes(filterValue));

                concurrentsAdminBody.innerHTML = "";
                filteredData.sort((a, b) => a.numero - b.numero).forEach(concurrent => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm">${concurrent.nom}</td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-id="${concurrent.id}" data-prop="isChild" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.isChild ? "checked" : ""}></td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-id="${concurrent.id}" data-prop="documents.dossier" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.documents.dossier ? "checked" : ""}></td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-id="${concurrent.id}" data-prop="documents.assurance" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.documents.assurance ? "checked" : ""}></td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <input type="checkbox" data-id="${concurrent.id}" data-prop="documents.paiement.ok" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.documents.paiement.ok ? "checked" : ""}>
                                <input type="text" placeholder="€" value="${concurrent.documents.paiement.montant}" data-id="${concurrent.id}" class="paiement-input text-sm">
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" data-id="${concurrent.id}" data-prop="equipements" class="doc-check h-4 w-4 text-blue-600 rounded" ${concurrent.equipements ? "checked" : ""}></td>
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex items-center gap-2 justify-center">
                                <button data-id="${concurrent.id}" class="edit-concurrent-btn text-blue-600 hover:text-blue-700 text-xs font-medium">Modifier</button>
                                <span class="text-gray-300">|</span>
                                <button data-id="${concurrent.id}" class="delete-concurrent-btn text-red-500 hover:text-red-700 text-xs font-medium">Suppr.</button>
                            </div>
                        </td>
                    `;
                
                    const select = document.createElement("select");
                    ["À vérifier", "Conforme", "Non Conforme"].forEach(status => {
                        const option = document.createElement("option");
                        option.value = status;
                        option.textContent = status;
                        if (concurrent.controle === status) option.selected = true;
                        select.appendChild(option);
                    });
                
                    const getSelectClass = (status) => `controle-select rounded-md text-xs p-1 font-semibold controle-${status.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '')}`;
                    select.className = getSelectClass(concurrent.controle);
                
                    select.addEventListener("change", (event) => {
                        const targetConcurrent = concurrents.find(c => c.id === concurrent.id);
                        if (targetConcurrent) {
                            targetConcurrent.controle = event.target.value;
                            event.target.className = getSelectClass(event.target.value);
                        }
                    });
                
                    row.children[6].appendChild(select);
                    concurrentsAdminBody.appendChild(row);
                });
                
                document.querySelectorAll(".edit-concurrent-btn").forEach(btn => btn.addEventListener("click", event => {
                    openConcurrentModal(event.target.dataset.id);
                }));

                document.querySelectorAll(".delete-concurrent-btn").forEach(btn => btn.addEventListener("click", event => {
                    const docId = event.target.dataset.id;
                    const concurrent = concurrents.find(c => c.id === docId);
                    const message = `Êtes-vous sûr de vouloir supprimer le concurrent <strong>${concurrent.nom}</strong> ?`;
                    showConfirmationModal(message, () => {
                        deleteDoc(doc(db, `artifacts/${appId}/public/data/concurrents`, docId));
                    });
                }));
                
                document.querySelectorAll(".doc-check").forEach(checkbox => checkbox.addEventListener("change", event => {
                    const id = event.target.dataset.id;
                    const propPath = event.target.dataset.prop;
                    const targetConcurrent = concurrents.find(c => c.id === id);
                    if (targetConcurrent) {
                        const props = propPath.split('.');
                        let current = targetConcurrent;
                        for (let i = 0; i < props.length - 1; i++) {
                            current = current[props[i]];
                        }
                        current[props[props.length - 1]] = event.target.checked;
                    }
                }));
                
                document.querySelectorAll(".paiement-input").forEach(input => input.addEventListener("input", event => {
                    const id = event.target.dataset.id;
                    const targetConcurrent = concurrents.find(c => c.id === id);
                    if (targetConcurrent) {
                        targetConcurrent.documents.paiement.montant = event.target.value;
                    }
                }));
            }

            function parseTimeToMillis(timeStr) {
                if (!timeStr || typeof timeStr !== 'string' || timeStr === '-') return null;
                const parts = timeStr.split(':');
                if (parts.length !== 3) return null;

                const minutes = parseInt(parts[0], 10);
                const seconds = parseInt(parts[1], 10);
                const centiseconds = parseInt(parts[2], 10);

                if (isNaN(minutes) || isNaN(seconds) || isNaN(centiseconds)) return null;

                return (minutes * 60 * 1000) + (seconds * 1000) + (centiseconds * 10);
            }
            
            function updateChronoDisplay(startTime) {
                chronoDisplay.textContent = formatTime(new Date().getTime() - startTime);
            }

            function updateChronoButtons(chronoData) {
                const chronoIsRunning = chronoData.running;
                const concurrentSelected = !!chronoData.selectedConcurrent;
                
                const canStart = isSuperAdmin || currentUser.role === 'Organisation' || currentUser.role === 'Chrono Départ';
                const canStop = isSuperAdmin || currentUser.role === 'Organisation' || currentUser.role === 'Chrono Arrivée';
                const canReset = isSuperAdmin || currentUser.role === 'Organisation' || currentUser.role === 'Chrono Départ';

                startBtn.disabled = !canStart || chronoIsRunning || !concurrentSelected;
                stopBtn.disabled = !canStop || !chronoIsRunning;
                resetBtn.disabled = !canReset || chronoIsRunning;
            }

            async function startChrono() {
                const chronoSnapshot = await getDoc(chronoDocRef);
                const chronoData = chronoSnapshot.data();
                const selectedConcurrentId = chronoData ? chronoData.selectedConcurrent : null;
                
                if (!selectedConcurrentId) {
                    showConfirmationModal("Veuillez sélectionner un concurrent avant de démarrer.", () => {}, "Aucun Concurrent Sélectionné");
                    return;
                }

                await updateDoc(chronoDocRef, {
                    running: true,
                    startTime: new Date().getTime(),
                    currentConcurrent: selectedConcurrentId,
                    selectedConcurrent: null
                });
            }

            async function stopChrono() {
                const chronoSnapshot = await getDoc(chronoDocRef);
                const chronoData = chronoSnapshot.data();
                if (!chronoData || !chronoData.running) return;

                const endTime = new Date().getTime();
                const startTime = chronoData.startTime;
                const difference = endTime - startTime;
                const concurrentId = chronoData.currentConcurrent;
                const concurrent = concurrents.find(c => c.id == concurrentId);

                if (concurrent) {
                    const manches = concurrent.manches;
                    manches[currentManche - 1] = difference;
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/concurrents`, concurrent.id), { manches: manches });
                    
                    const allConcurrentsWithNewTime = JSON.parse(JSON.stringify(concurrents)); // Deep copy to avoid mutation
                    const concurrentToUpdate = allConcurrentsWithNewTime.find(c => c.id === concurrent.id);
                    if (concurrentToUpdate) {
                        concurrentToUpdate.manches = manches;
                    }

                    allConcurrentsWithNewTime.forEach(c => {
                        const officialRuns = c.manches.slice(2).filter(t => t !== null && t !== undefined);
                        c.meilleurTemps = officialRuns.length > 0 ? Math.min(...officialRuns) : null;
                    });

                    const ranked = allConcurrentsWithNewTime.filter(c => c.meilleurTemps !== null).sort((a, b) => a.meilleurTemps - b.meilleurTemps);
                    const rankIndex = ranked.findIndex(c => c.id === concurrent.id);
                    const rank = rankIndex !== -1 ? rankIndex + 1 : null;

                    let ecartPremier = null;
                    let ecartPrecedent = null;
                    let nomPrecedent = null;
                    
                    if (rank > 1 && ranked.length > 1) {
                        const tempsPremier = ranked[0].meilleurTemps;
                        ecartPremier = concurrentToUpdate.meilleurTemps - tempsPremier;

                        const concurrentPrecedent = ranked[rankIndex - 1];
                        ecartPrecedent = concurrentToUpdate.meilleurTemps - concurrentPrecedent.meilleurTemps;
                        nomPrecedent = concurrentPrecedent.nom;
                    }

                    let isNewBestRunEver = false;
                    const allRuns = allConcurrentsWithNewTime.flatMap(c => c.manches).filter(t => t !== null);
                    if (allRuns.length > 0) {
                        const bestRunEver = Math.min(...allRuns);
                        if (difference === bestRunEver) {
                            isNewBestRunEver = true;
                        }
                    }


                    await updateDoc(chronoDocRef, {
                        running: false,
                        startTime: null,
                        currentConcurrent: null,
                        selectedConcurrent: null,
                        lastRecordedTime: {
                            nom: concurrent.nom,
                            time: difference,
                            rank: rank,
                            ecartPremier: ecartPremier,
                            ecartPrecedent: ecartPrecedent,
                            nomPrecedent: nomPrecedent,
                            isNewBestRunEver: isNewBestRunEver
                        }
                    });
                } else {
                    await updateDoc(chronoDocRef, { running: false, startTime: null, currentConcurrent: null, selectedConcurrent: null });
                }
            }

            async function resetChrono() {
                await updateDoc(chronoDocRef, { running: false, startTime: null, currentConcurrent: null, selectedConcurrent: null });
            }

            async function startNewHeat() {
                const nextManche = currentManche + 1;
                if (nextManche <= 8) {
                     const message = `Êtes-vous sûr de vouloir passer à la manche <strong>${nextManche <= 2 ? 'Descente test ' + nextManche : 'Course ' + (nextManche - 2)}</strong> ?`;
                    showConfirmationModal(message, async () => {
                        await updateDoc(chronoDocRef, { currentManche: nextManche });
                    }, "Passer à la manche suivante ?");
                } else {
                    showConfirmationModal("Nombre maximum de manches atteint.", () => {}, "Information");
                }
            }

            async function resetRace() {
                if(isSuperAdmin) {
                    showConfirmationModal("ACTION IRRÉVERSIBLE<br><br>Êtes-vous sûr de vouloir réinitialiser <strong>TOUTE</strong> la course ? Tous les temps seront effacés.", async () => {
                        const batch = writeBatch(db);
                        concurrents.forEach(c => {
                            const docRef = doc(db, `artifacts/${appId}/public/data/concurrents`, c.id);
                            batch.update(docRef, { 
                                manches: new Array(8).fill(null), 
                                meilleurTemps: null, 
                                tempsTotal: null 
                            });
                        });
                        await batch.commit();
                        await updateDoc(chronoDocRef, { currentManche: 1 });
                    });
                }
            }

            function renderRaceTable() {
                const tableHead = document.getElementById('race-table-head');
                const tableBody = document.getElementById('race-table-body');
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';

                const filterValue = filterRaceInput.value.toLowerCase();
                let dataToRender = concurrents.filter(c => c.nom.toLowerCase().includes(filterValue));

                dataToRender.forEach(c => {
                    const officialRuns = c.manches.slice(2).filter(t => t !== null && t !== undefined);
                    c.meilleurTemps = officialRuns.length > 0 ? Math.min(...officialRuns) : null;
                });

                dataToRender.sort((a, b) => {
                    if (a.meilleurTemps === null) return 1;
                    if (b.meilleurTemps === null) return -1;
                    return a.meilleurTemps - b.meilleurTemps;
                });
                
                const tempsPremier = dataToRender.length > 0 && dataToRender[0].meilleurTemps !== null ? dataToRender[0].meilleurTemps : null;

                const headers = ['Cl.', 'Concurrent'];
                const mancheHeaders = Array.from({ length: currentManche }, (_, i) => i < 2 ? `Test ${i + 1}` : `Course ${i - 1}`);
                headers.push(...mancheHeaders, 'Meilleur Temps', 'Écart 1er');
                
                let headerHTML = '<tr>';
                headers.forEach((h, i) => {
                    const isCurrentMancheCol = (i === (2 + currentManche - 1));
                    headerHTML += `<th id="${isCurrentMancheCol ? 'current-heat-header' : ''}" class="px-4 py-3 text-left text-xs font-bold uppercase">${h}</th>`;
                });
                headerHTML += '</tr>';
                tableHead.innerHTML = headerHTML;

                const canEditTimes = isSuperAdmin || ['Organisation', 'Chrono Départ', 'Chrono Arrivée'].includes(currentUser.role);

                dataToRender.forEach((concurrent, index) => {
                    const row = tableBody.insertRow();
                    const classement = concurrent.meilleurTemps !== null ? index + 1 : "-";
                    let classementHTML = classement;
                    if (classement === 1) classementHTML = `🥇 ${classement}`;
                    else if (classement === 2) classementHTML = `🥈 ${classement}`;
                    else if (classement === 3) classementHTML = `🥉 ${classement}`;
                    
                    const ecartPremier = tempsPremier !== null && concurrent.meilleurTemps !== null ? concurrent.meilleurTemps - tempsPremier : null;

                    let rowHTML = `
                        <td class="px-4 py-3 text-base font-bold text-center">${classementHTML}</td>
                        <td class="px-4 py-3 text-sm">${concurrent.nom} ${concurrent.isChild ? '🧒' : ''}</td>
                    `;
                    
                    for (let i = 0; i < currentManche; i++) {
                        rowHTML += `<td class="px-4 py-3 text-sm"><input type="text" class="time-input" value="${formatTime(concurrent.manches[i])}" data-concurrent-id="${concurrent.id}" data-manche-index="${i}" ${canEditTimes ? '' : 'disabled'}></td>`;
                    }
                    
                    rowHTML += `
                        <td class="px-4 py-3 text-sm font-semibold text-blue-600">${formatTime(concurrent.meilleurTemps)}</td>
                        <td class="px-4 py-3 text-sm text-red-500 font-semibold">${formatEcart(ecartPremier)}</td>
                    `;
                    row.innerHTML = rowHTML;
                });

                currentMancheDisplay.textContent = currentManche <= 2 ? `Descente test ${currentManche}` : `Course ${currentManche - 2}`;

                setTimeout(() => {
                    const currentHeatHeader = document.getElementById('current-heat-header');
                    if (currentHeatHeader) {
                        currentHeatHeader.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    }
                }, 100);
            }

            document.getElementById('race-table-container').addEventListener('change', async (e) => {
                if (e.target.classList.contains('time-input')) {
                    const input = e.target;
                    const concurrentId = input.dataset.concurrentId;
                    const mancheIndex = parseInt(input.dataset.mancheIndex, 10);
                    const newTime = parseTimeToMillis(input.value);

                    const concurrentToUpdate = concurrents.find(c => c.id === concurrentId);
                    if (concurrentToUpdate) {
                        concurrentToUpdate.manches[mancheIndex] = newTime;
                        const docRef = doc(db, `artifacts/${appId}/public/data/concurrents`, concurrentId);
                        await updateDoc(docRef, { manches: concurrentToUpdate.manches });
                    }
                }
            });

            function populateConcurrentsDatalist() {
                concurrentsDatalist.innerHTML = '';
                concurrents.sort((a, b) => a.numero - b.numero).forEach(concurrent => {
                    const option = document.createElement("option");
                    option.value = concurrent.nom;
                    concurrentsDatalist.appendChild(option);
                });
            }

            function showGrid(type) {
                const title = document.getElementById("grid-title");
                const gridHead = document.querySelector("#grid-table thead");
                const gridBody = document.getElementById("grid-table-body");
                gridBody.innerHTML = "";

                if (type === 'podium-fastest-lap') {
                    title.textContent = "Podium - Descente la plus Rapide";
                    gridHead.innerHTML = `<tr>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase rounded-tl-xl">Position</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Concurrent</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Meilleur Temps</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase rounded-tr-xl">Écart 1er</th>
                    </tr>`;
                    const ranked = [...concurrents].filter(c => c.meilleurTemps !== null).sort((a,b) => a.meilleurTemps - b.meilleurTemps);
                    const tempsPremier = ranked.length > 0 ? ranked[0].meilleurTemps : null;

                    ranked.forEach((c, i) => {
                        const ecartPremier = tempsPremier !== null ? c.meilleurTemps - tempsPremier : null;
                        
                        let classementHTML = i + 1;
                        if (classementHTML === 1) classementHTML = `🥇 ${classementHTML}`;
                        else if (classementHTML === 2) classementHTML = `🥈 ${classementHTML}`;
                        else if (classementHTML === 3) classementHTML = `🥉 ${classementHTML}`;

                        gridBody.innerHTML += `<tr>
                            <td class="px-4 py-3 text-sm font-bold">${classementHTML}</td>
                            <td class="px-4 py-3 text-sm">${c.nom} ${c.isChild ? '🧒' : ''}</td>
                            <td class="px-4 py-3 text-sm font-semibold text-blue-600">${formatTime(c.meilleurTemps)}</td>
                            <td class="px-4 py-3 text-sm text-red-500">${formatEcart(ecartPremier)}</td>
                        </tr>`;
                    });
                } else if (type === 'podium-grand-prix') {
                    title.textContent = "Podium - Grand Prix";
                     gridHead.innerHTML = `<tr>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase rounded-tl-xl">Position</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Concurrent</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Temps Total</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase rounded-tr-xl">Écart 1er</th>
                    </tr>`;
                    
                    concurrents.forEach(c => {
                        const officialRuns = c.manches.slice(2).filter(t => t !== null && t !== undefined);
                        c.completedRuns = officialRuns.length;
                        c.tempsTotal = officialRuns.length > 0 ? officialRuns.reduce((a, b) => a + b, 0) : null;
                    });
                    
                    const maxCourses = currentManche > 2 ? currentManche - 2 : 0;
                    
                    let ranked = [];
                    if (maxCourses > 0) {
                        ranked = concurrents.filter(c => c.completedRuns === maxCourses && c.tempsTotal !== null).sort((a,b) => a.tempsTotal - b.tempsTotal);
                    }

                    const tempsPremier = ranked.length > 0 ? ranked[0].tempsTotal : null;

                    ranked.forEach((c, i) => {
                        const ecartPremier = tempsPremier !== null ? c.tempsTotal - tempsPremier : null;
                        
                        let classementHTML = i + 1;
                        if (classementHTML === 1) classementHTML = `🥇 ${classementHTML}`;
                        else if (classementHTML === 2) classementHTML = `🥈 ${classementHTML}`;
                        else if (classementHTML === 3) classementHTML = `🥉 ${classementHTML}`;

                        gridBody.innerHTML += `<tr>
                            <td class="px-4 py-3 text-sm font-bold">${classementHTML}</td>
                            <td class="px-4 py-3 text-sm">${c.nom} ${c.isChild ? '🧒' : ''}</td>
                            <td class="px-4 py-3 text-sm font-semibold text-blue-600">${formatTime(c.tempsTotal)}</td>
                            <td class="px-4 py-3 text-sm text-red-500">${formatEcart(ecartPremier)}</td>
                        </tr>`;
                    });
                } else { // Previous or Current heat
                    const isCurrent = type === 'current';
                    if (!isCurrent && currentManche === 1) { showConfirmationModal("Aucune manche précédente à afficher.", () => {}, "Information"); return; }
                    
                    const mancheIndex = isCurrent ? currentManche - 1 : currentManche - 2;
                    const mancheName = mancheIndex < 2 ? `Descente test ${mancheIndex + 1}` : `Course ${mancheIndex - 1}`;
                    
                    title.textContent = isCurrent ? `Classement - ${mancheName} (en cours)` : `Classement - ${mancheName}`;
                    gridHead.innerHTML = `<tr>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase rounded-tl-xl">Position</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Concurrent</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Temps</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase rounded-tr-xl">Écart 1er</th>
                    </tr>`;
                    const ranked = [...concurrents].filter(c => c.manches[mancheIndex] !== null).sort((a,b) => a.manches[mancheIndex] - b.manches[mancheIndex]);
                    const tempsPremier = ranked.length > 0 ? ranked[0].manches[mancheIndex] : null;

                    ranked.forEach((c, i) => {
                        const ecartPremier = tempsPremier !== null ? c.manches[mancheIndex] - tempsPremier : null;
                        let classementHTML = i + 1;
                        if (classementHTML === 1) classementHTML = `🥇 ${classementHTML}`;
                        else if (classementHTML === 2) classementHTML = `🥈 ${classementHTML}`;
                        else if (classementHTML === 3) classementHTML = `🥉 ${classementHTML}`;

                        gridBody.innerHTML += `<tr>
                            <td class="px-4 py-3 text-sm font-bold">${classementHTML}</td>
                            <td class="px-4 py-3 text-sm">${c.nom} ${c.isChild ? '🧒' : ''}</td>
                            <td class="px-4 py-3 text-sm font-semibold text-blue-600">${formatTime(c.manches[mancheIndex])}</td>
                            <td class="px-4 py-3 text-sm text-red-500">${formatEcart(ecartPremier)}</td>
                        </tr>`;
                    });
                }
                mainApp.style.display="none",gridScreen.style.display="flex"
            }
            startBtn.addEventListener('click', startChrono);
            stopBtn.addEventListener('click', stopChrono);
            resetBtn.addEventListener('click', resetChrono);
            newHeatBtn.addEventListener('click', startNewHeat);
            resetRaceBtn.addEventListener('click', resetRace);
            saveConcurrentsBtn.addEventListener('click', saveConcurrentsData);
            addConcurrentBtn.addEventListener('click', () => openConcurrentModal());
            closeConcurrentModalBtn.addEventListener('click', () => {
                document.getElementById('add-concurrent-modal').style.display = 'none';
                editingConcurrentId = null;
            });
            addConcurrentFormModal.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nom = document.getElementById("concurrent-nom-modal").value;
                const isChild = document.getElementById("concurrent-enfant-modal").checked;
                
                if (editingConcurrentId) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/concurrents`, editingConcurrentId);
                    await updateDoc(docRef, { nom: nom, isChild: isChild });
                } else {
                    const newNumero = concurrents.length > 0 ? Math.max(...concurrents.map(c => c.numero)) + 1 : 1;
                    await addDoc(collection(db, `artifacts/${appId}/public/data/concurrents`), {
                        numero: newNumero,
                        nom: nom,
                        isChild: isChild,
                        manches: new Array(8).fill(null),
                        meilleurTemps: null,
                        tempsTotal: null,
                        documents: { dossier: false, paiement: { ok: false, montant: "" }, assurance: false },
                        equipements: false,
                        controle: "À vérifier"
                    });
                }
                document.getElementById('add-concurrent-modal').style.display = "none";
                addConcurrentFormModal.reset();
                editingConcurrentId = null;
            });
            
            chronoSearchInput.addEventListener('input', async () => {
                const value = chronoSearchInput.value;
                const concurrent = concurrents.find(c => c.nom === value);
                const id = concurrent ? concurrent.id : null;
                await updateDoc(chronoDocRef, { selectedConcurrent: id });
            });
            
            async function clearDbLastRecordedTime() {
                // Cette fonction efface le champ de la base de données, ce qui déclenchera la fermeture pour tout le monde.
                clearTimeout(modalTimeout); 
                const docSnap = await getDoc(chronoDocRef);
                if (docSnap.exists() && docSnap.data().lastRecordedTime) {
                    await updateDoc(chronoDocRef, { lastRecordedTime: null });
                }
            }

            closeTimeConfirmModalBtn.addEventListener('click', clearDbLastRecordedTime);

            previousHeatBtn.addEventListener('click', () => showGrid('previous'));
            currentHeatBtn.addEventListener('click', () => showGrid('current'));
            podiumFastestLapBtn.addEventListener('click', () => showGrid('podium-fastest-lap'));
            podiumGrandPrixBtn.addEventListener('click', () => showGrid('podium-grand-prix'));

            closeGridBtn.addEventListener('click',()=>{mainApp.style.display="block",gridScreen.style.display="none"});
            filterConcurrentsInput.addEventListener('input', renderConcurrentsAdminTable);
            filterRaceInput.addEventListener('input', renderRaceTable);
            filterAccessInput.addEventListener('input', renderAccessTable);

            // =========================
            // ACCESS LOGIC & INIT
            // =========================
            const userRoleSelect = document.getElementById('user-role');
            const userCompetitorLinkContainer = document.getElementById('user-competitor-link-container');
            const userCompetitorSelect = document.getElementById('user-competitor-select');

            async function populateCompetitorsForAccessForm() {
                userCompetitorSelect.innerHTML = '<option value="">-- Sélectionnez un concurrent --</option>';
                const sortedConcurrents = [...concurrents].sort((a,b) => a.numero - b.numero);
                sortedConcurrents.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = `${c.numero} - ${c.nom}`;
                    userCompetitorSelect.appendChild(option);
                });
            }
            
            userRoleSelect.addEventListener('change', () => {
                if (userRoleSelect.value === 'Concurrent') {
                    userCompetitorLinkContainer.style.display = 'block';
                } else {
                    userCompetitorLinkContainer.style.display = 'none';
                }
            });

            function resetUserForm() {
                addUserForm.reset();
                editingUserId = null;
                addUserBtn.textContent = '+ Ajouter';
                cancelEditUserBtn.style.display = 'none';
                userCompetitorLinkContainer.style.display = 'none';
            }
            
            function openUserEditForm(userId) {
                const userToEdit = utilisateursAutorises.find(u => u.id === userId);
                if (userToEdit) {
                    editingUserId = userId;
                    document.getElementById('user-nom').value = userToEdit.nom;
                    document.getElementById('user-prenom').value = userToEdit.prenom;
                    document.getElementById('user-tel').value = userToEdit.tel;
                    userRoleSelect.value = userToEdit.role;
                    
                    if (userToEdit.role === 'Concurrent') {
                        userCompetitorLinkContainer.style.display = 'block';
                        userCompetitorSelect.value = userToEdit.linkedCompetitorId || "";
                    } else {
                        userCompetitorLinkContainer.style.display = 'none';
                    }

                    addUserBtn.textContent = 'Enregistrer';
                    cancelEditUserBtn.style.display = 'inline-block';
                }
            }
            
            function renderAccessTable() {
                const filterValue = filterAccessInput.value.toLowerCase();
                const filteredData = utilisateursAutorises.filter(u => `${u.prenom} ${u.nom}`.toLowerCase().includes(filterValue));

                accessTableBody.innerHTML = "";
                filteredData.forEach(user => {
                    const row = document.createElement("tr");
                    const displayRole = user.role;
                    let roleInfo = displayRole;
                    if(user.role === 'Concurrent' && user.linkedCompetitorId) {
                        const linked = concurrents.find(c => c.id === user.linkedCompetitorId);
                        if(linked) {
                            roleInfo += ` (${linked.nom})`;
                        }
                    }

                    const roleClass = ["Organisation", "Super Admin", "Chrono Départ", "Chrono Arrivée", "MAIRE", "Gestionnaire"].includes(displayRole) ? "bg-blue-100 text-blue-800" : "bg-gray-100 text-gray-800";
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-800">${user.prenom} ${user.nom}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${user.tel}</td>
                        <td class="px-4 py-3 text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${roleClass}">${roleInfo}</span></td>
                        <td class="px-4 py-3 text-sm text-gray-500">
                           <div class="flex items-center gap-2">
                                <button data-id="${user.id}" class="edit-user-btn text-blue-600 hover:text-blue-700 text-xs font-medium">Modifier</button>
                                <span class="text-gray-300">|</span>
                                <button data-id="${user.id}" class="delete-user-btn text-red-500 hover:text-red-700 text-xs font-medium">Supprimer</button>
                            </div>
                        </td>
                    `;
                    accessTableBody.appendChild(row);
                });
                
                document.querySelectorAll(".delete-user-btn").forEach(btn => {
                    btn.addEventListener("click", event => {
                        const userId = event.target.dataset.id;
                        const user = utilisateursAutorises.find(u => u.id === userId);
                        if (user.role === 'Super Admin') {
                           showConfirmationModal("Action impossible : vous ne pouvez pas supprimer le Super Admin.", () => {}, "Erreur");
                            return;
                        }
                          const message = `Êtes-vous sûr de vouloir supprimer l'utilisateur <strong>${user.prenom} ${user.nom}</strong> ?`;
                          showConfirmationModal(message, () => {
                            deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, userId));
                          });
                    });
                });
                
                document.querySelectorAll(".edit-user-btn").forEach(btn => {
                    btn.addEventListener("click", event => {
                        openUserEditForm(event.target.dataset.id);
                    });
                });
            }
            
            cancelEditUserBtn.addEventListener('click', resetUserForm);

            addUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const role = userRoleSelect.value;
                const userData = {
                    nom: document.getElementById("user-nom").value.trim().toUpperCase(),
                    prenom: document.getElementById("user-prenom").value.trim(),
                    tel: document.getElementById("user-tel").value.replace(/\s/g, ""),
                    role: role,
                    linkedCompetitorId: role === 'Concurrent' ? userCompetitorSelect.value : null
                };

                if (role === 'Concurrent' && !userData.linkedCompetitorId) {
                    showConfirmationModal("Veuillez lier cet accès à un concurrent.", () => {}, "Action requise");
                    return;
                }

                if(editingUserId) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/users`, editingUserId);
                    await updateDoc(docRef, userData);
                } else {
                     if (utilisateursAutorises.some(u => u.tel === userData.tel)) {
                        showConfirmationModal("Un utilisateur avec ce numéro de téléphone existe déjà.", () => {}, "Erreur");
                        return;
                    }
                    await addDoc(collection(db, `artifacts/${appId}/public/data/users`), userData);
                }
                resetUserForm();
            });
            
            // =========================
            // RESET LOGIC
            // =========================
            const resetAccessBtn = document.getElementById('reset-access-btn');

            async function clearCollection(collectionName) {
                const collectionRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                const snapshot = await getDocs(collectionRef);
                if (snapshot.empty) return;
                
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
            }

            resetBenevolesBtn.addEventListener('click', async () => {
                showConfirmationModal("ATTENTION : Vous êtes sur le point de supprimer <strong>TOUS</strong> les bénévoles.<br><br>Cette action est IRRÉVERSIBLE.", async () => {
                    try {
                        await clearCollection('benevoles');
                        alert("La base de données des bénévoles a été réinitialisée.");
                    } catch (e) {
                        console.error("Erreur: ", e);
                        alert("Une erreur est survenue.");
                    }
                });
            });

            resetConcurrentsBtn.addEventListener('click', async () => {
                showConfirmationModal("ATTENTION : Vous êtes sur le point de supprimer <strong>TOUS</strong> les concurrents et <strong>TOUS</strong> les temps de course.<br><br>Cette action est IRRÉVERSIBLE.", async () => {
                    try {
                        await clearCollection('concurrents');
                        await setDoc(chronoDocRef, { running: false, startTime: null, currentConcurrent: null, currentManche: 1 });
                        alert("La base de données des concurrents et de la course a été réinitialisée.");
                    } catch (e) {
                        console.error("Erreur: ", e);
                        alert("Une erreur est survenue.");
                    }
                });
            });
            
            if(resetAccessBtn) {
                resetAccessBtn.addEventListener('click', async () => {
                    showConfirmationModal("ATTENTION : Vous allez supprimer <strong>TOUS</strong> les accès, <strong>SAUF</strong> le Super Administrateur.<br><br>Cette action est IRRÉVERSIBLE.", async () => {
                        try {
                            const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
                            const snapshot = await getDocs(usersCollectionRef);
                            const batch = writeBatch(db);
                            snapshot.docs.forEach(doc => {
                                const userData = doc.data();
                                if (!(userData.nom === "POURCEL" && userData.prenom === "Romain" && userData.tel === "0613255651")) {
                                    batch.delete(doc.ref);
                                }
                            });
                            await batch.commit();
                            alert("La base de données des accès a été réinitialisée.");
                        } catch (e) {
                            console.error("Erreur: ", e);
                            alert("Une erreur est survenue.");
                        }
                    });
                });
            }


            // =========================
            // PERMISSIONS & FINAL SETUP
            // =========================
            function setupBenevolePermissions() {
                const canEdit = isSuperAdmin || currentUser.role === 'Organisation';
                document.querySelectorAll('#table-body input, #table-body select').forEach(el => {
                    const cell = el.closest('td');
                    if (cell && cell.dataset.column === 'acces') {
                         el.disabled = !isSuperAdmin;
                    } else {
                         el.disabled = !canEdit;
                    }
                });
                 document.querySelectorAll('.delete-benevole-btn, .edit-benevole-btn').forEach(btn => btn.style.display = canEdit ? '' : 'none');
            }

            function setupPermissions() {
                const role = currentUser.role;
                let firstVisibleTabId = null;

                const allTabs = ['tab-race', 'tab-podium', 'tab-concurrents', 'tab-dashboard', 'tab-admin'];
                const visibleTabs = {
                    'Organisation': ['tab-race', 'tab-podium', 'tab-concurrents', 'tab-dashboard'],
                    'Responsable Radio': ['tab-dashboard'],
                    'MAIRE': ['tab-race', 'tab-podium', 'tab-dashboard'],
                    'Chrono Départ': ['tab-race', 'tab-podium', 'tab-dashboard'],
                    'Chrono Arrivée': ['tab-race', 'tab-podium', 'tab-dashboard'],
                    'Bénévole': ['tab-race', 'tab-podium', 'tab-dashboard'],
                    'Concurrent': ['tab-race', 'tab-podium'],
                    'Gestionnaire': ['tab-concurrents', 'tab-dashboard']
                };

                allTabs.forEach(tabId => {
                    const tabElement = document.getElementById(tabId);
                    if (tabElement) tabElement.style.display = 'none';
                });

                if (isSuperAdmin) {
                    allTabs.forEach(tabId => {
                        const tabElement = document.getElementById(tabId);
                        if (tabElement) tabElement.style.display = 'block';
                    });
                    firstVisibleTabId = 'tab-race';
                } else if (visibleTabs[role]) {
                    visibleTabs[role].forEach(tabId => {
                        const tabElement = document.getElementById(tabId);
                        if (tabElement) tabElement.style.display = 'block';
                    });
                    firstVisibleTabId = visibleTabs[role][0];
                }
                
                if (firstVisibleTabId) {
                    document.getElementById(firstVisibleTabId).click();
                }
                
                const canEditBenevoles = isSuperAdmin || role === 'Organisation';
                const canEditConcurrents = isSuperAdmin || role === 'Organisation' || role === 'Gestionnaire';
                const canSeeChronoAndPodium = isSuperAdmin || role === 'Organisation' || role === 'Chrono Départ' || role === 'Chrono Arrivée' || role === 'MAIRE';
                const canImportExport = isSuperAdmin || role === 'Organisation';
                const isRadioManager = role === 'Responsable Radio';
                const isMaire = role === 'MAIRE';
                const isRestrictedUser = (currentUser.nom === 'FIEVET' && currentUser.prenom === 'Alexis') ||
                                         (currentUser.nom === 'HAUTOT' && currentUser.prenom === 'CHRISTOPHE') ||
                                         (currentUser.nom === 'LE BRAS' && currentUser.prenom === 'FRANK');

                if (!canEditBenevoles && !isRadioManager) {
                    document.getElementById('add-benevole-btn').style.display = 'none';
                    document.getElementById('save-btn').style.display = 'none';
                    document.getElementById('missing-info-container').style.display = 'none';
                }
                 if(isRadioManager || isMaire){
                    document.getElementById('add-benevole-btn').style.display = 'none';
                    document.getElementById('missing-info-container').style.display = 'none';
                    document.getElementById('toggleTel').parentElement.style.display = 'none';
                 }
                  if(isMaire) {
                    document.getElementById('save-btn').style.display = 'none';
                  }


                if (!canEditConcurrents) {
                    addConcurrentBtn.style.display = 'none';
                    saveConcurrentsBtn.style.display = 'none';
                }
                
                if (!isSuperAdmin) {
                    resetRaceBtn.style.display = 'none';
                }

                if (!canImportExport) {
                    importBtn.style.display = 'none';
                    exportBtn.style.display = 'none';
                }

                const canStartHeat = isSuperAdmin || role === 'Organisation' || role === 'Chrono Départ';
                if (!canStartHeat) {
                    document.getElementById('new-heat-btn').style.display = 'none';
                }

                if (!canSeeChronoAndPodium || isRestrictedUser) {
                    document.getElementById('chrono-container').style.display = 'none';
                    podiumFastestLapBtn.style.display = 'none';
                    podiumGrandPrixBtn.style.display = 'none';
                    previousHeatBtn.style.display = 'none';
                    newHeatBtn.style.display = 'none';
                    resetRaceBtn.style.display = 'none';
                }
                
                if (!(isSuperAdmin || currentUser.role === 'Organisation')) {
                    toggleTelCheckbox.parentElement.style.display = 'none';
                }

            }
            
            // Tabs switching logic
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(item => item.classList.remove('active'));
                    tab.classList.add('active');
                    const targetId = tab.id.replace('tab-', 'content-');
                    contents.forEach(content => {
                        content.style.display = content.id === targetId ? 'block' : 'none';
                    });
                });
            });

            // Admin Sub-tabs Logic
            const showAccessBtn = document.getElementById('show-access-btn');
            const showResetBtn = document.getElementById('show-reset-btn');
            const adminAccessSection = document.getElementById('admin-access-section');
            const adminResetSection = document.getElementById('admin-reset-section');

            if(showAccessBtn) {
                showAccessBtn.addEventListener('click', () => {
                    showAccessBtn.classList.add('active');
                    showResetBtn.classList.remove('active');
                    adminAccessSection.style.display = 'block';
                    adminResetSection.style.display = 'none';
                });
            }
            if(showResetBtn) {
                showResetBtn.addEventListener('click', () => {
                    showResetBtn.classList.add('active');
                    showAccessBtn.classList.remove('active');
                    adminResetSection.style.display = 'block';
                    adminAccessSection.style.display = 'none';
                });
            }


            // Credits Modal Logic
            document.querySelectorAll('.credits-btn-trigger').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('credits-modal').style.display = 'flex';
                });
            });
            document.getElementById('close-credits-modal-btn').addEventListener('click', () => {
                document.getElementById('credits-modal').style.display = 'none';
            });


            // Import / Export Logic
            exportBtn.addEventListener('click', async () => {
                const benevolesSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/benevoles`));
                const concurrentsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/concurrents`));
                const usersSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/users`));

                const dataToExport = {
                    benevoles: benevolesSnapshot.docs.map(doc => doc.data()),
                    concurrents: concurrentsSnapshot.docs.map(doc => doc.data()),
                    utilisateurs: usersSnapshot.docs.map(doc => doc.data())
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const date = new Date();
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                link.download = `sauvegarde-caisse-a-savon-${dateStr}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });

            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (imported.benevoles && imported.concurrents && imported.utilisateurs) {
                            showConfirmationModal("Voulez-vous vraiment remplacer toutes les données actuelles par celles du fichier importé ?<br><br><strong>Cette action est irréversible.</strong>", async () => {
                                // Protection du Super Admin
                                let superAdminInImport = imported.utilisateurs.find(u => u.nom === "POURCEL" && u.prenom === "Romain" && u.tel === "0613255651");
                                if (superAdminInImport) {
                                    superAdminInImport.role = 'Super Admin';
                                } else {
                                    imported.utilisateurs.push({ nom: "POURCEL", prenom: "Romain", tel: "0613255651", role: "Super Admin" });
                                }
                                
                                const collectionsToDelete = ['benevoles', 'concurrents', 'users'];
                                for (const coll of collectionsToDelete) {
                                    const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/${coll}`));
                                    const deleteBatch = writeBatch(db);
                                    snapshot.docs.forEach(doc => deleteBatch.delete(doc.ref));
                                    await deleteBatch.commit();
                                }

                                const importBatch = writeBatch(db);
                                imported.benevoles.forEach(item => {
                                    const docRef = doc(collection(db, `artifacts/${appId}/public/data/benevoles`));
                                    importBatch.set(docRef, item);
                                });
                                imported.concurrents.forEach(item => {
                                    const docRef = doc(collection(db, `artifacts/${appId}/public/data/concurrents`));
                                    importBatch.set(docRef, item);
                                });
                                imported.utilisateurs.forEach(item => {
                                    const docRef = doc(collection(db, `artifacts/${appId}/public/data/users`));
                                    importBatch.set(docRef, item);
                                });
                                await importBatch.commit();
                                
                                alert("Données importées avec succès ! La page va se recharger.");
                                location.reload();
                            });
                        } else {
                            showConfirmationModal("Fichier invalide ou mal formaté.", () => {}, "Erreur d'importation");
                        }
                    } catch (error) {
                        showConfirmationModal("Erreur lors de la lecture du fichier.", () => {}, "Erreur d'importation");
                        console.error("Erreur d'importation:", error);
                    }
                    importFile.value = '';
                };
                reader.readAsText(file);
            });

            // Initial Load Listeners
            onSnapshot(collection(db, `artifacts/${appId}/public/data/benevoles`), (snapshot) => {
                data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBenevolesTable();
            });
             onSnapshot(collection(db, `artifacts/${appId}/public/data/concurrents`), (snapshot) => {
                concurrents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllConcurrentsView();
                populateConcurrentsDatalist();
                 populateCompetitorsForAccessForm();
            });
            
            onSnapshot(chronoDocRef, (snapshot) => {
                const chronoData = snapshot.data();
                clearInterval(chronoInterval);

                if (!chronoData) {
                    setDoc(chronoDocRef, { 
                        running: false, 
                        startTime: null, 
                        currentConcurrent: null, 
                        selectedConcurrent: null, 
                        currentManche: 1,
                        lastRecordedTime: null
                    });
                    return;
                }

                currentManche = chronoData.currentManche || 1;
                renderRaceTable();
                updateChronoButtons(chronoData);
                
                clearTimeout(modalTimeout);
                if (chronoData.lastRecordedTime) {
                    const recordedData = chronoData.lastRecordedTime;
                    const rankDisplay = document.getElementById('time-confirm-rank');
                    const ecartPremierDisplay = document.getElementById('time-confirm-ecart-premier');
                    const ecartPrecedentDisplay = document.getElementById('time-confirm-ecart-precedent');
                    const newRecordBanner = document.getElementById('new-record-banner');
                    
                    document.getElementById('time-confirm-concurrent').textContent = recordedData.nom;
                    document.getElementById('time-confirm-time').textContent = formatTime(recordedData.time);
                    
                    // Rank
                    if (recordedData.rank) {
                        let suffix = recordedData.rank === 1 ? 'er' : 'ème';
                        rankDisplay.textContent = `Classement : ${recordedData.rank}${suffix}`;
                    } else {
                        rankDisplay.textContent = "Pas encore classé";
                    }

                    // Ecart Premier
                    if (recordedData.rank > 1 && recordedData.ecartPremier) {
                        ecartPremierDisplay.textContent = `À ${formatEcart(recordedData.ecartPremier)} du 1er`;
                        ecartPremierDisplay.style.display = 'block';
                    } else {
                        ecartPremierDisplay.style.display = 'none';
                    }

                    // Ecart Precedent
                    if (recordedData.rank > 1 && recordedData.ecartPrecedent && recordedData.nomPrecedent) {
                        ecartPrecedentDisplay.textContent = `À ${formatEcart(recordedData.ecartPrecedent)} de ${recordedData.nomPrecedent}`;
                        ecartPrecedentDisplay.style.display = 'block';
                    } else if (recordedData.rank === 1) {
                        ecartPrecedentDisplay.textContent = "Vous êtes le 1er !";
                        ecartPrecedentDisplay.style.display = 'block';
                    } else {
                        ecartPrecedentDisplay.style.display = 'none';
                    }

                    // New record
                    if (recordedData.isNewBestRunEver) {
                        newRecordBanner.style.display = 'block';
                    } else {
                        newRecordBanner.style.display = 'none';
                    }

                    timeConfirmationModal.style.display = 'flex';
                    
                    modalTimeout = setTimeout(() => {
                        clearDbLastRecordedTime();
                    }, 10000);
                } else {
                    timeConfirmationModal.style.display = 'none';
                }

                if (chronoData.running && chronoData.startTime && chronoData.currentConcurrent) {
                    const startTime = chronoData.startTime;
                    chronoInterval = setInterval(() => updateChronoDisplay(startTime), 10);
                    
                    const runningConcurrent = concurrents.find(c => c.id == chronoData.currentConcurrent);
                    if (runningConcurrent) {
                        selectedConcurrentDisplay.textContent = `Course : ${runningConcurrent.nom}`;
                    }
                    
                    chronoSearchInput.value = '';
                    chronoSearchInput.disabled = true;
                } else {
                    chronoDisplay.textContent = "00:00:00";
                    chronoSearchInput.disabled = false;

                    if (chronoData.selectedConcurrent) {
                        const selected = concurrents.find(c => c.id == chronoData.selectedConcurrent);
                        if (selected) {
                            selectedConcurrentDisplay.textContent = `Au départ : ${selected.nom}`;
                            if(document.activeElement !== chronoSearchInput) {
                                 chronoSearchInput.value = selected.nom;
                            }
                        }
                    } else {
                        selectedConcurrentDisplay.textContent = '';
                         if(document.activeElement !== chronoSearchInput) {
                            chronoSearchInput.value = '';
                         }
                    }
                }
            });


            if (isSuperAdmin) {
                onSnapshot(collection(db, `artifacts/${appId}/public/data/users`), (snapshot) => {
                    utilisateursAutorises = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAccessTable();
                });
            }
            setupPermissions();
        }
        document.addEventListener('DOMContentLoaded', authenticateAndStart);

        // ===================================
        // NOUVELLE LOGIQUE POUR LA VUE CONCURRENT
        // ===================================
        function startCompetitorLogic(competitorId) {
            const concurrentsCollection = collection(db, `artifacts/${appId}/public/data/concurrents`);
            const chronoDocRef = doc(db, `artifacts/${appId}/public/data/raceState`, 'chrono');

            let lastRenderedState = '';

            onSnapshot(concurrentsCollection, (concurrentsSnapshot) => {
                 onSnapshot(chronoDocRef, (chronoSnapshot) => {
                    const allConcurrents = concurrentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const chronoData = chronoSnapshot.exists() ? chronoSnapshot.data() : { currentManche: 1 };
                    
                    const currentState = JSON.stringify(allConcurrents) + JSON.stringify(chronoData);
                    if (currentState !== lastRenderedState) {
                         renderCompetitorDashboard(allConcurrents, chronoData, competitorId);
                         lastRenderedState = currentState;
                    }
                });
            });
        }
        
        function renderCompetitorDashboard(allConcurrents, chronoData, currentCompetitorId) {
            const me = allConcurrents.find(c => c.id === currentCompetitorId);
            if (!me) {
                document.getElementById('competitor-dashboard-name').textContent = "Concurrent non trouvé";
                return;
            }
            
            // Calcul des temps et classements
            allConcurrents.forEach(c => {
                const officialRuns = c.manches.slice(2).filter(t => t !== null && t !== undefined);
                c.meilleurTemps = officialRuns.length > 0 ? Math.min(...officialRuns) : null;
            });
            const rankedConcurrents = allConcurrents.filter(c => c.meilleurTemps !== null).sort((a, b) => a.meilleurTemps - b.meilleurTemps);
            const myRankIndex = rankedConcurrents.findIndex(c => c.id === currentCompetitorId);
            const myRank = myRankIndex !== -1 ? myRankIndex + 1 : null;
            const leader = rankedConcurrents.length > 0 ? rankedConcurrents[0] : null;

            // Mise à jour des cartes principales
            document.getElementById('competitor-dashboard-name').textContent = me.nom;
            document.getElementById('competitor-dashboard-best-time').textContent = formatTime(me.meilleurTemps) || '-';
            document.getElementById('competitor-dashboard-rank').textContent = myRank || '-';

            if (myRank && leader && me.meilleurTemps && myRank > 1) {
                const gap = me.meilleurTemps - leader.meilleurTemps;
                document.getElementById('competitor-dashboard-gap').textContent = formatEcart(gap);
            } else if (myRank === 1) {
                 document.getElementById('competitor-dashboard-gap').textContent = '1er';
            } else {
                document.getElementById('competitor-dashboard-gap').textContent = '-';
            }

            // Mise à jour du classement ciblé
            const focusedRankingBody = document.getElementById('competitor-dashboard-focused-ranking');
            focusedRankingBody.innerHTML = '';
            
            const competitorAbove = myRankIndex > 0 ? rankedConcurrents[myRankIndex - 1] : null;
            const competitorBelow = myRankIndex < rankedConcurrents.length - 1 ? rankedConcurrents[myRankIndex + 1] : null;

            const renderRankingRow = (competitor, rank, highlightClass = '') => {
                if (!competitor) return '';
                let rankDisplay = rank;
                if (rank === 1) rankDisplay = `🥇 ${rank}`;
                else if (rank === 2) rankDisplay = `🥈 ${rank}`;
                else if (rank === 3) rankDisplay = `🥉 ${rank}`;
                return `<tr class="${highlightClass}">
                            <td class="p-3 font-bold">${rankDisplay}</td>
                            <td class="p-3">${competitor.nom}</td>
                            <td class="p-3 font-mono font-semibold">${formatTime(competitor.meilleurTemps)}</td>
                        </tr>`;
            };

            if (myRank) {
                if (competitorAbove) {
                    focusedRankingBody.innerHTML += renderRankingRow(competitorAbove, myRank - 1, 'bg-gray-50');
                }
                focusedRankingBody.innerHTML += renderRankingRow(me, myRank, 'bg-blue-100 text-blue-800 font-bold');
                if (competitorBelow) {
                    focusedRankingBody.innerHTML += renderRankingRow(competitorBelow, myRank + 1, 'bg-gray-50');
                }
            } else {
                 focusedRankingBody.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-gray-500">Vous n\'avez pas encore de temps de course officiel.</td></tr>';
            }

            // Mise à jour du tableau des temps par manche
            const timesTableHead = document.getElementById('competitor-dashboard-times-head');
            const timesTableBody = document.getElementById('competitor-dashboard-times-body');
            
            const mancheHeaders = Array.from({ length: chronoData.currentManche }, (_, i) => i < 2 ? `Test ${i + 1}` : `Course ${i - 1}`);
            timesTableHead.innerHTML = mancheHeaders.map(h => `<th class="p-3 text-left text-xs font-bold uppercase">${h}</th>`).join('');
            
            const timesRow = document.createElement('tr');
            timesRow.innerHTML = me.manches.slice(0, chronoData.currentManche).map(time => `<td class="p-3 font-mono">${formatTime(time) || '-'}</td>`).join('');
            timesTableBody.innerHTML = '';
            timesTableBody.appendChild(timesRow);
        }

        function showTutorialModalIfNeeded() {
            if (!localStorage.getItem('tutorialShown')) {
                document.getElementById('tutorial-modal').style.display = 'flex';
            }
        }

        document.getElementById('close-tutorial-btn').addEventListener('click', () => {
            document.getElementById('tutorial-modal').style.display = 'none';
            localStorage.setItem('tutorialShown', 'true');
        });

        document.getElementById('show-tutorial-btn').addEventListener('click', () => {
            displayTutorialForRole(isSuperAdmin ? 'Super Admin' : currentUser.role);
            document.getElementById('tutorial-modal').style.display = 'none';
            localStorage.setItem('tutorialShown', 'true');
        });

        function displayTutorialForRole(role) {
            let tutorialContent = '';
            let tutorialTitle = 'Guide Rapide';

             const commonStyles = `
                body { font-family: sans-serif; line-height: 1.6; padding: 20px; color: #333; }
                h1, h2, h3 { color: #1e40af; }
                h2 { border-bottom: 2px solid #3b82f6; padding-bottom: 5px; margin-top: 25px; }
                h3 { border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 20px; }
                p, li { font-size: 15px; }
                strong { color: #1f2937; }
                ul { padding-left: 20px; list-style-type: '✔️ '; }
                img { border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; max-width: 100%; height: auto; }
                .note { background-color: #fef9c3; border-left: 4px solid #facc15; padding: 10px; margin: 15px 0; border-radius: 4px;}
            `;

            switch (role) {
                case 'Super Admin':
                case 'Organisation':
                    tutorialTitle = "Guide Complet pour l'Organisation";
                    tutorialContent = `
                        <p>Bienvenue ! En tant qu'organisateur, vous avez accès à toutes les fonctionnalités clés pour gérer l'événement.</p>
                        
                        <h2>🏎️ Onglet Chrono</h2>
                        <p>C'est le centre de contrôle de la course.</p>
                        <img src="https://i.imgur.com/gA8F2oI.png" alt="Vue de l'onglet Chrono">
                        <ul>
                            <li><strong>Lancer une course :</strong> Recherchez un concurrent par nom ou numéro, sélectionnez-le dans la liste, puis cliquez sur "Démarrer".</li>
                            <li><strong>Arrêter une course :</strong> Dès que le concurrent passe la ligne d'arrivée, cliquez sur "Arrêter et Enregistrer". Le temps sera sauvegardé.</li>
                            <li><strong>Manche suivante :</strong> Une fois tous les concurrents passés, cliquez sur "Manche Suivante" pour faire avancer la course.</li>
                            <li><strong>Correction manuelle :</strong> En cas d'erreur, vous pouvez cliquer directement sur un temps dans le tableau pour le modifier.</li>
                        </ul>

                        <h2>🙋 Onglet Concurrents</h2>
                        <p>Gérez la liste de tous les participants.</p>
                        <img src="https://i.imgur.com/s4a2r7p.png" alt="Tableau des concurrents">
                        <ul>
                            <li><strong>Ajouter :</strong> Utilisez le bouton "+ Ajouter un Concurrent".</li>
                            <li><strong>Modifier/Supprimer :</strong> Utilisez les boutons d'action sur chaque ligne.</li>
                            <li><strong>Suivi des dossiers :</strong> Cochez les cases pour suivre les documents (inscription, assurance, paiement) et le contrôle technique.</li>
                        </ul>

                        <h2>🤝 Onglet Bénévoles & Matériel</h2>
                        <p>Gérez vos équipes et le matériel qui leur est confié.</p>
                        <img src="https://i.imgur.com/G5g2f0b.png" alt="Tableau des bénévoles">
                        <ul>
                            <li><strong>Ajouter/Modifier :</strong> Comme pour les concurrents, utilisez les boutons pour gérer la liste.</li>
                            <li><strong>Affectations :</strong> Attribuez un lieu et une fonction à chaque bénévole via les menus déroulants.</li>
                            <li><strong>Suivi du matériel :</strong> Cochez les cases "D" (Distribué) et "R" (Restitué) pour les radios et sifflets. Le résumé en haut se met à jour automatiquement.</li>
                        </ul>
                        
                        ${isSuperAdmin ? `
                        <h2>⚙️ Onglet Administration</h2>
                        <p class="note"><strong>Attention :</strong> Cet onglet est réservé aux Super Administrateurs. Les actions ici sont puissantes.</p>
                        <img src="https://i.imgur.com/8Qp2f8j.png" alt="Zone d'Administration">
                        <ul>
                            <li><strong>Gestion des Accès :</strong> Créez, modifiez ou supprimez les comptes utilisateurs qui peuvent se connecter à l'application.</li>
                            <li><strong>Réinitialisation :</strong> Effacez de manière permanente les données (bénévoles, concurrents, accès). <strong>Votre propre accès est toujours conservé.</strong></li>
                        </ul>
                        ` : ''}
                    `;
                    break;
                case 'Responsable Radio':
                    tutorialTitle = "Guide pour le Responsable Radio";
                    tutorialContent = `
                        <h2>Votre Mission : Suivre le Matériel</h2>
                        <p>Votre rôle est de vous assurer que tout le matériel (radios, sifflets) est bien distribué en début de journée et restitué à la fin.</p>
                        <img src="https://i.imgur.com/G5g2f0b.png" alt="Tableau Bénévoles avec focus Matériel">
                        <ul>
                            <li><strong>Distribution :</strong> Lorsqu'un bénévole prend son matériel, cochez la case "D" (Distribué) correspondante sur sa ligne.</li>
                            <li><strong>Récupération :</strong> Lorsqu'il le rend, cochez la case "R" (Restitué).</li>
                        </ul>
                        <p>Le résumé en haut de la page vous indique en temps réel combien d'appareils sont encore en circulation. Les autres colonnes sont en lecture seule pour vous.</p>
                    `;
                    break;
                case 'Chrono Départ':
                case 'Chrono Arrivée':
                    tutorialTitle = "Guide pour l'Équipe Chrono";
                    tutorialContent = `
                        <p>Votre rôle est crucial ! Votre concentration se portera sur l'onglet <strong>Chrono</strong>.</p>
                        <img src="https://i.imgur.com/gA8F2oI.png" alt="Vue détaillée du Chronomètre">
                        
                        <h3>Pour le Départ 🏁</h3>
                        <ul>
                            <li><strong>1. Recherchez le concurrent :</strong> Tapez son numéro ou son nom dans la barre de recherche.</li>
                            <li><strong>2. Sélectionnez-le :</strong> Cliquez sur son nom dans la liste qui apparaît. Son nom s'affiche en dessous pour confirmer.</li>
                            <li><strong>3. LANCEZ !</strong> Au moment exact où la caisse à savon s'élance, cliquez sur le bouton vert "Démarrer".</li>
                        </ul>

                        <h3>Pour l'Arrivée ✅</h3>
                        <ul>
                            <li><strong>1. Suivez le temps :</strong> Le chronomètre pour le concurrent en piste défile en temps réel sur votre écran.</li>
                            <li><strong>2. ARRETEZ !</strong> Dès que la caisse franchit la ligne, cliquez sur le bouton rouge "Arrêter et Enregistrer".</li>
                            <li><strong>3. Confirmez :</strong> Une fenêtre s'ouvrira avec le temps final. C'est votre confirmation que tout est bien enregistré.</li>
                        </ul>
                        <p class="note">En cas d'erreur, un organisateur peut corriger un temps manuellement en cliquant dessus dans le tableau.</p>
                    `;
                    break;
                default: // Bénévole & Concurrent & MAIRE
                    tutorialTitle = "Guide de Consultation";
                    tutorialContent = `
                        <p>Bienvenue ! Vous avez un accès en consultation pour suivre l'événement en direct.</p>
                        
                        <h2>Suivre la Course 🏎️</h2>
                        <p>L'onglet <strong>Chrono</strong> est votre principal point d'intérêt. Vous y verrez :</p>
                        <img src="https://i.imgur.com/gA8F2oI.png" alt="Tableau de classement">
                        <ul>
                            <li>Le chronomètre en direct pour le concurrent actuellement sur la piste.</li>
                            <li>Le classement général qui se met à jour automatiquement après chaque descente.</li>
                            <li>Les temps de toutes les manches pour chaque participant.</li>
                        </ul>

                        <h2>Voir les Bénévoles 🤝</h2>
                        <p>Dans l'onglet <strong>Bénévoles & Matériel</strong>, vous pouvez consulter la liste des volontaires et leurs affectations.</p>
                    `;
                    break;
            }

            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head>
                        <title>${tutorialTitle}</title>
                        <style>${commonStyles}</style>
                    </head>
                    <body>
                        <h1>${tutorialTitle}</h1>
                        ${tutorialContent}
                    </body>
                </html>
            `);
            newWindow.document.close();
        }

    </script>
</body>
</html>

